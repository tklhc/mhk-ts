<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mƒ∞HENK √úretim Takip Sistemi</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #1e293b; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  select option { background: #1e293b; color: #e2e8f0; }
  input[type="number"]::-webkit-inner-spin-button { opacity: 0.5; }
  @media print { body { background: white; color: black; } }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// Simple SVG icon components
function _mkIcon(children) {
  return function IconComponent(props) {
    var p = props || {};
    var size = p.size || 24;
    var color = p.color || "currentColor";
    var style = p.style || {};
    return React.createElement("svg", {
      width: size, height: size, viewBox: "0 0 24 24", fill: "none",
      stroke: color, strokeWidth: 2, strokeLinecap: "round", strokeLinejoin: "round",
      style: style, className: p.className || ""
    }, children);
  };
}
function _p(d,k) { return React.createElement("path", {d: d, key: k}); }
function _c(cx,cy,r,k) { return React.createElement("circle", {cx:cx,cy:cy,r:r, key: k}); }
function _r(x,y,w,h,rx,k) { return React.createElement("rect", {x:x,y:y,width:w,height:h,rx:rx||0,ry:rx||0, key: k}); }
function _l(x1,y1,x2,y2,k) { return React.createElement("line", {x1:x1,y1:y1,x2:x2,y2:y2, key: k}); }
function _pg(pts,k) { return React.createElement("polygon", {points:pts, key: k}); }

var Package = _mkIcon([_p("M16.5 9.4 7.55 4.24","a"),_p("M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z","b"),_p("M3.27 6.96 12 12.01l8.73-5.05","c"),_p("M12 22.08V12","d")]);
var ClipboardList = _mkIcon([_r(8,2,8,4,1,"a"),_p("M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2","b"),_p("M12 11h4","c"),_p("M12 16h4","d"),_p("M8 11h.01","e"),_p("M8 16h.01","f")]);
var Scissors = _mkIcon([_c(6,6,3,"a"),_c(6,18,3,"b"),_p("M20 4 8.12 15.88","c"),_p("M14.47 14.48 20 20","d"),_p("M8.12 8.12 12 12","e")]);
var Factory = _mkIcon([_p("M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z","a"),_p("M17 18h1","b"),_p("M12 18h1","c"),_p("M7 18h1","d")]);
var CheckCircle2 = _mkIcon([_c(12,12,10,"a"),_p("M9 12l2 2 4-4","b")]);
var Zap = _mkIcon([_pg("13 2 3 14 12 14 11 22 21 10 12 10 13 2","a")]);
var Layers = _mkIcon([_p("M12 2 2 7l10 5 10-5-10-5Z","a"),_p("M2 17l10 5 10-5","b"),_p("M2 12l10 5 10-5","c")]);
var Truck = _mkIcon([_p("M1 3h15v13H1z","a"),_p("M16 8h4l3 3v5h-7V8z","b"),_c(5.5,18.5,2.5,"c"),_c(18.5,18.5,2.5,"d")]);
var Plus = _mkIcon([_p("M12 5v14","a"),_p("M5 12h14","b")]);
var Search = _mkIcon([_c(11,11,8,"a"),_p("M21 21l-4.35-4.35","b")]);
var ChevronRight = _mkIcon([_p("M9 18l6-6-6-6","a")]);
var ChevronDown = _mkIcon([_p("M6 9l6 6 6-6","a")]);
var ChevronLeft = _mkIcon([_p("M15 18l-6-6 6-6","a")]);
var Clock = _mkIcon([_c(12,12,10,"a"),_p("M12 6v6l4 2","b")]);
var AlertTriangle = _mkIcon([_p("M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z","a"),_p("M12 9v4","b"),_p("M12 17h.01","c")]);
var BarChart3 = _mkIcon([_p("M18 20V10","a"),_p("M12 20V4","b"),_p("M6 20v-6","c")]);
var Calendar = _mkIcon([_r(3,4,18,18,2,"a"),_p("M16 2v4","b"),_p("M8 2v4","c"),_p("M3 10h18","d")]);
var Users = _mkIcon([_p("M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2","a"),_c(9,7,4,"b"),_p("M23 21v-2a4 4 0 0 0-3-3.87","c"),_c(16,3.13,4,"d")]);
var Settings = _mkIcon([_c(12,12,3,"a"),_p("M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z","b")]);
var Eye = _mkIcon([_p("M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z","a"),_c(12,12,3,"b")]);
var EyeOff = _mkIcon([_p("M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94","a"),_p("M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19","b"),_p("M1 1l22 22","c"),_p("M14.12 14.12a3 3 0 1 1-4.24-4.24","d")]);
var Play = _mkIcon([_pg("5 3 19 12 5 21 5 3","a")]);
var Square = _mkIcon([_r(3,3,18,18,2,"a")]);
var Check = _mkIcon([_p("M20 6L9 17l-5-5","a")]);
var X = _mkIcon([_p("M18 6L6 18","a"),_p("M6 6l12 12","b")]);
var Printer = _mkIcon([_p("M6 9V2h12v7","a"),_p("M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2","b"),_p("M6 14h12v8H6z","c")]);
var FileText = _mkIcon([_p("M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z","a"),_p("M14 2v6h6","b"),_p("M16 13H8","c"),_p("M16 17H8","d"),_p("M10 9H8","e")]);
var ArrowRight = _mkIcon([_p("M5 12h14","a"),_p("M12 5l7 7-7 7","b")]);
var Filter = _mkIcon([_pg("22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3","a")]);
var RefreshCw = _mkIcon([_p("M23 4v6h-6","a"),_p("M1 20v-6h6","b"),_p("M3.51 9a9 9 0 0 1 14.85-3.36L23 10","c"),_p("M1 14l4.64 4.36A9 9 0 0 0 20.49 15","d")]);
var Monitor = _mkIcon([_r(2,3,20,14,2,"a"),_p("M8 21h8","b"),_p("M12 17v4","c")]);
var User = _mkIcon([_p("M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2","a"),_c(12,7,4,"b")]);
var Box = _mkIcon([_p("M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z","a"),_p("M3.27 6.96 12 12.01l8.73-5.05","b"),_p("M12 22.08V12","c")]);
var Tag = _mkIcon([_p("M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z","a"),_l(7,7,7.01,7,"b")]);
var CircleDot = _mkIcon([_c(12,12,10,"a"),_c(12,12,1,"b")]);
var Hash = _mkIcon([_p("M4 9h16","a"),_p("M4 15h16","b"),_p("M10 3L8 21","c"),_p("M16 3l-2 18","d")]);
var Gauge = _mkIcon([_p("M12 15.5A3.5 3.5 0 1 0 8.5 12 3.5 3.5 0 0 0 12 15.5Z","a"),_p("M19.14 9.15a8 8 0 1 0 1.56 5.35","b")]);
var TrendingUp = _mkIcon([_p("M23 6l-9.5 9.5-5-5L1 18","a"),_p("M17 6h6v6","b")]);
var Edit = _mkIcon([_p("M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7","a"),_p("M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z","b")]);
var Trash2 = _mkIcon([_p("M3 6h18","a"),_p("M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2","b"),_p("M10 11v6","c"),_p("M14 11v6","d")]);
var Save = _mkIcon([_p("M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z","a"),_p("M17 21v-8H7v8","b"),_p("M7 3v5h8","c")]);
var ArrowDown = _mkIcon([_p("M12 5v14","a"),_p("M19 12l-7 7-7-7","b")]);
var ArrowUp = _mkIcon([_p("M12 19V5","a"),_p("M5 12l7-7 7 7","b")]);
var Home = _mkIcon([_p("M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z","a"),_p("M9 22V12h6v10","b")]);
var Wrench = _mkIcon([_p("M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z","a")]);
var Lock = _mkIcon([_r(3,11,18,11,2,"a"),_p("M7 11V7a5 5 0 0 1 10 0v4","b")]);
var Unlock = _mkIcon([_r(3,11,18,11,2,"a"),_p("M7 11V7a5 5 0 0 1 9.9-1","b")]);
var Shield = _mkIcon([_p("M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z","a")]);
var Upload = _mkIcon([_p("M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4","a"),_p("M17 8l-5-5-5 5","b"),_p("M12 3v12","c")]);
var File = _mkIcon([_p("M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z","a"),_p("M13 2v7h7","b")]);
var Download = _mkIcon([_p("M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4","a"),_p("M7 10l5 5 5-5","b"),_p("M12 15V3","c")]);
var LogOut = _mkIcon([_p("M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4","a"),_p("M16 17l5-5-5-5","b"),_p("M21 12H9","c")]);
var UserCog = _mkIcon([_p("M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2","a"),_c(8.5,7,4,"b"),_c(19,14,2,"c"),_p("M19 8v1","d"),_p("M19 19v1","e"),_p("M22.9 14H22","f"),_p("M16.1 14H15","g")]);
var ShoppingCart = _mkIcon([_c(9,21,1,"a"),_c(20,21,1,"b"),_p("M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6","c")]);


// 
// RBAC ‚Äî ROLES & PERMISSIONS
// 
const PERMISSIONS = {
  orders_view: "Sipari≈üleri G√∂r√ºnt√ºle",
  orders_edit: "Sipari≈ü Olu≈ütur/D√ºzenle",
  orders_price: "Fiyat Bilgisi G√∂r√ºnt√ºle",
  workorders_view: "ƒ∞≈ü Emirlerini G√∂r√ºnt√ºle",
  workorders_edit: "ƒ∞≈ü Emri D√ºzenle",
  cutting_view: "Kesimi G√∂r√ºnt√ºle",
  cutting_edit: "Kesim ƒ∞≈ülemleri",
  grinding_view: "Ta≈ülamayƒ± G√∂r√ºnt√ºle",
  grinding_edit: "Ta≈ülama ƒ∞≈ülemleri",
  planning_view: "Planlamayƒ± G√∂r√ºnt√ºle",
  planning_edit: "Planlama D√ºzenle",
  production_view: "√úretimi G√∂r√ºnt√ºle",
  production_edit: "√úretim Ba≈ülat/Bitir",
  qc_view: "Kalite Kontrol√º G√∂r√ºnt√ºle",
  qc_edit: "KK Onayƒ± Ver",
  coating_view: "Kaplamayƒ± G√∂r√ºnt√ºle",
  coating_edit: "Kaplama ƒ∞≈ülemleri",
  shipping_view: "Sevkiyatƒ± G√∂r√ºnt√ºle",
  shipping_edit: "Sevkiyat ƒ∞≈ülemleri",
  stock_view: "Stok G√∂r√ºnt√ºle",
  stock_edit: "Stok D√ºzenle",
  purchasing_view: "Satƒ±n Almayƒ± G√∂r√ºnt√ºle",
  purchasing_edit: "Satƒ±n Alma ƒ∞≈ülemleri",
  machines_view: "Makinalarƒ± G√∂r√ºnt√ºle",
  operators_view: "Operat√∂rleri G√∂r√ºnt√ºle",
  admin: "Y√∂netici (T√ºm Yetkiler)",
};

const DEFAULT_ROLES = {
  admin: { label: "Y√∂netici", permissions: Object.keys(PERMISSIONS) },
  manager: { label: "√úretim M√ºd√ºr√º", permissions: [
    "orders_view","orders_edit","orders_price","workorders_view","workorders_edit",
    "cutting_view","cutting_edit","grinding_view","grinding_edit","planning_view","planning_edit","production_view","production_edit",
    "qc_view","qc_edit","coating_view","coating_edit","shipping_view","shipping_edit",
    "stock_view","stock_edit","purchasing_view","purchasing_edit","machines_view","operators_view"
  ]},
  planner: { label: "Planlama Sorumlusu", permissions: [
    "orders_view","workorders_view","workorders_edit","cutting_view","grinding_view",
    "planning_view","planning_edit","production_view","purchasing_view","machines_view","operators_view"
  ]},
  operator: { label: "Operat√∂r", permissions: [
    "orders_view","workorders_view","cutting_view","cutting_edit","grinding_view","grinding_edit",
    "production_view","production_edit","qc_view","qc_edit","stock_view","purchasing_view","machines_view"
  ]},
  viewer: { label: "ƒ∞zleyici", permissions: [
    "orders_view","workorders_view","cutting_view","grinding_view","planning_view","production_view","qc_view",
    "coating_view","shipping_view","stock_view","purchasing_view","machines_view","operators_view"
  ]},
};

const USERS_SEED = [
  { id: "U1", name: "Taha", username: "taha", password: "1234", role: "admin", avatar: "T" },
  { id: "U2", name: "Ahmet Yƒ±lmaz", username: "ahmet", password: "1234", role: "operator", avatar: "A" },
  { id: "U3", name: "Mehmet Kaya", username: "mehmet", password: "1234", role: "operator", avatar: "M" },
  { id: "U4", name: "Fatma Demir", username: "fatma", password: "1234", role: "manager", avatar: "F" },
  { id: "U5", name: "Zeynep Acar", username: "zeynep", password: "1234", role: "planner", avatar: "Z" },
  { id: "U6", name: "Emre ≈ûahin", username: "emre", password: "1234", role: "viewer", avatar: "E" },
];

// 
// DATA
// 
const MACHINES_SEED = [
  { id: "M1", name: "S20-1", type: "CNC", status: "active" },
  { id: "M2", name: "S20-2", type: "CNC", status: "active" },
  { id: "M3", name: "S20-3", type: "CNC", status: "active" },
  { id: "M4", name: "Studer Ta≈ülama", type: "Ta≈ülama", status: "active" },
  { id: "M5", name: "Lazer Markalama", type: "Lazer", status: "active" },
  { id: "M6", name: "Kesim Tezgahƒ±", type: "Kesim", status: "active" },
  { id: "M8", name: "S22-1", type: "CNC", status: "active" },
  { id: "M9", name: "S22-2", type: "CNC", status: "active" },
  { id: "M10", name: "Saacke", type: "CNC", status: "active" },
];
const OPERATORS_SEED = [
  { id: "O1", name: "Ahmet Yƒ±lmaz", role: "CNC Operat√∂r", shift: "G√ºnd√ºz" },
  { id: "O2", name: "Mehmet Kaya", role: "CNC Operat√∂r", shift: "G√ºnd√ºz" },
  { id: "O3", name: "Ali Demir", role: "CNC Operat√∂r", shift: "Gece" },
  { id: "O4", name: "Hasan √áelik", role: "Ta≈ülamacƒ±", shift: "G√ºnd√ºz" },
  { id: "O5", name: "Veli Acar", role: "Kesimci", shift: "G√ºnd√ºz" },
  { id: "O6", name: "Emre ≈ûahin", role: "Lazer Operat√∂r", shift: "G√ºnd√ºz" },
];
const MIHENG_INFO = {
  name: "Mihenk Kesici Takƒ±mlar San. Tic. Ltd. ≈ûti.",
  address: "Fevzi √áakmak Mh. 10662.Sk No:17/A Karatay/Konya",
};
const KARES_INFO = {
  name: "Kares Kesici Takƒ±mlar",
  address: "75.yƒ±l Sultandere Mh. 11279.SK No:12/2 Yunus Emre Kobi Odunpazarƒ±/ESKƒ∞≈ûEHƒ∞R",
};
const COATING_COMPANIES_PRODUCTION = [
  { id: "CK1", name: "Akko", fullName: "Akko Makina", address: "A≈üaƒüƒ±pƒ±narba≈üƒ± Osb Mh. 526 Nolu Sk. No:1 42160 Sel√ßuklu / Konya", tel: "" },
  { id: "CK2", name: "Primus", fullName: "Primus Coating Turkey Kaplama San. Tic. A.≈û.", address: "I≈üƒ±ktepe Organize Sanayi B√∂lgesi, Beyaz Sokak, No: 4H Nil√ºfer/Bursa", tel: "" },
  { id: "CK3", name: "Oerlikon Balzers", fullName: "Oerlikon Balzers Kaplama Sanayi ve Ticaret Ltd. ≈ûti.", address: "NOSAB Ihlamur Cad. No:16 / A 16145 Nil√ºfer / Bursa", tel: "0262 XXX XX XX" },
];
const COATING_COMPANIES_BILEME = [
  { id: "CK1", name: "Akko", fullName: "Akko Makina", address: "A≈üaƒüƒ±pƒ±narba≈üƒ± Osb Mh. 526 Nolu Sk. No:1 42160 Sel√ßuklu / Konya", tel: "" },
  { id: "CK2", name: "Primus", fullName: "Primus Coating Turkey Kaplama San. Tic. A.≈û.", address: "I≈üƒ±ktepe Organize Sanayi B√∂lgesi, Beyaz Sokak, No: 4H Nil√ºfer/Bursa", tel: "" },
  { id: "CK3", name: "Oerlikon Balzers", fullName: "Oerlikon Balzers Kaplama Sanayi ve Ticaret Ltd. ≈ûti.", address: "NOSAB Ihlamur Cad. No:16 / A 16145 Nil√ºfer / Bursa", tel: "0262 XXX XX XX" },
];
const COATING_TYPES_BY_COMPANY = {
  CK1: ["AlCrN","TiN"],
  CK2: ["ALTƒ∞N","ALCRN","TISIN","ALTISIN","ZRN"],
  CK3: ["Latuma","Xceed","Alcrn Pro","Alnova","Durana","Tisinos Pro","DLC","Mayura"],
};
const COATING_TYPES_PRODUCTION = [...new Set(Object.values(COATING_TYPES_BY_COMPANY).flat())];
const COATING_TYPES_BILEME = ["ALTƒ∞N","ALCRN","TISIN","ALTISIN","ZRN","AlCrN","TiN"];
const MATERIAL_CODES = [
  { value:"BE-1", label:"BE-1", color:"#eab308" },
  { value:"BE-2", label:"BE-2", color:"#4b5563" },
  { value:"BE-3", label:"BE-3", color:"#a855f7" },
  { value:"BS-1", label:"BS-1", color:"#3b82f6" },
  { value:"BC-1", label:"BC-1", color:"#ef4444" },
  { value:"BM-1", label:"BM-1", color:"#f97316" },
  { value:"BM-2", label:"BM-2", color:"#b45309" },
  { value:"AB-1", label:"AB-1", color:"#94a3b8" },
  { value:"AS-1", label:"AS-1", color:"#94a3b8" },
  { value:"AS-2", label:"AS-2", color:"#94a3b8" },
  { value:"AC-1", label:"AC-1", color:"#94a3b8" },
  { value:"AG-1", label:"AG-1", color:"#94a3b8" },
];
const GRINDING_TYPES = ["Kares Ta≈ülama","Studer Ta≈ülama"];
const PRODUCT_TYPES = [
  "Std. Freze","Chatter Free Freze","K√ºre Freze","Radyuslu Freze","Aluminyum Freze",
  "Matkap","Hav≈üalƒ± Matkap","Kademeli Matkap","√áok Kademeli Matkap","Rayba","Konik Rayba"
];
const BILEME_ISLEMLERI = [
  "Alƒ±n Bileme","Alƒ±n Bileme + Kaplama","Komple Bileme","Komple Bileme + Kaplama",
  "K√ºre Alƒ±n Bileme","K√ºre Alƒ±n Bileme + Kaplama","Radyuslu Alƒ±n Bileme",
  "Radyuslu Alƒ±n Bileme + Kaplama","Radyuslu Komple Bileme","Radyuslu Komple Bileme + Kaplama",
  "Kademeli Matkap Bileme","Kademeli Matkap Bileme + Kaplama",
];
const BAR_LENGTH = 330; // mm - standard carbide bar length
const STANDARD_DIAMETERS = [2,3,4,5,6,8,10,12,14,16,18,20,22,25,30,32];
const QUALITY_GRADES = MATERIAL_CODES.map(m => m.value);
const REMNANT_RANGES = [
  { key:"0-45", label:"0‚Äì45mm", min:0, max:45 },
  { key:"45-55", label:"45‚Äì55mm", min:45, max:55 },
  { key:"55-65", label:"55‚Äì65mm", min:55, max:65 },
  { key:"65-82", label:"65‚Äì82mm", min:65, max:82 },
  { key:"82-110", label:"82‚Äì110mm", min:82, max:110 },
  { key:"110-150", label:"110‚Äì150mm", min:110, max:165 },
  { key:"165+", label:"165mm+", min:165, max:999 },
];
const getRemnantRange = (len) => REMNANT_RANGES.find(r => len >= r.min && len < r.max) || (len >= 165 ? REMNANT_RANGES[6] : null);

// Seed: main material codes with representative stock
const BAR_STOCK_SEED = (() => {
  const stock = [];
  const seedQty = {
    "BE-1": {2:100,3:250,4:180,5:320,6:410,8:150,10:200,12:90,14:60,16:45,18:30,20:25,22:20,25:15,30:10,32:8},
    "BE-2": {3:80,4:60,6:120,8:75,10:50,12:35,14:20,16:15},
    "BE-3": {4:40,6:55,8:30,10:20},
    "BS-1": {3:90,4:70,6:100,8:60,10:45,12:25},
    "BC-1": {4:50,6:80,8:45,10:30,12:20},
    "BM-1": {6:65,8:40,10:25,12:15},
    "BM-2": {6:35,8:25,10:15},
  };
  Object.entries(seedQty).forEach(([grade, diameters]) => {
    Object.entries(diameters).forEach(([d, qty]) => {
      const emptyRemnants = {};
      REMNANT_RANGES.forEach(r => { emptyRemnants[r.key] = 0; });
      stock.push({ id: `BS-${grade}-${d}`, diameter: Number(d), materialCode: grade, fullBars: qty, remnants: { ...emptyRemnants } });
    });
  });
  return stock;
})();

const RAW_MATERIALS = BAR_STOCK_SEED; // backward compat
const CURRENCIES = [
  { value:"EUR",label:"‚Ç¨ Euro",symbol:"‚Ç¨" },
  { value:"TRY",label:"‚Ç∫ TL",symbol:"‚Ç∫" },
  { value:"USD",label:"$ Dolar",symbol:"$" },
];

const WORK_START = 8*60;    // 08:00 = 480 min
const WORK_END = 17*60+30;  // 17:30 = 1050 min
const WORK_MINUTES = WORK_END - WORK_START; // 570 min

const genId = () => Math.random().toString(36).substr(2,9);

// Self-managing input that maintains focus during typing
function LocalInput({value,onChange,onBlur,placeholder,style:s2,type,inputMode:im}) {
  const [local,setLocal]=useState(value||"");
  const ref=useRef(null);
  const prevValue=useRef(value);
  useEffect(()=>{if(value!==prevValue.current){setLocal(value||"");prevValue.current=value;}},[value]);
  return <input ref={ref} type={type||"text"} inputMode={im} value={local} placeholder={placeholder}
    onChange={e=>{setLocal(e.target.value);if(onChange)onChange(e.target.value);}}
    onBlur={()=>{if(onBlur)onBlur(local);}} style={s2}/>;
}
const fmtDate = d => new Date(d).toLocaleDateString("tr-TR");
const fmtDateTime = d => new Date(d).toLocaleString("tr-TR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});
const fmtMoney = (v,c) => { const s=CURRENCIES.find(x=>x.value===c)?.symbol||"‚Ç¨"; return `${s}${Number(v||0).toFixed(2)}`; };
const minToTime = m => { const h=Math.floor(m/60); const mm=m%60; return `${String(h).padStart(2,"0")}:${String(mm).padStart(2,"0")}`; };
const fmtTime = minToTime;
const dateStr = d => { const dd=new Date(d); return `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,"0")}-${String(dd.getDate()).padStart(2,"0")}`; };
const addDays = (d,n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
const isWeekend = d => { const day=new Date(d).getDay(); return day===0||day===6; };
const nextWorkDay = d => { let r=addDays(d,1); while(isWeekend(r)) r=addDays(r,1); return r; };
const dayLabel = d => new Date(d).toLocaleDateString("tr-TR",{weekday:"short",day:"numeric",month:"short"});

const SAMPLE_ORDERS = [
  {
    id:"SIP-2026-001",customerId:"MUS-01",customerName:"ABC Makina Ltd.",date:"2026-02-10",
    deliveryDate:"2026-02-28",status:"production",priority:"high",notes:"Acil sipari≈ü",
    orderType:"production",currency:"EUR",
    items:[{id:"I1",productType:"Std. Freze",toolCode:"MHK-E4050",productCode:"√ò4x50",diameter:4,length:50,qty:500,unitPrice:3.20,
      coatingType:"Latuma",coatingCompanyId:"CK3",materialCode:"BE-1",grinding:"",grindingType:"",
      estimatedMinutes:120,pdfs:[]}]
  },
  {
    id:"SIP-2026-002",customerId:"MUS-02",customerName:"XYZ Otomotiv A.≈û.",date:"2026-02-12",
    deliveryDate:"2026-03-10",status:"production",priority:"normal",notes:"",
    orderType:"production",currency:"EUR",
    items:[
      {id:"I2",productType:"K√ºre Freze",toolCode:"MHK-EG6075",productCode:"√ò6x75",diameter:6,length:75,qty:200,unitPrice:5.50,
        coatingType:"ALTƒ∞N",coatingCompanyId:"CK2",materialCode:"BE-1",grinding:true,grindingType:"Studer Ta≈ülama",
        estimatedMinutes:240,pdfs:[]},
      {id:"I3",productType:"Matkap",toolCode:"MHK-D8100",productCode:"√ò8x100",diameter:8,length:100,qty:150,unitPrice:7.80,
        coatingType:"AlCrN",coatingCompanyId:"CK1",materialCode:"BE-2",grinding:true,grindingType:"Kares Ta≈ülama",
        estimatedMinutes:180,pdfs:[]}
    ]
  },
  {
    id:"SIP-2026-003",customerId:"MUS-03",customerName:"DEF Havacƒ±lƒ±k",date:"2026-02-14",
    deliveryDate:"2026-03-15",status:"pending",priority:"normal",notes:"Bileme sipari≈üi",
    orderType:"bileme",currency:"TRY",
    items:[
      {id:"I4",diameter:10,islem:"Komple Bileme + Kaplama",qty:80,unitPrice:125.00,
        coatingType:"ALTƒ∞N",coatingCompanyId:"CK2",estimatedMinutes:90,pdfs:[]},
      {id:"I5",diameter:6,islem:"Alƒ±n Bileme",qty:200,unitPrice:55.00,
        coatingType:"",coatingCompanyId:"",estimatedMinutes:60,pdfs:[]}
    ]
  }
];

// 
// UI COMPONENTS
// 
const Badge = ({children,color,bg}) => (
  <span style={{display:"inline-flex",alignItems:"center",gap:4,padding:"3px 10px",borderRadius:6,fontSize:12,fontWeight:600,color,background:bg,letterSpacing:.3}}>{children}</span>
);
const STATUS_MAP = {
  pending:{label:"Beklemede",color:"#94a3b8",bg:"rgba(148,163,184,0.15)"},
  active:{label:"ƒ∞≈ülemde",color:"#3b82f6",bg:"rgba(59,130,246,0.15)"},
  completed:{label:"Tamamlandƒ±",color:"#10b981",bg:"rgba(16,185,129,0.15)"},
};
const StatusBadge = ({status}) => { const s=STATUS_MAP[status]||STATUS_MAP.pending; return <Badge color={s.color} bg={s.bg}>{s.label}</Badge>; };
const PriorityBadge = ({priority}) => {
  const m={high:{l:"Y√ºksek",c:"#ef4444",b:"rgba(239,68,68,0.15)"},normal:{l:"Normal",c:"#3b82f6",b:"rgba(59,130,246,0.15)"},low:{l:"D√º≈ü√ºk",c:"#94a3b8",b:"rgba(148,163,184,0.15)"}};
  const p=m[priority]||m.normal; return <Badge color={p.c} bg={p.b}>{p.l}</Badge>;
};
const OrderTypeBadge = ({type}) => type==="bileme"?<Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">üîß Bileme</Badge>:<Badge color="#6366f1" bg="rgba(99,102,241,0.15)">üè≠ √úretim</Badge>;

function Btn({children,variant="primary",size="md",onClick,disabled,style:s2,icon:Icon}){
  const base={display:"inline-flex",alignItems:"center",gap:6,border:"none",borderRadius:8,cursor:disabled?"not-allowed":"pointer",fontWeight:600,fontFamily:"inherit",transition:"all 0.15s",opacity:disabled?0.5:1,whiteSpace:"nowrap"};
  const sizes={sm:{padding:"6px 12px",fontSize:12},md:{padding:"8px 16px",fontSize:13},lg:{padding:"10px 20px",fontSize:14}};
  const vars={primary:{background:"#3b82f6",color:"#fff"},success:{background:"#10b981",color:"#fff"},danger:{background:"#ef4444",color:"#fff"},warning:{background:"#f59e0b",color:"#000"},ghost:{background:"rgba(255,255,255,0.06)",color:"#94a3b8",border:"1px solid rgba(255,255,255,0.1)"},outline:{background:"transparent",color:"#3b82f6",border:"1px solid #3b82f6"}};
  return <button onClick={onClick} disabled={disabled} style={{...base,...sizes[size],...vars[variant],...s2}}>{Icon&&<Icon size={size==="sm"?14:16}/>}{children}</button>;
}

function Input({label,value,onChange,type="text",placeholder,options,style:s2,disabled,rows,step,accept,onFileChange}){
  const wrap={display:"flex",flexDirection:"column",gap:4,...s2};
  const ist={padding:"8px 12px",borderRadius:8,border:"1px solid rgba(255,255,255,0.12)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit",outline:"none"};
  if(accept) return (
    <div style={wrap}>
      {label&&<label style={{fontSize:12,color:"#94a3b8",fontWeight:600}}>{label}</label>}
      <input type="file" accept={accept} onChange={onFileChange} style={{...ist,padding:"6px 8px",fontSize:12}} disabled={disabled}/>
    </div>
  );
  if(options) return (
    <div style={wrap}>
      {label&&<label style={{fontSize:12,color:"#94a3b8",fontWeight:600}}>{label}</label>}
      <select value={value} onChange={e=>onChange(e.target.value)} style={ist} disabled={disabled}><option value="">Se√ßiniz...</option>{options.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}</select>
    </div>
  );
  if(rows) return (
    <div style={wrap}>
      {label&&<label style={{fontSize:12,color:"#94a3b8",fontWeight:600}}>{label}</label>}
      <textarea value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} rows={rows} style={{...ist,resize:"vertical"}} disabled={disabled}/>
    </div>
  );
  return (
    <div style={wrap}>
      {label&&<label style={{fontSize:12,color:"#94a3b8",fontWeight:600}}>{label}</label>}
      <input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} style={ist} disabled={disabled} step={step}/>
    </div>
  );
}

const Card = ({children,style:s2,onClick}) => (
  <div onClick={onClick} style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:12,padding:20,...s2,cursor:onClick?"pointer":"default"}}>{children}</div>
);

function Modal({title,onClose,children,width=700}){
  return (
    <div style={{position:"fixed",inset:0,zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.7)",backdropFilter:"blur(4px)"}} onClick={onClose}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#1a1f2e",border:"1px solid rgba(255,255,255,0.1)",borderRadius:16,width:"92%",maxWidth:width,maxHeight:"88vh",overflow:"auto",padding:24}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
          <h3 style={{margin:0,color:"#f1f5f9",fontSize:18}}>{title}</h3>
          <button onClick={onClose} style={{background:"none",border:"none",color:"#94a3b8",cursor:"pointer",fontSize:20}}>‚úï</button>
        </div>
        {children}
      </div>
    </div>
  );
}

function TabSwitcher({tabs,active,onChange}){
  return (
    <div style={{display:"flex",gap:0,background:"rgba(255,255,255,0.04)",borderRadius:10,padding:3,border:"1px solid rgba(255,255,255,0.08)"}}>
      {tabs.map(t=>(
        <button key={t.key} onClick={()=>onChange(t.key)} style={{flex:1,padding:"10px 16px",borderRadius:8,border:"none",cursor:"pointer",fontFamily:"inherit",fontSize:13,fontWeight:600,transition:"all 0.2s",background:active===t.key?t.color||"#3b82f6":"transparent",color:active===t.key?"#fff":"#64748b",display:"flex",alignItems:"center",justifyContent:"center",gap:6}}>
          {t.icon&&<t.icon size={15}/>}{t.label}
        </button>
      ))}
    </div>
  );
}

function WorkflowProgress({currentStep,orderType}){
  const steps = orderType==="bileme"?[
    {key:"order",label:"Sipari≈ü",color:"#6366f1"},{key:"workorder",label:"ƒ∞≈ü Emri",color:"#8b5cf6"},
    {key:"production",label:"Bileme",color:"#3b82f6"},{key:"qc",label:"KK",color:"#10b981"},
    {key:"coating",label:"Kaplama",color:"#14b8a6"},{key:"shipping",label:"Sevkiyat",color:"#ef4444"}
  ]:[
    {key:"order",label:"Sipari≈ü",color:"#6366f1"},{key:"workorder",label:"ƒ∞≈ü Emri",color:"#8b5cf6"},
    {key:"cutting",label:"Kesim",color:"#f59e0b"},{key:"grinding",label:"Ta≈ülama",color:"#d946ef"},{key:"production",label:"√úretim",color:"#3b82f6"},
    {key:"qc",label:"KK",color:"#10b981"},{key:"laser",label:"Lazer",color:"#a855f7"},
    {key:"coating",label:"Kaplama",color:"#14b8a6"},{key:"shipping",label:"Sevkiyat",color:"#ef4444"}
  ];
  const idx=steps.findIndex(s=>s.key===currentStep);
  return (
    <div style={{display:"flex",alignItems:"center",gap:2,overflowX:"auto",padding:"6px 0"}}>
      {steps.map((s,i)=>{const done=i<idx;const act=i===idx;return(
        <div key={s.key} style={{display:"flex",alignItems:"center",gap:2}}>
          <div style={{display:"flex",alignItems:"center",gap:4,padding:"4px 8px",borderRadius:6,background:act?`${s.color}22`:done?"rgba(16,185,129,0.1)":"rgba(255,255,255,0.03)",border:act?`1px solid ${s.color}`:"1px solid transparent",whiteSpace:"nowrap"}}>
            {done?<Check size={11} color="#10b981"/>:<CircleDot size={11} color={act?s.color:"#475569"}/>}
            <span style={{fontSize:10,fontWeight:600,color:act?s.color:done?"#10b981":"#64748b"}}>{s.label}</span>
          </div>
          {i<steps.length-1&&<ChevronRight size={12} color="#334155"/>}
        </div>
      );})}
    </div>
  );
}

// 
// SCHEDULING ENGINE
// 
function buildSchedule(productionJobs, workOrders, startDate) {
  const schedule = {};
  const allJobs = [...productionJobs].filter(j=>j.machineId && j.estimatedMinutes > 0);

  // Group by machine
  const byMachine = {};
  allJobs.forEach(j => {
    if(!byMachine[j.machineId]) byMachine[j.machineId] = [];
    byMachine[j.machineId].push(j);
  });

  // Compare two (date, minute) pairs: returns <0, 0, >0
  const cmpDT = (d1,m1,d2,m2) => d1===d2 ? m1-m2 : d1.localeCompare(d2);

  Object.entries(byMachine).forEach(([mid, jobs]) => {
    // Sort all jobs by assignedAt (preserves creation/assignment order)
    // Manual jobs with earlier planDate+planStartMin can jump ahead in time
    jobs.sort((a,b) => (a.assignedAt||0) - (b.assignedAt||0));

    // Cursor tracks where the next job can start on this machine
    let curDate = dateStr(startDate);
    let curMin = WORK_START;

    // Advance cursor past weekends & past work end
    const advanceCursor = () => {
      while(isWeekend(curDate)) { curDate = dateStr(nextWorkDay(curDate)); curMin = WORK_START; }
      if(curMin >= WORK_END) { curDate = dateStr(nextWorkDay(curDate)); curMin = WORK_START; }
      while(isWeekend(curDate)) { curDate = dateStr(nextWorkDay(curDate)); curMin = WORK_START; }
    };

    jobs.forEach(job => {
      advanceCursor();

      // If manual placement is LATER than cursor, jump forward (creates a gap/break)
      if(job.planDate && job.planStartMin != null) {
        if(cmpDT(job.planDate, job.planStartMin, curDate, curMin) > 0) {
          curDate = job.planDate;
          curMin = job.planStartMin;
          advanceCursor();
        }
      }

      // Place this job starting at cursor, spanning across days if needed
      let remaining = job.estimatedMinutes;
      const blocks = [];

      while(remaining > 0) {
        advanceCursor();
        const available = WORK_END - curMin;
        if(available <= 0) { curDate = dateStr(nextWorkDay(curDate)); curMin = WORK_START; continue; }
        const take = Math.min(remaining, available);
        const block = { date: curDate, start: curMin, end: curMin + take, jobId: job.id, machineId: mid };
        blocks.push(block);
        if(!schedule[curDate]) schedule[curDate] = [];
        schedule[curDate].push({ ...block, woId: job.woId, itemId: job.itemId });
        remaining -= take;
        curMin += take;
        if(remaining > 0) { curDate = dateStr(nextWorkDay(curDate)); curMin = WORK_START; }
      }

      job._blocks = blocks;
      if(blocks.length > 0) {
        const last = blocks[blocks.length-1];
        job._endDate = last.date;
        job._endTime = last.end;
      }
      // Cursor is now at end of this job ‚Üí next job cascades from here
    });
  });

  return schedule;
}

// 
// MAIN APP
// 
function App() {
  const [currentUser, setCurrentUser] = useState(() => {
    try { 
      const s = localStorage.getItem("mihenkCurrentUser"); 
      if(!s) return null;
      const saved = JSON.parse(s);
      // Validate saved session against current users
      const usersData = localStorage.getItem("mihenkUsers");
      const usersList = usersData ? JSON.parse(usersData) : USERS_SEED;
      const valid = usersList.find(u => u.id === saved.id);
      return valid ? {...valid} : null;
    } catch(e) { return null; }
  });
  useEffect(() => { try { if(currentUser) localStorage.setItem("mihenkCurrentUser", JSON.stringify(currentUser)); else localStorage.removeItem("mihenkCurrentUser"); } catch(e){} }, [currentUser]);
  const [users, setUsers] = useState(() => {
    try { const s = localStorage.getItem("mihenkUsers"); return s ? JSON.parse(s) : USERS_SEED; } catch(e) { return USERS_SEED; }
  });
  const [page, setPage] = useState("dashboard");
  const [orders, setOrders] = useState(SAMPLE_ORDERS);
  const [workOrders, setWorkOrders] = useState([
    {id:"IE-001-0",orderId:"SIP-2026-001",customerId:"MUS-01",customerName:"ABC Makina Ltd.",
      orderType:"production",deliveryDate:"2026-02-28",priority:"high",currentStep:"production",
      items:[{id:"I1",productType:"Std. Freze",toolCode:"MHK-E4050",productCode:"√ò4x50",diameter:4,length:50,qty:500,unitPrice:3.20,
        coatingType:"Latuma",coatingCompanyId:"CK3",materialCode:"BE-1",grinding:false,grindingType:"",
        estimatedMinutes:120,woStatus:"assigned",machineId:"M1",operatorId:"OP1",pdfs:[],
        qcChecks:{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false}}]},
    {id:"IE-002-0",orderId:"SIP-2026-002",customerId:"MUS-02",customerName:"XYZ Otomotiv A.≈û.",
      orderType:"production",deliveryDate:"2026-03-10",priority:"normal",currentStep:"grinding",
      items:[{id:"I2",productType:"K√ºre Freze",toolCode:"MHK-EG6075",productCode:"√ò6x75",diameter:6,length:75,qty:200,unitPrice:5.50,
        coatingType:"ALTƒ∞N",coatingCompanyId:"CK2",materialCode:"BE-1",grinding:true,grindingType:"Studer Ta≈ülama",
        estimatedMinutes:60,woStatus:"grinding",grindMachineId:"M4",machineId:null,operatorId:null,pdfs:[],
        cutDate:"2026-02-13T14:00:00Z",cutBarsUsed:67,
        qcChecks:{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false}}]},
    {id:"IE-002-1",orderId:"SIP-2026-002",customerId:"MUS-02",customerName:"XYZ Otomotiv A.≈û.",
      orderType:"production",deliveryDate:"2026-03-10",priority:"normal",currentStep:"grinding",
      items:[{id:"I3",productType:"Matkap",toolCode:"MHK-D8100",productCode:"√ò8x100",diameter:8,length:100,qty:150,unitPrice:7.80,
        coatingType:"AlCrN",coatingCompanyId:"CK1",materialCode:"BE-2",grinding:true,grindingType:"Kares Ta≈ülama",
        estimatedMinutes:90,woStatus:"grinding_dispatch",machineId:null,operatorId:null,pdfs:[],
        cutDate:"2026-02-14T10:00:00Z",cutBarsUsed:50,grindDiameter:"",grindLength:"",
        qcChecks:{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false}}]}
  ]);
  const [productionJobs, setProductionJobs] = useState([
    {id:"PJ1",woId:"IE-001-0",itemId:"I1",machineId:"M1",operatorId:"OP1",status:"assigned",
      startTime:null,endTime:null,estimatedMinutes:120,assignedAt:1000}
  ]);
  const [machines, setMachines] = useState(() => {
    try { const s = localStorage.getItem("mihenkMachines"); return s ? JSON.parse(s) : MACHINES_SEED; } catch(e) { return MACHINES_SEED; }
  });
  const [operators, setOperators] = useState(() => {
    try { const s = localStorage.getItem("mihenkOperators"); return s ? JSON.parse(s) : OPERATORS_SEED; } catch(e) { return OPERATORS_SEED; }
  });
  const [barStock, setBarStock] = useState(BAR_STOCK_SEED);
  const [coatingQueue, setCoatingQueue] = useState([]);
  const [grindingQueue, setGrindingQueue] = useState([]);
  const [purchaseRequests, setPurchaseRequests] = useState([]);
  const [modal, setModal] = useState(null);
  const [sideCollapsed, setSideCollapsed] = useState(false);
  const [pdfViewer, setPdfViewer] = useState(null);
  const [woDetail, setWoDetail] = useState(null);

  const [userPerms, setUserPerms] = useState(() => {
    try { const s = localStorage.getItem("mihenkUserPerms"); return s ? JSON.parse(s) : {}; } catch(e) { return {}; }
  });
  useEffect(() => { try { localStorage.setItem("mihenkUserPerms", JSON.stringify(userPerms)); } catch(e){} }, [userPerms]);
  // Persist users list
  useEffect(() => { try { localStorage.setItem("mihenkUsers", JSON.stringify(users)); } catch(e){} }, [users]);
  // Persist machines & operators
  useEffect(() => { try { localStorage.setItem("mihenkMachines", JSON.stringify(machines)); } catch(e){} }, [machines]);
  useEffect(() => { try { localStorage.setItem("mihenkOperators", JSON.stringify(operators)); } catch(e){} }, [operators]);

  const hasPerm = useCallback((perm) => {
    if(!currentUser) return false;
    const perms = userPerms[currentUser.id] || DEFAULT_ROLES[currentUser.role]?.permissions || [];
    return perms.includes("admin") || perms.includes(perm);
  }, [currentUser, userPerms]);

  const canPrice = hasPerm("orders_price");

  //  PDF HELPERS 
  const addPdfToOrderItem = useCallback((orderId, itemId, file) => {
    const reader = new FileReader();
    reader.onload = ev => {
      const pdf = { id: genId(), name: file.name, data: ev.target.result, stage: "Sipari≈ü", date: new Date().toISOString() };
      setOrders(p => p.map(o => {
        if (o.id !== orderId) return o;
        return { ...o, items: o.items.map(it => it.id === itemId ? { ...it, pdfs: [...(it.pdfs || []), pdf] } : it) };
      }));
    };
    reader.readAsDataURL(file);
  }, []);

  const addPdfToWoItem = useCallback((woId, itemId, file, stage) => {
    const reader = new FileReader();
    reader.onload = ev => {
      const pdf = { id: genId(), name: file.name, data: ev.target.result, stage: stage || "ƒ∞≈ü Emri", date: new Date().toISOString() };
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== woId) return wo;
        return { ...wo, items: wo.items.map(it => it.id === itemId ? { ...it, pdfs: [...(it.pdfs || []), pdf] } : it) };
      }));
      // Also sync back to order
      const wo = workOrders.find(w => w.id === woId);
      if (wo) {
        setOrders(p => p.map(o => {
          if (o.id !== wo.orderId) return o;
          return { ...o, items: o.items.map(it => it.id === itemId ? { ...it, pdfs: [...(it.pdfs || []), pdf] } : it) };
        }));
      }
    };
    reader.readAsDataURL(file);
  }, [workOrders]);

  const removePdf = useCallback((woId, itemId, pdfId) => {
    if (woId) {
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== woId) return wo;
        return { ...wo, items: wo.items.map(it => it.id === itemId ? { ...it, pdfs: (it.pdfs || []).filter(p => p.id !== pdfId) } : it) };
      }));
    }
  }, []);

  // Reusable PDF display + upload component
  const PdfChips = ({ pdfs = [], onUpload, canEdit = true, size = "sm" }) => {
    const fileRef = useRef(null);
    return (
      <div style={{ display: "flex", gap: 4, flexWrap: "wrap", alignItems: "center" }}>
        {pdfs.map(pdf => (
          <button key={pdf.id} onClick={() => setPdfViewer({ name: pdf.name, data: pdf.data })}
            style={{ display: "inline-flex", alignItems: "center", gap: 3, padding: size === "sm" ? "2px 8px" : "4px 10px", borderRadius: 5, fontSize: size === "sm" ? 11 : 12, fontWeight: 600, color: "#3b82f6", background: "rgba(59,130,246,0.1)", border: "none", cursor: "pointer", maxWidth: 160, overflow: "hidden" }}
            title={`${pdf.name} ‚Äî ${pdf.stage} (${fmtDate(pdf.date)})`}>
            <File size={size === "sm" ? 10 : 12} />
            <span style={{ overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{pdf.name}</span>
          </button>
        ))}
        {canEdit && onUpload && (
          <>
            <input ref={fileRef} type="file" accept=".pdf" style={{ display: "none" }} onChange={e => { const f = e.target.files?.[0]; if (f) onUpload(f); e.target.value = ""; }} />
            <button onClick={() => fileRef.current?.click()}
              style={{ display: "inline-flex", alignItems: "center", gap: 3, padding: "2px 8px", borderRadius: 5, fontSize: 11, fontWeight: 600, color: "#10b981", background: "rgba(16,185,129,0.1)", border: "1px dashed rgba(16,185,129,0.3)", cursor: "pointer" }}>
              <Upload size={10} /> PDF Ekle
            </button>
          </>
        )}
      </div>
    );
  };

  // Schedule
  const schedule = useMemo(() => buildSchedule(productionJobs, workOrders, new Date("2026-02-14")), [productionJobs, workOrders]);

  //  ACTIONS 
  const generateWorkOrder = useCallback((order) => {
    const newWOs = order.items.map((item, idx) => ({
      id:`IE-${order.id.split("-").pop()}-${idx+1}`, orderId:order.id, customerName:order.customerName,
      date:new Date().toISOString(), deliveryDate:order.deliveryDate, status:"pending",
      currentStep:"workorder", orderType:order.orderType, currency:order.currency,
      items:[{
        ...item, woStatus:"pending", machineId:null, operatorId:null, startTime:null, endTime:null,
        qcChecks:{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false},
        laserDone:false, coatingSent:false, coatingReceived:false,
      }],
      priority:order.priority,
    }));
    setWorkOrders(p=>[...p,...newWOs]);
    setOrders(p=>p.map(o=>o.id===order.id?{...o,status:"workorder"}:o));
  },[]);

  const [confirmDel, setConfirmDel] = useState(null);

  const deleteOrder = useCallback((orderId) => {
    const relatedWOs = workOrders.filter(wo => wo.orderId === orderId);
    const relatedWoIds = relatedWOs.map(wo => wo.id);
    setProductionJobs(p => p.filter(j => !relatedWoIds.includes(j.woId)));
    setCoatingQueue(p => p.filter(d => !relatedWoIds.includes(d.woId)));
    setWorkOrders(p => p.filter(wo => wo.orderId !== orderId));
    setOrders(p => p.filter(o => o.id !== orderId));
    setConfirmDel(null);
    setModal(null);
  }, [workOrders]);

  const deleteWorkOrder = useCallback((woId) => {
    setProductionJobs(p => p.filter(j => j.woId !== woId));
    setCoatingQueue(p => p.filter(d => d.woId !== woId));
    setWorkOrders(p => p.filter(wo => wo.id !== woId));
    // Check if parent order has any remaining WOs; if not, revert order status
    const wo = workOrders.find(w => w.id === woId);
    if (wo) {
      const remaining = workOrders.filter(w => w.orderId === wo.orderId && w.id !== woId);
      if (remaining.length === 0) {
        setOrders(p => p.map(o => o.id === wo.orderId ? { ...o, status: "pending" } : o));
      }
    }
    setConfirmDel(null);
    setWoDetail(null);
  }, [workOrders]);

  const [rescheduleModal, setRescheduleModal] = useState(null);

  const rescheduleJob = useCallback((jobId, { planDate, planStartMin, estimatedMinutes, machineId }) => {
    setProductionJobs(p => p.map(j => {
      if (j.id !== jobId) return j;
      const updates = {};
      if (planDate !== undefined) updates.planDate = planDate;
      if (planStartMin !== undefined) updates.planStartMin = planStartMin;
      if (estimatedMinutes !== undefined) updates.estimatedMinutes = estimatedMinutes;
      if (machineId !== undefined) updates.machineId = machineId;
      return { ...j, ...updates };
    }));
    // Also sync estimatedMinutes to WO item
    if (estimatedMinutes !== undefined) {
      const job = productionJobs.find(j => j.id === jobId);
      if (job) {
        setWorkOrders(p => p.map(wo => {
          if (wo.id !== job.woId) return wo;
          return { ...wo, items: wo.items.map(it => it.id === job.itemId ? { ...it, estimatedMinutes } : it) };
        }));
      }
    }
    setRescheduleModal(null);
  }, [productionJobs]);

  const clearManualSchedule = useCallback((jobId) => {
    setProductionJobs(p => p.map(j => j.id === jobId ? { ...j, planDate: null, planStartMin: null } : j));
    setRescheduleModal(null);
  }, []);

  //  CUTTING FUNCTIONS 
  const calculateCutting = useCallback((diameter, materialCode, itemLength, qty) => {
    const entry = barStock.find(s => s.diameter === diameter && s.materialCode === materialCode);
    if (!entry) return { found: false, availableBars: 0, barsNeeded: 0, piecesPerBar: 0, remnant: 0, sufficient: false, usableRemnants: [] };
    const piecesPerBar = Math.floor(BAR_LENGTH / itemLength);
    if (piecesPerBar === 0) return { found: true, availableBars: entry.fullBars, barsNeeded: 0, piecesPerBar: 0, remnant: 0, sufficient: false, error: "√úr√ºn boyu √ßubuk boyundan (330mm) b√ºy√ºk!" };
    const barsNeeded = Math.ceil(qty / piecesPerBar);
    const lastBarPieces = qty % piecesPerBar || piecesPerBar;
    const fullBarRemnant = BAR_LENGTH - (piecesPerBar * itemLength);
    const lastBarRemnant = BAR_LENGTH - (lastBarPieces * itemLength);

    // Check usable remnants (pieces from remnant stock that could fit at least 1 piece)
    const usableRemnants = [];
    REMNANT_RANGES.forEach(range => {
      const count = entry.remnants[range.key] || 0;
      if (count > 0 && range.min >= itemLength) {
        usableRemnants.push({ rangeKey: range.key, label: range.label, count, piecesCanCut: Math.floor(range.min / itemLength) });
      }
    });

    return {
      found: true,
      availableBars: entry.fullBars,
      barsNeeded,
      piecesPerBar,
      fullBarRemnant,
      lastBarRemnant,
      sufficient: entry.fullBars >= barsNeeded,
      usableRemnants,
      totalRemnantBars: barsNeeded > 1 ? barsNeeded - 1 : 0, // bars that produce fullBarRemnant
    };
  }, [barStock]);

  const performCutting = useCallback((woId, itemId, barsUsed, remnantLength, useRemnant) => {
    // useRemnant: { rangeKey, count } ‚Äî optional, if using remnant stock instead of/alongside full bars
    const wo = workOrders.find(w => w.id === woId);
    const item = wo?.items.find(i => i.id === itemId);
    if (!item) return;

    setBarStock(prev => prev.map(entry => {
      if (entry.diameter !== item.diameter || entry.materialCode !== item.materialCode) return entry;
      const updated = { ...entry, fullBars: entry.fullBars - barsUsed, remnants: { ...entry.remnants } };
      // Deduct from remnant if used
      if (useRemnant) {
        updated.remnants[useRemnant.rangeKey] = Math.max(0, (updated.remnants[useRemnant.rangeKey] || 0) - useRemnant.count);
      }
      // Add remnant from last bar to appropriate range (if > 0)
      if (remnantLength > 0) {
        const range = getRemnantRange(remnantLength);
        if (range) {
          updated.remnants[range.key] = (updated.remnants[range.key] || 0) + 1;
        }
      }
      // Add remnants from all full bars that produce remainders
      if (barsUsed > 1) {
        const piecesPerBar = Math.floor(BAR_LENGTH / item.length);
        const fullBarRem = BAR_LENGTH - (piecesPerBar * item.length);
        if (fullBarRem > 0) {
          const range = getRemnantRange(fullBarRem);
          if (range) {
            updated.remnants[range.key] = (updated.remnants[range.key] || 0) + (barsUsed - 1);
          }
        }
      }
      return updated;
    }));

    // Update WO item status based on grinding
    setWorkOrders(p => p.map(wo => {
      if (wo.id !== woId) return wo;
      return {
        ...wo,
        currentStep: "cutting",
        items: wo.items.map(it => {
          if (it.id !== itemId) return it;
          let nextStatus = "cut"; // default: ready for production
          let grindMachine = null;
          if (it.grinding && it.grindingType === "Kares Ta≈ülama") nextStatus = "grinding_dispatch";
          else if (it.grinding && it.grindingType === "Studer Ta≈ülama") { nextStatus = "grinding"; grindMachine = "M4"; }
          return { ...it, woStatus: nextStatus, cutDate: new Date().toISOString(), cutBarsUsed: barsUsed, cutRemnant: remnantLength, ...(grindMachine ? { grindMachineId: grindMachine } : {}) };
        })
      };
    }));
  }, [workOrders]);

  //  GRINDING FUNCTIONS 
  const completeInternalGrinding = useCallback((woId, itemId) => {
    setWorkOrders(p => p.map(wo => {
      if (wo.id !== woId) return wo;
      return { ...wo, currentStep: "grinding", items: wo.items.map(it => it.id === itemId ? { ...it, woStatus: "cut", grindingDone: true, grindingDate: new Date().toISOString() } : it) };
    }));
  }, []);

  const updateKaresDispatchFields = useCallback((woId, itemId, fields) => {
    setWorkOrders(p => p.map(wo => {
      if (wo.id !== woId) return wo;
      return { ...wo, items: wo.items.map(it => it.id === itemId ? { ...it, ...fields } : it) };
    }));
  }, []);

  const createKaresWaybill = useCallback((items) => {
    const waybill = {
      id: `IRS-K-${String(grindingQueue.length + 1).padStart(3, "0")}`,
      date: new Date().toISOString(), status: "sent",
      sender: MIHENG_INFO, receiver: KARES_INFO,
      items: items.map(it => ({
        itemId: it.id, woId: it.woId, productCode: it.productCode || `√ò${it.diameter}x${it.length}`,
        rawDiameter: it.diameter, toolDiameter: Number(it.grindDiameter) || it.diameter,
        grindLength: Number(it.grindLength) || it.length, grindTolerance: it.grindTolerance || "", qty: it.qty,
        toolCode: it.toolCode, productType: it.productType, materialCode: it.materialCode,
        customerName: it.customerName
      })),
    };
    setGrindingQueue(p => [...p, waybill]);
    items.forEach(it => {
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== it.woId) return wo;
        return { ...wo, currentStep: "grinding", items: wo.items.map(i => i.id === it.id ? { ...i, woStatus: "grinding_shipped", grindingDispatchId: waybill.id } : i) };
      }));
    });
  }, [grindingQueue]);

  const receiveKaresGrinding = useCallback((waybillId) => {
    setGrindingQueue(p => p.map(d => d.id === waybillId ? { ...d, status: "received" } : d));
    const wb = grindingQueue.find(d => d.id === waybillId); if (!wb) return;
    wb.items.forEach(it => {
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== it.woId) return wo;
        return { ...wo, items: wo.items.map(i => i.id === it.itemId ? { ...i, woStatus: "cut", grindingDone: true, grindingDate: new Date().toISOString() } : i) };
      }));
    });
  }, [grindingQueue]);

  const assignToMachine = useCallback((woId,itemId,machineId,operatorId,estMin)=>{
    setWorkOrders(p=>p.map(wo=>{
      if(wo.id!==woId) return wo;
      return {...wo,items:wo.items.map(it=>it.id===itemId?{...it,machineId,operatorId,woStatus:"assigned"}:it)};
    }));
    setProductionJobs(p=>[...p,{id:genId(),woId,itemId,machineId,operatorId,status:"assigned",startTime:null,endTime:null,estimatedMinutes:estMin||60,assignedAt:Date.now()}]);
  },[]);

  const startProduction = useCallback((jobId)=>{
    const now=new Date().toISOString();
    setProductionJobs(p=>p.map(j=>j.id===jobId?{...j,status:"running",startTime:now}:j));
    setWorkOrders(p=>p.map(wo=>({...wo,items:wo.items.map(it=>{const job=productionJobs.find(j=>j.id===jobId);if(job&&it.id===job.itemId) return{...it,woStatus:"running",startTime:now};return it;}),currentStep:"production"})));
  },[productionJobs]);

  const stopProduction = useCallback((jobId)=>{
    const now=new Date().toISOString();
    setProductionJobs(p=>p.map(j=>j.id===jobId?{...j,status:"completed",endTime:now}:j));
    setWorkOrders(p=>p.map(wo=>({...wo,items:wo.items.map(it=>{const job=productionJobs.find(j=>j.id===jobId);if(job&&it.id===job.itemId) return{...it,woStatus:"qc",endTime:now,qcChecks:it.qcChecks||{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false}};return it;}),currentStep:"qc"})));
  },[productionJobs]);

  //  DEFECT REPORTING 
  const reportDefect = useCallback((woId, itemId, rejectCount, reason, stage) => {
    setWorkOrders(p => p.map(wo => {
      if (wo.id !== woId) return wo;
      return { ...wo, items: wo.items.map(it => {
        if (it.id !== itemId) return it;
        const prevReject = Number(it.rejectQty) || 0;
        const newReject = prevReject + Number(rejectCount);
        const log = it.defectLog || [];
        return { ...it, rejectQty: newReject, defectLog: [...log, {
          date: new Date().toISOString(), qty: Number(rejectCount), reason, stage,
          reportedBy: currentUser?.name || "Bilinmiyor"
        }]};
      })};
    }));
  }, [currentUser]);

  const completeQC = useCallback((woId,itemId,checks)=>{
    setWorkOrders(p=>p.map(wo=>{if(wo.id!==woId) return wo;return{...wo,currentStep:"laser",items:wo.items.map(it=>it.id===itemId?{...it,qcChecks:checks,woStatus:"laser"}:it)};}));
  },[]);

  const completeLaser = useCallback((woId,itemId)=>{
    setWorkOrders(p=>p.map(wo=>{if(wo.id!==woId) return wo;return{...wo,currentStep:"coating",items:wo.items.map(it=>it.id===itemId?{...it,laserDone:true,woStatus:"coating_ready"}:it)};}));
  },[]);

  const sendToCoating = useCallback((woId,itemIds)=>{
    const wo=workOrders.find(w=>w.id===woId); if(!wo) return;
    const items=wo.items.filter(it=>itemIds.includes(it.id));
    const cc=[...COATING_COMPANIES_PRODUCTION,...COATING_COMPANIES_BILEME];
    const dispatch={id:`IRS-${Date.now()}`,woId,date:new Date().toISOString(),items:items.map(it=>({itemId:it.id,productCode:it.productCode||`√ò${it.diameter} ${it.islem||""}`,qty:it.qty,coatingType:it.coatingType,coatingCompanyId:it.coatingCompanyId})),coatingCompany:cc.find(c=>c.id===items[0]?.coatingCompanyId),status:"sent"};
    setCoatingQueue(p=>[...p,dispatch]);
    setWorkOrders(p=>p.map(w=>{if(w.id!==woId) return w;return{...w,currentStep:"coating",items:w.items.map(it=>itemIds.includes(it.id)?{...it,coatingSent:true,woStatus:"coating"}:it)};}));
  },[workOrders]);

  const receiveCoating = useCallback((dispatchId)=>{
    setCoatingQueue(p=>p.map(d=>d.id===dispatchId?{...d,status:"received"}:d));
    const dispatch=coatingQueue.find(d=>d.id===dispatchId); if(!dispatch) return;
    // Build lookup: woId ‚Üí [itemIds]
    const woItemMap={};
    dispatch.items.forEach(i=>{const wid=i.woId||dispatch.woId;if(wid){if(!woItemMap[wid])woItemMap[wid]=[];woItemMap[wid].push(i.itemId);}});
    setWorkOrders(p=>p.map(w=>{
      const ids=woItemMap[w.id]; if(!ids) return w;
      return{...w,currentStep:"shipping",items:w.items.map(it=>ids.includes(it.id)?{...it,coatingReceived:true,woStatus:"shipping"}:it)};
    }));
  },[coatingQueue]);

  const completeShipping = useCallback((woId)=>{
    setWorkOrders(p=>p.map(w=>{if(w.id!==woId) return w;return{...w,currentStep:"completed",status:"completed",items:w.items.map(it=>({...it,woStatus:"completed"}))};}));
    setOrders(p=>p.map(o=>{const wo=workOrders.find(w=>w.id===woId);if(wo&&o.id===wo.orderId) return{...o,status:"completed"};return o;}));
  },[workOrders]);

  const stats = useMemo(()=>{
    const t=orders.length, a=orders.filter(o=>o.status!=="completed"&&o.status!=="pending").length;
    const pend=orders.filter(o=>o.status==="pending").length;
    const pr=orders.filter(o=>o.orderType==="production").length;
    const bl=orders.filter(o=>o.orderType==="bileme").length;
    const run=productionJobs.filter(j=>j.status==="running").length;
    const ml=machines.map(m=>({...m,jobs:productionJobs.filter(j=>j.machineId===m.id&&j.status!=="completed"),done:productionJobs.filter(j=>j.machineId===m.id&&j.status==="completed")}));
    const cp=coatingQueue.filter(c=>c.status==="sent").length;
    const cutting=workOrders.filter(wo=>wo.orderType==="production").flatMap(wo=>wo.items).filter(it=>it.woStatus==="pending"||it.woStatus==="pending_stock").length;
    const grindPend=workOrders.flatMap(wo=>wo.items).filter(it=>["grinding","grinding_dispatch","grinding_shipped"].includes(it.woStatus)).length;
    return{total:t,active:a,pending:pend,production:pr,bileme:bl,running:run,machineLoad:ml,coatingPending:cp,cuttingPending:cutting,grindingPending:grindPend,purchasePending:purchaseRequests.filter(p=>p.status!=="received").length};
  },[orders,productionJobs,machines,coatingQueue,workOrders,purchaseRequests,grindingQueue]);

  //  LOGIN SCREEN 
  const [loginUser, setLoginUser] = useState("");
  const [loginPass, setLoginPass] = useState("");
  const [loginError, setLoginError] = useState("");
  if(!currentUser){
    const handleLogin = () => {
      const u = users.find(x => x.username === loginUser && x.password === loginPass);
      if(u) { setCurrentUser(u); setLoginError(""); setLoginUser(""); setLoginPass(""); }
      else setLoginError("Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±!");
    };
    return (
      <div style={{height:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"#0f1219",fontFamily:"'DM Sans',sans-serif"}}>
        <style>{`@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap');`}</style>
        <div style={{width:380,padding:32,borderRadius:20,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.08)"}}>
          <div style={{textAlign:"center",marginBottom:28}}>
            <div style={{width:56,height:56,borderRadius:14,background:"linear-gradient(135deg,#3b82f6,#8b5cf6)",display:"inline-flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:22,color:"#fff",marginBottom:12}}>M</div>
            <h2 style={{color:"#f1f5f9",margin:"8px 0 4px",fontSize:20}}>Mƒ∞HENK √úretim Takip</h2>
            <p style={{color:"#64748b",fontSize:13,margin:0}}>Kullanƒ±cƒ± adƒ± ve ≈üifrenizle giri≈ü yapƒ±n</p>
          </div>
          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            <div>
              <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>Kullanƒ±cƒ± Adƒ±</div>
              <input type="text" value={loginUser} onChange={e=>{setLoginUser(e.target.value);setLoginError("");}}
                onKeyDown={e=>e.key==="Enter"&&handleLogin()}
                placeholder="Kullanƒ±cƒ± adƒ±" style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:14,outline:"none",fontFamily:"inherit"}}/>
            </div>
            <div>
              <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>≈ûifre</div>
              <input type="password" value={loginPass} onChange={e=>{setLoginPass(e.target.value);setLoginError("");}}
                onKeyDown={e=>e.key==="Enter"&&handleLogin()}
                placeholder="≈ûifre" style={{width:"100%",padding:"10px 14px",borderRadius:10,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:14,outline:"none",fontFamily:"inherit"}}/>
            </div>
            {loginError&&<div style={{fontSize:12,color:"#ef4444",textAlign:"center"}}>{loginError}</div>}
            <button onClick={handleLogin} style={{padding:"10px 0",borderRadius:10,border:"none",background:"linear-gradient(135deg,#3b82f6,#6366f1)",color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:"inherit",marginTop:4}}>Giri≈ü Yap</button>
          </div>
        </div>
      </div>
    );
  }

  //  NAV 
  const navItems = [
    {key:"dashboard",label:"Panel",icon:Home,perm:null},
    {key:"orders",label:"Sipari≈üler",icon:Package,perm:"orders_view"},
    {key:"workorders",label:"ƒ∞≈ü Emirleri",icon:ClipboardList,perm:"workorders_view"},
    {key:"cutting",label:"Kesim",icon:Scissors,perm:"cutting_view"},
    {key:"grinding",label:"Ta≈ülama",icon:Wrench,perm:"grinding_view"},
    {key:"planning",label:"Planlama",icon:Calendar,perm:"planning_view"},
    {key:"production",label:"√úretim",icon:Factory,perm:"production_view"},
    {key:"qc",label:"Kalite Kontrol",icon:CheckCircle2,perm:"qc_view"},
    {key:"coating",label:"Kaplama",icon:Layers,perm:"coating_view"},
    {key:"shipping",label:"Sevkiyat",icon:Truck,perm:"shipping_view"},
    {key:"stock",label:"Hammadde Stok",icon:Box,perm:"stock_view"},
    {key:"purchasing",label:"Satƒ±n Alma",icon:ShoppingCart,perm:"purchasing_view"},
    {key:"machines",label:"Makinalar",icon:Monitor,perm:"machines_view"},
    {key:"operators",label:"Operat√∂rler",icon:Users,perm:"operators_view"},
    ...(hasPerm("admin")?[{key:"usermgmt",label:"Kullanƒ±cƒ± Y√∂netimi",icon:UserCog,perm:"admin"}]:[]),
  ].filter(n=>!n.perm||hasPerm(n.perm));

  const Sidebar = () => (
    <div style={{width:sideCollapsed?60:220,minWidth:sideCollapsed?60:220,height:"100vh",background:"linear-gradient(180deg,#0f1219 0%,#151b2b 100%)",borderRight:"1px solid rgba(255,255,255,0.06)",display:"flex",flexDirection:"column",transition:"all 0.2s",overflow:"hidden"}}>
      <div style={{padding:sideCollapsed?"16px 10px":"16px 20px",borderBottom:"1px solid rgba(255,255,255,0.06)",display:"flex",alignItems:"center",gap:10}}>
        <div style={{width:32,height:32,borderRadius:8,background:"linear-gradient(135deg,#3b82f6,#8b5cf6)",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:800,fontSize:14,color:"#fff",flexShrink:0}}>M</div>
        {!sideCollapsed&&<span style={{fontWeight:700,color:"#f1f5f9",fontSize:15}}>Mƒ∞HENK √úTS</span>}
      </div>
      <div style={{flex:1,padding:"8px",overflowY:"auto"}}>
        {navItems.map(item=>{const act=page===item.key;return(
          <div key={item.key} onClick={()=>setPage(item.key)} style={{display:"flex",alignItems:"center",gap:10,padding:sideCollapsed?"10px":"9px 14px",borderRadius:8,cursor:"pointer",marginBottom:2,justifyContent:sideCollapsed?"center":"flex-start",background:act?"rgba(59,130,246,0.15)":"transparent",color:act?"#60a5fa":"#94a3b8",transition:"all 0.15s"}}>
            <item.icon size={18}/>{!sideCollapsed&&<span style={{fontSize:13,fontWeight:act?600:500}}>{item.label}</span>}
          </div>
        );})}
      </div>
      <div style={{padding:"8px 12px",borderTop:"1px solid rgba(255,255,255,0.06)"}}>
        {!sideCollapsed&&(
          <div style={{display:"flex",alignItems:"center",gap:8,padding:"8px 4px",marginBottom:4}}>
            <div style={{width:28,height:28,borderRadius:7,background:"rgba(59,130,246,0.15)",display:"flex",alignItems:"center",justifyContent:"center",color:"#3b82f6",fontWeight:700,fontSize:12}}>{currentUser.avatar}</div>
            <div style={{flex:1,minWidth:0}}>
              <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{currentUser.name}</div>
              <div style={{fontSize:10,color:"#64748b"}}>{DEFAULT_ROLES[currentUser.role]?.label}</div>
            </div>
            <button onClick={()=>{setCurrentUser(null);localStorage.removeItem("mihenkCurrentUser");}} style={{background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:4}}><LogOut size={14}/></button>
          </div>
        )}
        <div onClick={()=>setSideCollapsed(!sideCollapsed)} style={{display:"flex",alignItems:"center",justifyContent:"center",padding:8,borderRadius:8,cursor:"pointer",color:"#64748b"}}>
          {sideCollapsed?<ChevronRight size={18}/>:<ChevronLeft size={18}/>}
        </div>
      </div>
    </div>
  );

  //  DASHBOARD 
  const Dashboard = () => (
    <div>
      <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>√úretim Paneli</h2>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:14,marginBottom:24}}>
        {[
          {l:"Toplam Sipari≈ü",v:stats.total,i:Package,c:"#6366f1"},
          {l:"√úretim",v:stats.production,i:Factory,c:"#3b82f6"},
          {l:"Bileme",v:stats.bileme,i:Wrench,c:"#f59e0b"},
          {l:"Aktif",v:stats.active,i:Play,c:"#10b981",s:`${stats.running} makine`},
          {l:"Bekleyen",v:stats.pending,i:Clock,c:"#94a3b8"},
          {l:"Kesim Bekleyen",v:stats.cuttingPending,i:Scissors,c:"#f59e0b"},
          {l:"Ta≈ülamada",v:stats.grindingPending,i:Wrench,c:"#d946ef"},
          {l:"Satƒ±n Alma",v:stats.purchasePending,i:ShoppingCart,c:"#ef4444"},
          {l:"Kaplamada",v:stats.coatingPending,i:Layers,c:"#14b8a6"},
        ].map((s,i)=>(
          <Card key={i} style={{display:"flex",alignItems:"center",gap:14,padding:16}}>
            <div style={{width:42,height:42,borderRadius:10,display:"flex",alignItems:"center",justifyContent:"center",background:`${s.c}22`,color:s.c}}><s.i size={20}/></div>
            <div><div style={{fontSize:22,fontWeight:700,color:"#f1f5f9",lineHeight:1.1}}>{s.v}</div><div style={{fontSize:11,color:"#94a3b8"}}>{s.l}</div>{s.s&&<div style={{fontSize:10,color:s.c}}>{s.s}</div>}</div>
          </Card>
        ))}
      </div>
      <Card>
        <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Makine Y√ºk√º</h3>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(200px,1fr))",gap:12}}>
          {stats.machineLoad.map(m=>(
            <div key={m.id} style={{padding:14,borderRadius:10,background:"rgba(255,255,255,0.03)",border:`1px solid ${m.jobs.length>0?"rgba(59,130,246,0.3)":"rgba(255,255,255,0.06)"}`}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{m.name}</span>
                <Badge color={m.jobs.length>0?"#3b82f6":"#10b981"} bg={m.jobs.length>0?"rgba(59,130,246,0.15)":"rgba(16,185,129,0.15)"}>{m.jobs.length>0?"Dolu":"Bo≈ü"}</Badge>
              </div>
              <div style={{fontSize:11,color:"#64748b"}}>Aktif: {m.jobs.length} | Biten: {m.done.length}</div>
              <div style={{marginTop:6,height:4,borderRadius:2,background:"rgba(255,255,255,0.06)"}}>
                <div style={{height:"100%",borderRadius:2,width:`${Math.min(m.jobs.length*33,100)}%`,background:m.jobs.length>2?"#ef4444":m.jobs.length>0?"#3b82f6":"#10b981"}}/>
              </div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );

  //  ORDERS PAGE 
  const OrdersPage = () => {
    const [showNew,setShowNew]=useState(false);
    const [orderType,setOrderType]=useState("production");
    const [currency,setCurrency]=useState("EUR");
    const emptyP={productType:"Std. Freze",toolCode:"",productCode:"",diameter:"",length:"",qty:"",unitPrice:"",coatingType:"",coatingCompanyId:"CK2",materialCode:"BE-1",grinding:false,grindingType:"",estimatedMinutes:"",pdfs:[]};
    const emptyB={diameter:"",islem:"",qty:"",unitPrice:"",coatingType:"",coatingCompanyId:"",estimatedMinutes:"",pdfs:[]};
    const [newOrder,setNewOrder]=useState({customerName:"",deliveryDate:"",priority:"normal",notes:"",items:[{...emptyP}]});
    const resetItems=t=>{setOrderType(t);setNewOrder(p=>({...p,items:[t==="production"?{...emptyP}:{...emptyB}]}));};
    const addItem=()=>setNewOrder(p=>({...p,items:[...p.items,orderType==="production"?{...emptyP}:{...emptyB}]}));
    const removeItem=i=>{if(newOrder.items.length<=1)return;setNewOrder(p=>({...p,items:p.items.filter((_,j)=>j!==i)}));};
    const updateItem=(i,f,v)=>{
      setNewOrder(p=>({...p,items:p.items.map((it,j)=>{
        if(j!==i) return it;
        const upd={...it,[f]:v};
        // Auto-clear coating type when company changes
        if(f==="coatingCompanyId"){
          const types=COATING_TYPES_BY_COMPANY[v]||[];
          if(!types.includes(upd.coatingType)) upd.coatingType=types[0]||"";
        }
        // Toggle grinding type
        if(f==="grinding"&&!v) upd.grindingType="";
        if(f==="grinding"&&v&&!upd.grindingType) upd.grindingType="Kares Ta≈ülama";
        return upd;
      })}));
    };
    const handlePdf=(idx,e)=>{
      const file=e.target.files?.[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=ev=>{
        const pdf={id:genId(),name:file.name,data:ev.target.result,stage:"Sipari≈ü",date:new Date().toISOString()};
        setNewOrder(p=>({...p,items:p.items.map((it,j)=>j===idx?{...it,pdfs:[...(it.pdfs||[]),pdf]}:it)}));
      };
      reader.readAsDataURL(file);
      e.target.value="";
    };
    const curSym=CURRENCIES.find(c=>c.value===currency)?.symbol||"‚Ç¨";
    const orderTotal=newOrder.items.reduce((s,i)=>s+(Number(i.qty||0)*Number(i.unitPrice||0)),0);
    const saveOrder=()=>{
      const order={id:`SIP-2026-${String(orders.length+1).padStart(3,"0")}`,customerId:genId(),customerName:newOrder.customerName,date:new Date().toISOString(),deliveryDate:newOrder.deliveryDate,status:"pending",priority:newOrder.priority,notes:newOrder.notes,orderType,currency,
        items:newOrder.items.map(it=>{const id=`I${genId()}`;if(orderType==="production") return{...it,id,productCode:`√ò${it.diameter}x${it.length}`,diameter:Number(it.diameter),length:Number(it.length),qty:Number(it.qty),unitPrice:Number(it.unitPrice),estimatedMinutes:Number(it.estimatedMinutes||0)};
        const nc=it.islem?.includes("Kaplama"); return{...it,id,diameter:Number(it.diameter),qty:Number(it.qty),unitPrice:Number(it.unitPrice),estimatedMinutes:Number(it.estimatedMinutes||0),coatingType:nc?it.coatingType:"",coatingCompanyId:nc?it.coatingCompanyId:""};})
      };
      setOrders(p=>[...p,order]);setShowNew(false);setNewOrder({customerName:"",deliveryDate:"",priority:"normal",notes:"",items:[{...emptyP}]});setOrderType("production");setCurrency("EUR");
    };
    const [filterType,setFilterType]=useState("all");
    const [fCust,setFCust]=useState("");
    const [fPriority,setFPriority]=useState("all");
    const [fDateY,setFDateY]=useState("");
    const [fDateM,setFDateM]=useState("");
    const [fDateD,setFDateD]=useState("");
    const [fStatus,setFStatus]=useState("all");
    const [fStep,setFStep]=useState("all");
    const [expandedOrders,setExpandedOrders]=useState({});
    const [showFilters,setShowFilters]=useState(false);
    const toggleOrder = id => setExpandedOrders(p=>({...p,[id]:!p[id]}));
    const ORDER_STEPS=[{k:"all",l:"T√ºm√º"},{k:"cutting",l:"Kesim"},{k:"grinding",l:"Ta≈ülama"},{k:"production",l:"√úretim"},{k:"qc",l:"Kalite Kontrol"},{k:"coating",l:"Kaplama"},{k:"shipping",l:"Sevkiyat"},{k:"completed",l:"Tamamlandƒ±"}];
    const filtered=orders.filter(o=>{
      if(filterType!=="all"&&o.orderType!==filterType) return false;
      if(fCust&&!o.customerName.toLowerCase().includes(fCust.toLowerCase())) return false;
      if(fPriority!=="all"&&o.priority!==fPriority) return false;
      if(fStatus!=="all"){
        const st=o.status==="completed"?"completed":o.status==="pending"?"pending":"active";
        if(fStatus!==st) return false;
      }
      if(fStep!=="all"){
        const wo=workOrders.find(w=>w.orderId===o.id);
        if(!wo) return fStep==="cutting"; // no WO = still at beginning
        const steps=wo.items.map(i=>i.woStatus);
        const match=fStep==="cutting"?steps.some(s=>["pending","pending_stock","cut"].includes(s))
          :fStep==="grinding"?steps.some(s=>["grinding","grinding_dispatch","grinding_shipped"].includes(s))
          :fStep==="production"?steps.some(s=>["assigned","running"].includes(s))
          :fStep==="completed"?steps.every(s=>s==="completed"||s==="shipping")
          :steps.some(s=>s===fStep||s===fStep+"_ready");
        if(!match) return false;
      }
      if(fDateY){
        const d=new Date(o.date);
        if(String(d.getFullYear())!==fDateY) return false;
        if(fDateM&&String(d.getMonth()+1).padStart(2,"0")!==fDateM) return false;
        if(fDateD&&String(d.getDate()).padStart(2,"0")!==fDateD) return false;
      }
      return true;
    });

    return (
      <div>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>Sipari≈üler</h2>
          <div style={{display:"flex",gap:8}}>
            <Btn variant="ghost" size="sm" icon={Filter} onClick={()=>setShowFilters(!showFilters)}>{showFilters?"Filtreleri Gizle":"Filtrele"}</Btn>
            {hasPerm("orders_edit")&&<Btn icon={Plus} onClick={()=>setShowNew(true)}>Yeni Sipari≈ü</Btn>}
          </div>
        </div>
        <div style={{display:"flex",gap:6,marginBottom:12}}>
          {[{k:"all",l:"T√ºm√º"},{k:"production",l:"√úretim"},{k:"bileme",l:"Bileme"}].map(f=>(
            <Btn key={f.k} variant={filterType===f.k?"primary":"ghost"} size="sm" onClick={()=>setFilterType(f.k)}>{f.l}</Btn>
          ))}
        </div>
        {showFilters&&<Card style={{marginBottom:14}}>
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(160px,1fr))",gap:10}}>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>M√º≈üteri</div><input type="text" value={fCust} onChange={e=>setFCust(e.target.value)} placeholder="M√º≈üteri ara..." style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>√ñncelik</div><select value={fPriority} onChange={e=>setFPriority(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="all">T√ºm√º</option><option value="urgent">Acil</option><option value="high">Y√ºksek</option><option value="normal">Normal</option><option value="low">D√º≈ü√ºk</option></select></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Durum</div><select value={fStatus} onChange={e=>setFStatus(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="all">T√ºm√º</option><option value="pending">Bekliyor</option><option value="active">Aktif</option><option value="completed">Tamamlandƒ±</option></select></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Konum</div><select value={fStep} onChange={e=>setFStep(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}>{ORDER_STEPS.map(s=><option key={s.k} value={s.k}>{s.l}</option>)}</select></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Yƒ±l</div><input type="text" value={fDateY} onChange={e=>setFDateY(e.target.value)} placeholder="2026" maxLength={4} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Ay</div><select value={fDateM} onChange={e=>setFDateM(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="">T√ºm√º</option>{["01","02","03","04","05","06","07","08","09","10","11","12"].map(m=><option key={m} value={m}>{m}</option>)}</select></div>
            <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>G√ºn</div><input type="text" value={fDateD} onChange={e=>setFDateD(e.target.value)} placeholder="15" maxLength={2} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
          </div>
          {(fCust||fPriority!=="all"||fDateY||fDateM||fDateD||fStatus!=="all"||fStep!=="all")&&<div style={{marginTop:8}}><Btn variant="ghost" size="sm" onClick={()=>{setFCust("");setFPriority("all");setFDateY("");setFDateM("");setFDateD("");setFStatus("all");setFStep("all");}}>Filtreleri Temizle</Btn></div>}
        </Card>}
        <Card>
          <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse"}}>
              <thead>
                <tr style={{borderBottom:"1px solid rgba(255,255,255,0.08)"}}>
                  {["","No","T√ºr","M√º≈üteri","Tarih","Termin","Kalem",canPrice&&"Tutar","√ñncelik","Durum","ƒ∞≈ülem"].filter(Boolean).map(h=>(
                    <th key={h} style={{padding:"10px 12px",textAlign:"left",fontSize:11,color:"#64748b",fontWeight:600,textTransform:"uppercase",letterSpacing:.5,width:h===""?30:undefined}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {filtered.map(order=>{
                  const total=order.items.reduce((s,i)=>s+(i.qty*(i.unitPrice||0)),0);
                  const expanded=expandedOrders[order.id];
                  const wo=workOrders.find(w=>w.orderId===order.id);
                  return(
                    <React.Fragment key={order.id}>
                    <tr style={{borderBottom:"1px solid rgba(255,255,255,0.04)",cursor:"pointer",background:expanded?"rgba(59,130,246,0.04)":"transparent"}} onClick={()=>order.items.length>0&&toggleOrder(order.id)}>
                      <td style={{padding:"10px 8px",fontSize:12,color:"#64748b",textAlign:"center"}}>{order.items.length>1&&(expanded?<ChevronDown size={14}/>:<ChevronRight size={14}/>)}</td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#e2e8f0",fontWeight:600}}>{order.id}</td>
                      <td style={{padding:"10px 12px"}}><OrderTypeBadge type={order.orderType}/></td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>{order.customerName}</td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>{fmtDate(order.date)}</td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>{fmtDate(order.deliveryDate)}</td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>{order.items.length}</td>
                      {canPrice&&<td style={{padding:"10px 12px",fontSize:13,color:"#10b981",fontWeight:600}}>{fmtMoney(total,order.currency)}</td>}
                      <td style={{padding:"10px 12px"}}><PriorityBadge priority={order.priority}/></td>
                      <td style={{padding:"10px 12px"}}><StatusBadge status={order.status==="completed"?"completed":order.status==="pending"?"pending":"active"}/></td>
                      <td style={{padding:"10px 12px"}} onClick={e=>e.stopPropagation()}>
                        <div style={{display:"flex",gap:4}}>
                          <Btn variant="ghost" size="sm" icon={Eye} onClick={()=>setModal({type:"orderDetail",order})}>Detay</Btn>
                          {order.status==="pending"&&hasPerm("workorders_edit")&&<Btn variant="success" size="sm" icon={ClipboardList} onClick={()=>generateWorkOrder(order)}>ƒ∞≈ü Emri</Btn>}
                          {hasPerm("orders_edit")&&<Btn variant="danger" size="sm" icon={Trash2} onClick={()=>setConfirmDel({type:"order",id:order.id,label:order.id+" ‚Äî "+order.customerName})}/>}
                        </div>
                      </td>
                    </tr>
                    {expanded&&order.items.map(item=>{
                      const woItem=wo?.items.find(i=>i.id===item.id);
                      return(
                        <tr key={item.id} style={{borderBottom:"1px solid rgba(255,255,255,0.02)",background:"rgba(255,255,255,0.015)"}}>
                          <td style={{padding:"6px 8px"}}/>
                          <td colSpan={2} style={{padding:"6px 12px",fontSize:12,color:"#e2e8f0"}}>
                            {order.orderType==="production"?`${item.productCode} (${item.productType||""})`:`√ò${item.diameter}mm ${item.islem||""}`}
                          </td>
                          <td style={{padding:"6px 12px",fontSize:12,color:"#94a3b8"}}>{item.qty} ad</td>
                          <td colSpan={2} style={{padding:"6px 12px",fontSize:12}}>
                            {item.coatingType&&<Badge color="#14b8a6" bg="rgba(20,184,166,0.12)">{item.coatingType}</Badge>}
                            {item.materialCode&&<span style={{fontSize:11,color:"#64748b",marginLeft:6}}>{item.materialCode}</span>}
                          </td>
                          <td style={{padding:"6px 12px",fontSize:12,color:"#94a3b8"}}>{item.estimatedMinutes?`${item.estimatedMinutes}dk`:""}</td>
                          {canPrice&&<td style={{padding:"6px 12px",fontSize:12,color:"#10b981"}}>{fmtMoney(item.qty*(item.unitPrice||0),order.currency)}</td>}
                          <td colSpan={2} style={{padding:"6px 12px"}}>
                            {woItem&&(()=>{
                              const st=woItem.woStatus;
                              const label=st==="completed"?"‚úì Tamamlandƒ±":st==="running"?"üîÑ √úretimde":st==="assigned"?"üìã Atandƒ±":st==="pending"?"‚è≥ Bekliyor":st==="pending_stock"?"üì¶ Stok Bekleniyor":st==="cut"?"‚úÇÔ∏è Kesildi":st==="grinding"?"üîß Ta≈ülamada":st==="grinding_dispatch"?"üîß Kares Sevk Bekl.":st==="grinding_shipped"?"üì¶ Kares'te":st==="qc"?"üîç Kalite Kontrol":st==="qc_ready"?"‚úì KK Tamam":st==="coating"?"üé® Kaplamada":st==="coating_ready"?"‚úì Kaplama Tamam":st==="shipping"?"üöö Sevkiyatta":st;
                              const color=st==="completed"?"#10b981":st==="running"?"#3b82f6":(st==="assigned"||st==="cut")?"#8b5cf6":(st==="grinding"||st==="grinding_dispatch"||st==="grinding_shipped")?"#d946ef":st==="qc"||st==="qc_ready"?"#14b8a6":"#f59e0b";
                              return <Badge color={color} bg={color+"20"}>{label}</Badge>;
                            })()}
                            {!woItem&&<span style={{fontSize:11,color:"#64748b"}}>ƒ∞≈ü emri yok</span>}
                          </td>
                          <td/>
                        </tr>
                      );
                    })}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>
        </Card>

        {/* NEW ORDER MODAL */}
        {showNew&&(
          <Modal title="Yeni Sipari≈ü" onClose={()=>{setShowNew(false);resetItems("production");}} width={960}>
            <div style={{marginBottom:18}}><TabSwitcher tabs={[{key:"production",label:"√úretim",icon:Factory,color:"#6366f1"},{key:"bileme",label:"Bileme",icon:Wrench,color:"#f59e0b"}]} active={orderType} onChange={resetItems}/></div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:12,marginBottom:14}}>
              <Input label="M√º≈üteri Adƒ±" value={newOrder.customerName} onChange={v=>setNewOrder(p=>({...p,customerName:v}))} placeholder="M√º≈üteri"/>
              <Input label="Termin Tarihi" type="date" value={newOrder.deliveryDate} onChange={v=>setNewOrder(p=>({...p,deliveryDate:v}))}/>
              <Input label="√ñncelik" value={newOrder.priority} onChange={v=>setNewOrder(p=>({...p,priority:v}))} options={[{value:"urgent",label:"Acil"},{value:"high",label:"Y√ºksek"},{value:"normal",label:"Normal"},{value:"low",label:"D√º≈ü√ºk"}]}/>
              <Input label="Para Birimi" value={currency} onChange={setCurrency} options={CURRENCIES.map(c=>({value:c.value,label:c.label}))}/>
            </div>
            <Input label="Notlar" value={newOrder.notes} onChange={v=>setNewOrder(p=>({...p,notes:v}))} rows={2} placeholder="Sipari≈ü notlarƒ±..." style={{marginBottom:14}}/>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <h4 style={{color:"#e2e8f0",margin:0}}>{orderType==="production"?"üè≠ √úretim Kalemleri":"üîß Bileme Kalemleri"}</h4>
              {canPrice&&<span style={{fontSize:13,color:"#64748b"}}>Toplam: <strong style={{color:"#10b981"}}>{curSym}{orderTotal.toFixed(2)}</strong></span>}
            </div>
            {newOrder.items.map((item,idx)=>(
              <div key={idx} style={{padding:14,borderRadius:10,background:"rgba(255,255,255,0.02)",border:`1px solid ${orderType==="production"?"rgba(99,102,241,0.15)":"rgba(245,158,11,0.15)"}`,marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                  <span style={{fontSize:12,fontWeight:700,color:orderType==="production"?"#6366f1":"#f59e0b"}}>Kalem #{idx+1}</span>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    {canPrice&&item.qty&&item.unitPrice&&<span style={{fontSize:12,color:"#10b981",fontWeight:600}}>{curSym}{(Number(item.qty)*Number(item.unitPrice)).toFixed(2)}</span>}
                    {newOrder.items.length>1&&<button onClick={()=>removeItem(idx)} style={{background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:6,padding:"3px 8px",cursor:"pointer",color:"#ef4444",fontSize:11,fontWeight:600}}>‚úï</button>}
                  </div>
                </div>
                {orderType==="production"?(
                  <>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:8}}>
                      <div>
                        <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>√úr√ºn Tipi</div>
                        <div style={{display:"flex",gap:4}}>
                          <select value={PRODUCT_TYPES.includes(item.productType)?item.productType:"__custom__"} onChange={e=>{const v=e.target.value;if(v==="__custom__") updateItem(idx,"productType","");else updateItem(idx,"productType",v);}} style={{flex:1,padding:"7px 10px",borderRadius:8,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit"}}>
                            {PRODUCT_TYPES.map(t=><option key={t} value={t} style={{background:"#1e293b"}}>{t}</option>)}
                            <option value="__custom__" style={{background:"#1e293b"}}>‚Äî Diƒüer (Manuel) ‚Äî</option>
                          </select>
                          {!PRODUCT_TYPES.includes(item.productType)&&<input value={item.productType} onChange={e=>updateItem(idx,"productType",e.target.value)} placeholder="√úr√ºn tipi yazƒ±n..." style={{flex:1,padding:"7px 10px",borderRadius:8,border:"1px solid rgba(245,158,11,0.3)",background:"rgba(245,158,11,0.06)",color:"#f59e0b",fontSize:13,fontFamily:"inherit",outline:"none"}}/>}
                        </div>
                      </div>
                      <Input label="Takƒ±m Kodu" value={item.toolCode||""} onChange={v=>updateItem(idx,"toolCode",v)} placeholder="Takƒ±m kodunu girin..."/>
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:"80px 80px 80px 1fr",gap:10,marginBottom:8}}>
                      <Input label="√áap (mm)" type="number" value={item.diameter} onChange={v=>updateItem(idx,"diameter",v)} placeholder="6"/>
                      <Input label="Boy (mm)" type="number" value={item.length} onChange={v=>updateItem(idx,"length",v)} placeholder="75"/>
                      <Input label="Adet" type="number" value={item.qty} onChange={v=>updateItem(idx,"qty",v)} placeholder="500"/>
                      <div>
                        <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>Hammadde Kodu</div>
                        <div style={{display:"flex",alignItems:"center",gap:6}}>
                          <select value={item.materialCode} onChange={e=>updateItem(idx,"materialCode",e.target.value)} style={{flex:1,padding:"7px 10px",borderRadius:8,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit"}}>
                            {MATERIAL_CODES.map(m=><option key={m.value} value={m.value} style={{background:"#1e293b"}}>{m.label}</option>)}
                          </select>
                          {(()=>{const mc=MATERIAL_CODES.find(m=>m.value===item.materialCode);return mc?.color?<div style={{width:14,height:14,borderRadius:4,background:mc.color,border:"1px solid rgba(255,255,255,0.2)",flexShrink:0}}/>:null;})()}
                        </div>
                      </div>
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:8}}>
                      <Input label="Kaplama Firmasƒ±" value={item.coatingCompanyId} onChange={v=>updateItem(idx,"coatingCompanyId",v)} options={COATING_COMPANIES_PRODUCTION.map(c=>({value:c.id,label:c.name}))}/>
                      <Input label="Kaplama T√ºr√º" value={item.coatingType} onChange={v=>updateItem(idx,"coatingType",v)} options={(COATING_TYPES_BY_COMPANY[item.coatingCompanyId]||[]).map(c=>({value:c,label:c}))}/>
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:canPrice?"1fr 1fr 1fr 1fr":"1fr 1fr 1fr",gap:10,marginBottom:8}}>
                      {canPrice&&<Input label={`Birim Fiyat (${curSym})`} type="number" value={item.unitPrice} onChange={v=>updateItem(idx,"unitPrice",v)} placeholder="3.50" step="0.01"/>}
                      <Input label="Tah. Birim S√ºre (dk)" type="number" value={item.estimatedMinutes} onChange={v=>updateItem(idx,"estimatedMinutes",v)} placeholder="2"/>
                      <div style={{display:"flex",flexDirection:"column"}}>
                        <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>Toplam S√ºre</div>
                        <div style={{padding:"7px 10px",borderRadius:8,background:"rgba(59,130,246,0.06)",border:"1px solid rgba(59,130,246,0.15)",fontSize:13,fontWeight:700,color:"#3b82f6",height:34,display:"flex",alignItems:"center"}}>
                          {Number(item.qty||0)*Number(item.estimatedMinutes||0)} dk
                        </div>
                      </div>
                      <div style={{display:"flex",alignItems:"flex-end",gap:8,flexWrap:"wrap",paddingBottom:2}}>
                        <label style={{display:"flex",alignItems:"center",gap:6,fontSize:13,color:"#94a3b8",cursor:"pointer"}}><input type="checkbox" checked={!!item.grinding} onChange={e=>updateItem(idx,"grinding",e.target.checked)}/> Ta≈ülama</label>
                        {item.grinding&&(
                          <div style={{display:"flex",gap:4}}>
                            {GRINDING_TYPES.map(gt=>(
                              <button key={gt} onClick={()=>updateItem(idx,"grindingType",gt)} style={{
                                padding:"4px 10px",borderRadius:6,fontSize:11,fontWeight:600,cursor:"pointer",
                                border:`1px solid ${item.grindingType===gt?"rgba(59,130,246,0.5)":"rgba(255,255,255,0.1)"}`,
                                background:item.grindingType===gt?"rgba(59,130,246,0.15)":"rgba(255,255,255,0.03)",
                                color:item.grindingType===gt?"#3b82f6":"#94a3b8",fontFamily:"inherit"
                              }}>{gt}</button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                      <Input label="üìé Teknik PDF" accept=".pdf" onFileChange={e=>handlePdf(idx,e)} style={{minWidth:160}}/>
                      {(item.pdfs||[]).map(pdf=><button key={pdf.id} onClick={()=>setPdfViewer({name:pdf.name,data:pdf.data})} style={{display:"inline-flex",alignItems:"center",gap:3,padding:"2px 8px",borderRadius:5,fontSize:11,fontWeight:600,color:"#3b82f6",background:"rgba(59,130,246,0.1)",border:"none",cursor:"pointer"}}><File size={10}/>{pdf.name}</button>)}
                    </div>
                  </>
                ):(
                  <>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 2fr 1fr 1fr",gap:10,marginBottom:8}}>
                      <Input label="√áap (mm)" type="number" value={item.diameter} onChange={v=>updateItem(idx,"diameter",v)} placeholder="6"/>
                      <Input label="Yapƒ±lacak ƒ∞≈ülem" value={item.islem} onChange={v=>{updateItem(idx,"islem",v);if(!v.includes("Kaplama")){updateItem(idx,"coatingType","");updateItem(idx,"coatingCompanyId","");}else if(!item.coatingType){updateItem(idx,"coatingCompanyId","CK2");updateItem(idx,"coatingType","ALTƒ∞N");}}} options={BILEME_ISLEMLERI.map(b=>({value:b,label:b}))}/>
                      <Input label="Adet" type="number" value={item.qty} onChange={v=>updateItem(idx,"qty",v)} placeholder="100"/>
                      <Input label="Tahmini S√ºre (dk)" type="number" value={item.estimatedMinutes} onChange={v=>updateItem(idx,"estimatedMinutes",v)} placeholder="60"/>
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:canPrice?"1fr 1fr 1fr":"1fr 1fr",gap:10,marginBottom:8}}>
                      {canPrice&&<Input label={`Birim Fiyat (${curSym})`} type="number" value={item.unitPrice} onChange={v=>updateItem(idx,"unitPrice",v)} placeholder="2.50" step="0.01"/>}
                      {item.islem?.includes("Kaplama")&&<><Input label="Kaplama Firmasƒ±" value={item.coatingCompanyId} onChange={v=>{updateItem(idx,"coatingCompanyId",v);const types=COATING_TYPES_BY_COMPANY[v]||[];if(!types.includes(item.coatingType))updateItem(idx,"coatingType",types[0]||"");}} options={COATING_COMPANIES_BILEME.map(c=>({value:c.id,label:c.name}))}/><Input label="Kaplama T√ºr√º" value={item.coatingType} onChange={v=>updateItem(idx,"coatingType",v)} options={(COATING_TYPES_BY_COMPANY[item.coatingCompanyId]||COATING_TYPES_BILEME).map(c=>({value:c,label:c}))}/></>}
                    </div>
                    <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                      <Input label="üìé Teknik PDF" accept=".pdf" onFileChange={e=>handlePdf(idx,e)} style={{minWidth:160}}/>
                      {(item.pdfs||[]).map(pdf=><button key={pdf.id} onClick={()=>setPdfViewer({name:pdf.name,data:pdf.data})} style={{display:"inline-flex",alignItems:"center",gap:3,padding:"2px 8px",borderRadius:5,fontSize:11,fontWeight:600,color:"#3b82f6",background:"rgba(59,130,246,0.1)",border:"none",cursor:"pointer"}}><File size={10}/>{pdf.name}</button>)}
                    </div>
                  </>
                )}
              </div>
            ))}
            <div style={{display:"flex",gap:10,marginTop:12,alignItems:"center"}}>
              <Btn variant="ghost" size="sm" icon={Plus} onClick={addItem}>Kalem Ekle</Btn>
              {canPrice&&<div style={{flex:1,textAlign:"right"}}><span style={{fontSize:15,fontWeight:700,color:"#e2e8f0"}}>Toplam: <span style={{color:"#10b981"}}>{curSym}{orderTotal.toFixed(2)}</span></span></div>}
            </div>
            <div style={{display:"flex",gap:10,marginTop:16,justifyContent:"flex-end"}}>
              <Btn variant="ghost" onClick={()=>{setShowNew(false);resetItems("production");}}>ƒ∞ptal</Btn>
              <Btn icon={Save} onClick={saveOrder} disabled={!newOrder.customerName||!newOrder.deliveryDate||newOrder.items.some(i=>!i.qty)}>Kaydet</Btn>
            </div>
          </Modal>
        )}

        {/* ORDER DETAIL */}
        {modal?.type==="orderDetail"&&(
          <Modal title={`Sipari≈ü ‚Äî ${modal.order.id}`} onClose={()=>setModal(null)} width={850}>
            <div style={{display:"flex",gap:8,marginBottom:14}}><OrderTypeBadge type={modal.order.orderType}/><PriorityBadge priority={modal.order.priority}/><StatusBadge status={modal.order.status==="completed"?"completed":modal.order.status==="pending"?"pending":"active"}/></div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:16,marginBottom:16}}>
              <div><span style={{fontSize:11,color:"#64748b"}}>M√º≈üteri</span><div style={{fontSize:14,color:"#e2e8f0",fontWeight:600}}>{modal.order.customerName}</div></div>
              <div><span style={{fontSize:11,color:"#64748b"}}>Sipari≈ü</span><div style={{fontSize:14,color:"#e2e8f0"}}>{fmtDate(modal.order.date)}</div></div>
              <div><span style={{fontSize:11,color:"#64748b"}}>Termin</span><div style={{fontSize:14,color:"#e2e8f0"}}>{fmtDate(modal.order.deliveryDate)}</div></div>
            </div>
            <h4 style={{color:"#e2e8f0",marginBottom:10}}>Kalemler</h4>
            {modal.order.items.map(item=>{
              const lt=(item.qty||0)*(item.unitPrice||0);
              const cc=[...COATING_COMPANIES_PRODUCTION,...COATING_COMPANIES_BILEME].find(c=>c.id===item.coatingCompanyId);
              return(
                <div key={item.id} style={{padding:14,borderRadius:10,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:8}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div>
                      {modal.order.orderType==="production"?<><span style={{fontSize:14,fontWeight:600,color:"#e2e8f0"}}>{item.productCode}</span>{item.productType&&<span style={{fontSize:11,color:"#6366f1",marginLeft:8,padding:"1px 6px",borderRadius:4,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}{item.toolCode&&<span style={{fontSize:11,color:"#f59e0b",marginLeft:6,fontWeight:600}}>{item.toolCode}</span>}<span style={{fontSize:12,color:"#64748b",marginLeft:8}}>√ò{item.diameter}x{item.length}</span></>
                      :<><span style={{fontSize:14,fontWeight:600,color:"#e2e8f0"}}>√ò{item.diameter}mm</span><span style={{fontSize:12,color:"#f59e0b",marginLeft:8}}>{item.islem}</span></>}
                      {item.estimatedMinutes>0&&<span style={{fontSize:11,color:"#3b82f6",marginLeft:8}}>‚è± {item.estimatedMinutes} dk</span>}
                    </div>
                    {canPrice&&<div style={{textAlign:"right"}}><div style={{fontSize:12,color:"#64748b"}}>{item.qty} ad √ó {fmtMoney(item.unitPrice,modal.order.currency)}</div><div style={{fontSize:14,fontWeight:700,color:"#10b981"}}>{fmtMoney(lt,modal.order.currency)}</div></div>}
                    {!canPrice&&<span style={{fontSize:13,color:"#94a3b8"}}>{item.qty} ad</span>}
                  </div>
                  {Number(item.rejectQty||0)>0&&<div style={{marginTop:6,padding:8,borderRadius:6,background:"rgba(239,68,68,0.06)",border:"1px solid rgba(239,68,68,0.15)",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                      <div style={{fontSize:12}}>
                        <span style={{color:"#ef4444",fontWeight:700}}>üî¥ {item.rejectQty} fire</span>
                        <span style={{color:"#94a3b8",margin:"0 6px"}}>‚Üí</span>
                        <span style={{color:"#10b981",fontWeight:700}}>Teslim: {item.qty-Number(item.rejectQty||0)}</span>
                        <span style={{color:"#64748b"}}>/{item.qty} ad</span>
                      </div>
                      {item.defectLog&&item.defectLog.length>0&&<span style={{fontSize:10,color:"#64748b"}}>{item.defectLog.length} kayƒ±t</span>}
                    </div>}
                  <div style={{display:"flex",gap:8,marginTop:8,flexWrap:"wrap",alignItems:"center"}}>
                    {item.materialCode&&(()=>{const mc=MATERIAL_CODES.find(m=>m.value===item.materialCode);return mc?<Badge color={mc.color||"#94a3b8"} bg={`${mc.color||"#94a3b8"}22`}><span style={{display:"inline-block",width:8,height:8,borderRadius:2,background:mc.color,marginRight:4}}></span>{mc.value}</Badge>:item.materialCode?<Badge color="#94a3b8" bg="rgba(148,163,184,0.15)">{item.materialCode}</Badge>:null;})()}
                    {item.coatingType&&<Badge color="#14b8a6" bg="rgba(20,184,166,0.15)">{item.coatingType}</Badge>}
                    {cc&&<span style={{fontSize:11,color:"#94a3b8"}}>‚Üí {cc.name}</span>}
                    {item.grinding&&<Badge color="#a855f7" bg="rgba(168,85,247,0.15)">{item.grindingType||"Ta≈ülama"}</Badge>}
                  </div>
                  <div style={{marginTop:8}}>
                    <PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("orders_edit")} onUpload={f=>addPdfToOrderItem(modal.order.id,item.id,f)}/>
                  </div>
                </div>
              );
            })}
            {canPrice&&<div style={{textAlign:"right",marginTop:12,padding:"12px 0",borderTop:"1px solid rgba(255,255,255,0.08)"}}><span style={{fontSize:16,fontWeight:700,color:"#e2e8f0"}}>Toplam: <span style={{color:"#10b981"}}>{fmtMoney(modal.order.items.reduce((s,i)=>s+(i.qty*(i.unitPrice||0)),0),modal.order.currency)}</span></span></div>}
            {hasPerm("orders_edit")&&<div style={{marginTop:12,paddingTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",display:"flex",justifyContent:"flex-end"}}><Btn variant="danger" size="sm" icon={Trash2} onClick={()=>setConfirmDel({type:"order",id:modal.order.id,label:modal.order.id+" ‚Äî "+modal.order.customerName})}>Sipari≈üi Sil</Btn></div>}
          </Modal>
        )}
      </div>
    );
  };

  //  WORK ORDERS 
  const WorkOrdersPage = () => {
    const [wfCust,setWfCust]=useState("");
    const [wfType,setWfType]=useState("all");
    const [wfPriority,setWfPriority]=useState("all");
    const [wfDateY,setWfDateY]=useState("");
    const [wfDateM,setWfDateM]=useState("");
    const [wfDateD,setWfDateD]=useState("");
    const [wfStep,setWfStep]=useState("all");
    const [wfShow,setWfShow]=useState(false);
    const WO_STEPS=[{k:"all",l:"T√ºm√º"},{k:"cutting",l:"Kesim"},{k:"grinding",l:"Ta≈ülama"},{k:"production",l:"√úretim"},{k:"qc",l:"KK"},{k:"laser",l:"Lazer"},{k:"coating",l:"Kaplama"},{k:"shipping",l:"Sevkiyat"}];
    const filteredWO=workOrders.filter(wo=>{
      if(wfType!=="all"&&wo.orderType!==wfType) return false;
      if(wfCust&&!wo.customerName.toLowerCase().includes(wfCust.toLowerCase())) return false;
      if(wfPriority!=="all"&&wo.priority!==wfPriority) return false;
      if(wfStep!=="all"){
        const steps=wo.items.map(i=>i.woStatus);
        const match=wfStep==="cutting"?steps.some(s=>["pending","pending_stock","cut"].includes(s))
          :wfStep==="grinding"?steps.some(s=>["grinding","grinding_dispatch","grinding_shipped"].includes(s))
          :wfStep==="production"?steps.some(s=>["assigned","running"].includes(s))
          :steps.some(s=>s===wfStep||s===wfStep+"_ready");
        if(!match) return false;
      }
      if(wfDateY){
        const d=new Date(wo.deliveryDate);
        if(String(d.getFullYear())!==wfDateY) return false;
        if(wfDateM&&String(d.getMonth()+1).padStart(2,"0")!==wfDateM) return false;
        if(wfDateD&&String(d.getDate()).padStart(2,"0")!==wfDateD) return false;
      }
      return true;
    });
    return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
        <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>ƒ∞≈ü Emirleri ({filteredWO.length})</h2>
        <Btn variant="ghost" size="sm" icon={Filter} onClick={()=>setWfShow(!wfShow)}>{wfShow?"Gizle":"Filtrele"}</Btn>
      </div>
      {wfShow&&<Card style={{marginBottom:14}}>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(150px,1fr))",gap:10}}>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>M√º≈üteri</div><input type="text" value={wfCust} onChange={e=>setWfCust(e.target.value)} placeholder="M√º≈üteri ara..." style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>T√ºr</div><select value={wfType} onChange={e=>setWfType(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="all">T√ºm√º</option><option value="production">√úretim</option><option value="bileme">Bileme</option></select></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>√ñncelik</div><select value={wfPriority} onChange={e=>setWfPriority(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="all">T√ºm√º</option><option value="urgent">Acil</option><option value="high">Y√ºksek</option><option value="normal">Normal</option><option value="low">D√º≈ü√ºk</option></select></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Konum</div><select value={wfStep} onChange={e=>setWfStep(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}>{WO_STEPS.map(s=><option key={s.k} value={s.k}>{s.l}</option>)}</select></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Yƒ±l</div><input type="text" value={wfDateY} onChange={e=>setWfDateY(e.target.value)} placeholder="2026" maxLength={4} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>Ay</div><select value={wfDateM} onChange={e=>setWfDateM(e.target.value)} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"#1e293b",color:"#e2e8f0",fontSize:12}}><option value="">T√ºm√º</option>{["01","02","03","04","05","06","07","08","09","10","11","12"].map(m=><option key={m} value={m}>{m}</option>)}</select></div>
          <div><div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:3}}>G√ºn</div><input type="text" value={wfDateD} onChange={e=>setWfDateD(e.target.value)} placeholder="15" maxLength={2} style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#e2e8f0",fontSize:12,fontFamily:"inherit"}}/></div>
        </div>
        {(wfCust||wfType!=="all"||wfPriority!=="all"||wfStep!=="all"||wfDateY)&&<div style={{marginTop:8}}><Btn variant="ghost" size="sm" onClick={()=>{setWfCust("");setWfType("all");setWfPriority("all");setWfStep("all");setWfDateY("");setWfDateM("");setWfDateD("");}}>Filtreleri Temizle</Btn></div>}
      </Card>}
      {filteredWO.length===0?(
        <Card style={{textAlign:"center",padding:40}}><ClipboardList size={40} color="#475569" style={{marginBottom:12}}/><div style={{color:"#64748b",fontSize:14}}>E≈üle≈üen i≈ü emri yok.</div></Card>
      ):(
        filteredWO.map(wo=>(
          <Card key={wo.id} style={{marginBottom:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}><button onClick={()=>setWoDetail(wo)} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:700,fontSize:15,textDecoration:"underline",fontFamily:"inherit"}}>{wo.id}</button><OrderTypeBadge type={wo.orderType}/><Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{wo.customerName}</Badge><PriorityBadge priority={wo.priority}/></div>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:12,color:"#64748b"}}>Termin: {fmtDate(wo.deliveryDate)}</span>
                {hasPerm("workorders_edit")&&<Btn variant="danger" size="sm" icon={Trash2} onClick={()=>setConfirmDel({type:"wo",id:wo.id,label:wo.id+" ‚Äî "+wo.customerName})}/>}
              </div>
            </div>
            <WorkflowProgress currentStep={wo.currentStep} orderType={wo.orderType}/>
            <div style={{marginTop:10}}>
              {wo.items.map(item=>(
                <div key={item.id} style={{padding:10,borderRadius:8,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:5}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                      <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{wo.orderType==="production"?item.productCode:`√ò${item.diameter} ${item.islem||""}`}</span>
                      {(Number(item.rejectQty)||0)>0?(
                        <span style={{fontSize:12}}>
                          <span style={{color:"#10b981",fontWeight:700}}>{item.qty-(Number(item.rejectQty)||0)}</span>
                          <span style={{color:"#64748b"}}>/{item.qty} ad</span>
                          <span style={{color:"#ef4444",fontSize:11,marginLeft:2}}>({item.rejectQty} fire)</span>
                        </span>
                      ):(
                        <span style={{fontSize:12,color:"#64748b"}}>{item.qty} ad</span>
                      )}
                      {item.estimatedMinutes>0&&<span style={{fontSize:11,color:"#3b82f6"}}>‚è± {item.estimatedMinutes}dk</span>}
                      {item.machineId&&<span style={{fontSize:11,color:"#3b82f6"}}>üìç {machines.find(m=>m.id===item.machineId)?.name}</span>}
                      {item.operatorId&&<span style={{fontSize:11,color:"#94a3b8"}}>üë§ {operators.find(o=>o.id===item.operatorId)?.name}</span>}
                    </div>
                    <div style={{display:"flex",gap:6,alignItems:"center"}}>
                      <Badge color={STATUS_MAP[item.woStatus==="running"?"active":item.woStatus==="completed"?"completed":"pending"]?.color||"#94a3b8"} bg={STATUS_MAP[item.woStatus==="running"?"active":item.woStatus==="completed"?"completed":"pending"]?.bg||"rgba(148,163,184,0.15)"}>{item.woStatus}</Badge>
                      {(item.woStatus==="cut"||(wo.orderType==="bileme"&&item.woStatus==="pending"))&&hasPerm("planning_edit")&&<Btn variant="primary" size="sm" onClick={()=>setModal({type:"assign",woId:wo.id,itemId:item.id,estMin:item.estimatedMinutes||60})}>Atama</Btn>}
                    </div>
                  </div>
                  <div style={{marginTop:6}}><PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("workorders_edit")} onUpload={f=>addPdfToWoItem(wo.id,item.id,f,"ƒ∞≈ü Emri")}/></div>
                </div>
              ))}
            </div>
          </Card>
        ))
      )}
      {modal?.type==="assign"&&<Modal title="Makine & Operat√∂r Atama" onClose={()=>setModal(null)} width={500}><AssignForm woId={modal.woId} itemId={modal.itemId} estMin={modal.estMin} machines={machines} operators={operators} productionJobs={productionJobs} onAssign={(m,o,e)=>{assignToMachine(modal.woId,modal.itemId,m,o,e);setModal(null);}}/></Modal>}
    </div>
  );

  function AssignForm({woId,itemId,estMin,machines,operators,productionJobs,onAssign}){
    const [mid,setMid]=useState("");
    const [oid,setOid]=useState("");
    const [em,setEm]=useState(estMin);
    return(
      <div>
        <Input label="Makine" value={mid} onChange={setMid} options={machines.filter(m=>m.type==="CNC").map(m=>({value:m.id,label:`${m.name} (${productionJobs.filter(j=>j.machineId===m.id&&j.status!=="completed").length} i≈ü)`}))}/>
        <div style={{marginTop:12}}><Input label="Operat√∂r" value={oid} onChange={setOid} options={operators.filter(o=>o.role.includes("CNC")).map(o=>({value:o.id,label:`${o.name} (${o.shift})`}))}/></div>
        <div style={{marginTop:12}}><Input label="Tahmini √úretim S√ºresi (dk)" type="number" value={em} onChange={v=>setEm(Number(v))} placeholder="60"/></div>
        <div style={{marginTop:20,display:"flex",justifyContent:"flex-end",gap:8}}><Btn variant="primary" icon={Check} onClick={()=>onAssign(mid,oid,em)} disabled={!mid||!oid}>Atama Yap</Btn></div>
      </div>
    );
  }

  function RescheduleForm({ job, machines: mList, onSave, onClear }) {
    const wo = workOrders.find(w => w.id === job.woId);
    const item = wo?.items.find(i => i.id === job.itemId);
    const machine = mList.find(m => m.id === job.machineId);

    // Get current scheduled position from blocks
    const curBlock = job._blocks?.[0];
    const curStartDate = job.planDate || curBlock?.date || dateStr(new Date());
    const curStartMin = job.planStartMin != null ? job.planStartMin : (curBlock?.start ?? WORK_START);

    const [newMachine, setNewMachine] = useState(job.machineId || "");
    const [newDate, setNewDate] = useState(curStartDate);
    const [newHour, setNewHour] = useState(Math.floor(curStartMin / 60));
    const [newMin, setNewMin] = useState(curStartMin % 60);
    const [newEst, setNewEst] = useState(job.estimatedMinutes || 60);

    const hourOpts = [];
    for (let h = 8; h <= 17; h++) hourOpts.push({ value: h, label: String(h).padStart(2, "0") });
    const minOpts = [];
    for (let m = 0; m < 60; m += 10) minOpts.push({ value: m, label: String(m).padStart(2, "0") });

    const planStartMin = newHour * 60 + newMin;
    const endMin = planStartMin + newEst;
    const overflow = endMin > WORK_END;

    // Find following jobs on same machine (by assignedAt order)
    const sameM = productionJobs
      .filter(j => j.machineId === (newMachine || job.machineId) && j.id !== job.id && j.estimatedMinutes > 0)
      .sort((a, b) => (a.assignedAt || 0) - (b.assignedAt || 0));
    const followJobs = sameM.filter(j => (j.assignedAt || 0) > (job.assignedAt || 0));

    // Calculate cascade: simulate where following jobs would land
    const cascadePreview = (() => {
      let cursor = endMin <= WORK_END ? { date: newDate, min: endMin } : { date: newDate, min: WORK_END }; // simplified
      if (endMin > WORK_END) cursor = { date: newDate, min: WORK_END }; // will cascade to next day
      return followJobs.slice(0, 5).map(fj => {
        const fwo = workOrders.find(w => w.id === fj.woId);
        const fit = fwo?.items.find(i => i.id === fj.itemId);
        let cMin = cursor.min;
        let cDate = cursor.date;
        // If this follow job also has manual and it's later, use that
        if (fj.planDate && fj.planStartMin != null) {
          if (fj.planDate > cDate || (fj.planDate === cDate && fj.planStartMin > cMin)) {
            cDate = fj.planDate; cMin = fj.planStartMin;
          }
        }
        if (cMin >= WORK_END) { cDate = "ertesi g√ºn"; cMin = WORK_START; }
        const fEnd = cMin + fj.estimatedMinutes;
        const result = { id: fj.id, name: fit?.productCode || `√ò${fit?.diameter}`, customer: fwo?.customerName, start: cMin, end: fEnd, date: cDate, dur: fj.estimatedMinutes };
        cursor = { date: fEnd > WORK_END ? "ertesi g√ºn" : cDate, min: fEnd > WORK_END ? WORK_START + (fEnd - WORK_END) : fEnd };
        return result;
      });
    })();

    // Calculate shift amount
    const oldEndMin = curStartMin + job.estimatedMinutes;
    const newEndMin = planStartMin + newEst;
    const shiftMin = newEndMin - oldEndMin;

    return (
      <div>
        {/* Current info */}
        <div style={{ padding: 12, borderRadius: 8, background: "rgba(99,102,241,0.08)", border: "1px solid rgba(99,102,241,0.2)", marginBottom: 16 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 14, fontWeight: 700, color: "#e2e8f0" }}>
                {item?.productCode || `√ò${item?.diameter} ${item?.islem || ""}`}
              </div>
              <div style={{ fontSize: 12, color: "#94a3b8", marginTop: 2 }}>
                {wo?.customerName} ‚Äî {item?.qty} ad | {machine?.name}
              </div>
            </div>
            <div style={{ textAlign: "right" }}>
              <div style={{ fontSize: 12, color: "#64748b" }}>Mevcut</div>
              <div style={{ fontSize: 13, fontWeight: 600, color: "#e2e8f0" }}>
                {curStartDate} {fmtTime(curStartMin)}‚Äì{fmtTime(curStartMin + job.estimatedMinutes)}
              </div>
              {job.planDate ? <span style={{ fontSize: 10, color: "#f59e0b" }}>üìå Manuel</span> : <span style={{ fontSize: 10, color: "#64748b" }}>Otomatik</span>}
            </div>
          </div>
        </div>

        {/* Machine change */}
        <Input label="Makine" value={newMachine} onChange={setNewMachine} options={mList.filter(m => m.type === "CNC").map(m => ({ value: m.id, label: m.name }))} />

        {/* Date */}
        <div style={{ marginTop: 12 }}>
          <Input label="Planlanan Tarih" type="date" value={newDate} onChange={setNewDate} />
        </div>

        {/* Time */}
        <div style={{ marginTop: 12 }}>
          <div style={{ fontSize: 12, color: "#94a3b8", marginBottom: 6, fontWeight: 600 }}>Ba≈ülangƒ±√ß Saati</div>
          <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <Input label="Saat" value={newHour} onChange={v => setNewHour(Number(v))} options={hourOpts} />
            <span style={{ fontSize: 18, color: "#64748b", fontWeight: 700 }}>:</span>
            <Input label="Dakika" value={newMin} onChange={v => setNewMin(Number(v))} options={minOpts} />
          </div>
        </div>

        {/* Estimated minutes */}
        <div style={{ marginTop: 12 }}>
          <Input label="Tahmini S√ºre (dk)" type="number" value={newEst} onChange={v => setNewEst(Number(v))} placeholder="60" />
        </div>

        {/* Preview */}
        <div style={{ marginTop: 14, padding: 12, borderRadius: 8, background: "rgba(30,41,59,0.8)", border: "1px solid rgba(255,255,255,0.08)" }}>
          <div style={{ fontSize: 12, fontWeight: 700, color: "#e2e8f0", marginBottom: 8 }}>üìã Yeni Plan</div>
          {/* This job */}
          <div style={{ display: "flex", alignItems: "center", gap: 8, padding: "6px 10px", borderRadius: 6, background: "rgba(59,130,246,0.15)", border: "1px solid rgba(59,130,246,0.3)", marginBottom: 6 }}>
            <span style={{ fontSize: 12, fontWeight: 600, color: "#3b82f6" }}>üìå</span>
            <span style={{ fontSize: 12, fontWeight: 600, color: "#e2e8f0", flex: 1 }}>{item?.productCode || `√ò${item?.diameter}`}</span>
            <span style={{ fontSize: 12, fontWeight: 700, color: "#3b82f6" }}>{fmtTime(planStartMin)} ‚Üí {fmtTime(endMin > WORK_END ? WORK_END : endMin)}</span>
            <span style={{ fontSize: 11, color: "#64748b" }}>{newEst}dk</span>
          </div>
          {overflow && <div style={{ fontSize: 11, color: "#f59e0b", marginBottom: 6, paddingLeft: 10 }}>‚ö†Ô∏è Mesai a≈üƒ±mƒ± ‚Äî ertesi g√ºne sarkacak</div>}

          {/* Shift indicator */}
          {shiftMin !== 0 && (
            <div style={{ fontSize: 11, fontWeight: 600, color: shiftMin > 0 ? "#f59e0b" : "#10b981", marginBottom: 8, paddingLeft: 10 }}>
              {shiftMin > 0 ? `‚è© +${shiftMin}dk gecikme ‚Äî sonraki i≈üler kaydƒ±rƒ±lacak` : `‚è™ ${shiftMin}dk erken ‚Äî sonraki i≈üler √∂ne √ßekilecek`}
            </div>
          )}

          {/* Following jobs cascade */}
          {cascadePreview.length > 0 && (
            <div style={{ marginTop: 4 }}>
              <div style={{ fontSize: 11, color: "#64748b", marginBottom: 4, paddingLeft: 10 }}>Sonraki i≈üler (kaskad):</div>
              {cascadePreview.map((fj, i) => (
                <div key={fj.id} style={{ display: "flex", alignItems: "center", gap: 8, padding: "4px 10px", borderRadius: 5, background: "rgba(255,255,255,0.02)", marginBottom: 2 }}>
                  <span style={{ fontSize: 11, color: "#64748b", width: 14 }}>{i + 1}.</span>
                  <span style={{ fontSize: 11, color: "#94a3b8", flex: 1 }}>{fj.name} ‚Äî {fj.customer}</span>
                  <span style={{ fontSize: 11, fontWeight: 600, color: "#94a3b8" }}>{fj.date === "ertesi g√ºn" ? "‚Üíertesi g√ºn " : ""}{fmtTime(fj.start)}‚Äì{fmtTime(fj.end > WORK_END ? WORK_END : fj.end)}</span>
                  <span style={{ fontSize: 10, color: "#64748b" }}>{fj.dur}dk</span>
                </div>
              ))}
              {followJobs.length > 5 && <div style={{ fontSize: 10, color: "#64748b", paddingLeft: 10, marginTop: 2 }}>...ve {followJobs.length - 5} i≈ü daha</div>}
            </div>
          )}
        </div>

        {/* Actions */}
        <div style={{ marginTop: 18, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <div>
            {job.planDate && <Btn variant="ghost" size="sm" onClick={onClear}>Otomatiƒüe √áevir</Btn>}
          </div>
          <Btn variant="primary" icon={Save} onClick={() => onSave(job.id, { planDate: newDate, planStartMin, estimatedMinutes: newEst, machineId: newMachine })}>
            Kaydet
          </Btn>
        </div>
      </div>
    );
  }

  };  // ‚Üê close WorkOrdersPage

  //  PLANNING PAGE 
  const PlanningPage = () => {
    const [planTab,setPlanTab]=useState("distribution");
    const [calView,setCalView]=useState("daily");
    const [viewDate,setViewDate]=useState(new Date("2026-02-16"));
    const cncMachines=machines.filter(m=>m.type==="CNC");
    const timeSlots = [];
    for(let m=WORK_START;m<=WORK_END;m+=10) timeSlots.push(m);

    const getBlocksForDate = (date, machineId) => {
      const ds = dateStr(date);
      return (schedule[ds]||[]).filter(b=>b.machineId===machineId);
    };

    const getWeekDates = (d) => {
      const start=new Date(d);
      const day=start.getDay();
      const diff=start.getDate()-day+(day===0?-6:1);
      const mon=new Date(start.setDate(diff));
      return Array.from({length:5},(_,i)=>addDays(mon,i));
    };

    const getMonthDates = (d) => {
      const y=d.getFullYear(), m=d.getMonth();
      const last=new Date(y,m+1,0);
      const days=[];
      for(let i=1;i<=last.getDate();i++) days.push(new Date(y,m,i));
      return days;
    };

    const TIMELINE_PX_PER_MIN = 4;
    const TIMELINE_WIDTH = WORK_MINUTES * TIMELINE_PX_PER_MIN;

    const TimelineDay = ({date}) => {
      return (
        <div style={{marginBottom:24}}>
          <div style={{fontSize:14,fontWeight:600,color:"#e2e8f0",marginBottom:10}}>{new Date(date).toLocaleDateString("tr-TR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}</div>
          <div style={{overflowX:"auto",paddingBottom:6}}>
            <div style={{minWidth:TIMELINE_WIDTH+140}}>
              {/* Time header */}
              <div style={{display:"flex",marginBottom:2}}>
                <div style={{width:130,flexShrink:0}}/>
                <div style={{position:"relative",width:TIMELINE_WIDTH,height:20}}>
                  {timeSlots.map((m)=>{
                    const x=(m-WORK_START)*TIMELINE_PX_PER_MIN;
                    const isHour=m%60===0;
                    const isHalf=m%30===0&&!isHour;
                    const is10=m%10===0;
                    return(
                      <div key={m} style={{position:"absolute",left:x,top:0,bottom:0}}>
                        <span style={{fontSize:isHour?10:isHalf?9:8,fontWeight:isHour?700:isHalf?600:400,color:isHour?"#e2e8f0":isHalf?"#94a3b8":"#64748b",whiteSpace:"nowrap",position:"absolute",left:-12,top:isHour?0:2}}>{is10?minToTime(m):""}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
              {/* Machine rows */}
              {cncMachines.map(machine=>{
                const blocks=getBlocksForDate(date,machine.id);
                return(
                  <div key={machine.id} style={{display:"flex",alignItems:"center",marginBottom:6}}>
                    <div style={{width:130,fontSize:12,fontWeight:600,color:"#94a3b8",flexShrink:0,paddingRight:10}}>{machine.name}</div>
                    <div style={{position:"relative",width:TIMELINE_WIDTH,height:40,background:"rgba(255,255,255,0.02)",borderRadius:6,border:"1px solid rgba(255,255,255,0.06)"}}>
                      {/* Grid lines every 10 min */}
                      {timeSlots.map(m=>{
                        const x=(m-WORK_START)*TIMELINE_PX_PER_MIN;
                        const isHour=m%60===0;
                        const isHalf=m%30===0&&!isHour;
                        return <div key={m} style={{position:"absolute",left:x,top:0,bottom:0,width:1,background:isHour?"rgba(255,255,255,0.12)":isHalf?"rgba(255,255,255,0.07)":"rgba(255,255,255,0.035)"}}/>;
                      })}
                      {/* Job blocks */}
                      {blocks.map((block,bi)=>{
                        const wo=workOrders.find(w=>w.id===block.woId);
                        const item=wo?.items.find(i=>i.id===block.itemId);
                        const job=productionJobs.find(j=>j.id===block.jobId);
                        const left=(block.start-WORK_START)*TIMELINE_PX_PER_MIN;
                        const width=(block.end-block.start)*TIMELINE_PX_PER_MIN;
                        const colors=["#3b82f6","#8b5cf6","#f59e0b","#10b981","#ef4444","#ec4899","#14b8a6"];
                        const color=colors[bi%colors.length];
                        const isManual=job?.planDate;
                        return(
                          <div key={bi}
                            onClick={()=>{if(job&&hasPerm("planning_edit"))setRescheduleModal(job); else if(wo)setWoDetail(wo);}}
                            title={`${item?.productCode||`√ò${item?.diameter}`} ‚Äî ${wo?.customerName}\n${minToTime(block.start)} - ${minToTime(block.end)} (${block.end-block.start}dk)${isManual?"\nüìå Manuel planlama":""}${hasPerm("planning_edit")?"\nüñ± Tƒ±kla ‚Üí Zamanla":""}`}
                            style={{position:"absolute",left,width:Math.max(width,10),top:3,bottom:3,borderRadius:4,background:`${color}dd`,display:"flex",alignItems:"center",paddingLeft:4,overflow:"hidden",cursor:"pointer",boxShadow:`0 1px 3px ${color}44`,zIndex:1,borderBottom:isManual?"2px solid #f59e0b":"none"}}>
                            <span style={{fontSize:10,fontWeight:600,color:"#fff",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>
                              {width>120?`${isManual?"üìå ":""}${item?.productCode||`√ò${item?.diameter}`} | ${minToTime(block.start)}-${minToTime(block.end)} (${block.end-block.start}dk)`:width>60?`${isManual?"üìå":""}${item?.productCode||`√ò${item?.diameter}`} ${block.end-block.start}dk`:width>30?`${block.end-block.start}dk`:""}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      );
    };

    return (
      <div>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
          <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>ƒ∞≈ü Planlama</h2>
        </div>
        <div style={{marginBottom:16}}><TabSwitcher tabs={[{key:"distribution",label:"Makine Daƒüƒ±lƒ±mƒ±",icon:Monitor},{key:"calendar",label:"Takvim √áizelgesi",icon:Calendar}]} active={planTab} onChange={setPlanTab}/></div>

        {planTab==="distribution"?(
          <>
            <Card style={{marginBottom:16}}>
              <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Makine ƒ∞≈ü Daƒüƒ±lƒ±mƒ±</h3>
              {cncMachines.map(machine=>{
                const jobs=productionJobs.filter(j=>j.machineId===machine.id&&j.status!=="completed");
                return(
                  <div key={machine.id} style={{marginBottom:14}}>
                    <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:6}}>
                      <Monitor size={15} color="#3b82f6"/><span style={{fontSize:14,fontWeight:600,color:"#e2e8f0"}}>{machine.name}</span>
                      <Badge color={jobs.length>0?"#f59e0b":"#10b981"} bg={jobs.length>0?"rgba(245,158,11,0.15)":"rgba(16,185,129,0.15)"}>{jobs.length>0?`${jobs.length} ƒ∞≈ü`:"Bo≈ü"}</Badge>
                    </div>
                    <div style={{display:"flex",gap:8,overflowX:"auto",paddingBottom:4}}>
                      {jobs.length===0?<div style={{padding:"10px 20px",borderRadius:8,background:"rgba(16,185,129,0.05)",border:"1px dashed rgba(16,185,129,0.2)",fontSize:12,color:"#10b981"}}>M√ºsait</div>
                      :jobs.map(job=>{
                        const wo=workOrders.find(w=>w.id===job.woId);const item=wo?.items.find(i=>i.id===job.itemId);
                        return(
                          <div key={job.id} style={{minWidth:180,padding:10,borderRadius:8,background:job.status==="running"?"rgba(59,130,246,0.1)":"rgba(245,158,11,0.08)",border:`1px solid ${job.status==="running"?"rgba(59,130,246,0.3)":"rgba(245,158,11,0.2)"}`,position:"relative"}}>
                            <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{item?.productCode||`√ò${item?.diameter} ${item?.islem||""}`}</div>
                            <div style={{fontSize:11,color:"#64748b",marginTop:3}}>{wo?.customerName} ‚Äî {item?.qty} ad</div>
                            <div style={{display:"flex",alignItems:"center",gap:6,marginTop:4}}>
                              <span style={{fontSize:11,color:"#3b82f6"}}>‚è± {job.estimatedMinutes} dk</span>
                              {job.planDate&&<span style={{fontSize:10,color:"#f59e0b"}}>üìå {fmtTime(job.planStartMin)}</span>}
                            </div>
                            {hasPerm("planning_edit")&&<button onClick={()=>setRescheduleModal(job)} style={{position:"absolute",top:4,right:4,background:"rgba(255,255,255,0.06)",border:"none",borderRadius:4,padding:"2px 5px",cursor:"pointer",fontSize:11,color:"#94a3b8"}} title="Zamanla / D√ºzenle">‚è∞</button>}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </Card>
            <Card>
              <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Atanmamƒ±≈ü ƒ∞≈üler (√úretime Hazƒ±r)</h3>
              {workOrders.flatMap(wo=>wo.items.filter(it=>!it.machineId&&(it.woStatus==="cut"||(wo.orderType==="bileme"&&it.woStatus==="pending"))).map(it=>({...it,woId:wo.id,customerName:wo.customerName,deliveryDate:wo.deliveryDate,orderType:wo.orderType}))).map(item=>(
                <div key={item.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:10,borderRadius:8,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:6}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <OrderTypeBadge type={item.orderType}/>
                    <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{item.productCode||`√ò${item.diameter} ${item.islem||""}`}</span>
                    <span style={{fontSize:12,color:"#64748b"}}>{item.customerName} ‚Äî {item.qty} ad</span>
                    {item.estimatedMinutes>0&&<span style={{fontSize:11,color:"#3b82f6"}}>‚è± {item.estimatedMinutes}dk</span>}
                    <span style={{fontSize:12,color:"#f59e0b"}}>Termin: {fmtDate(item.deliveryDate)}</span>
                  </div>
                  {hasPerm("planning_edit")&&<Btn variant="primary" size="sm" icon={Factory} onClick={()=>setModal({type:"assign",woId:item.woId,itemId:item.id,estMin:item.estimatedMinutes||60})}>Atama</Btn>}
                </div>
              ))}
              {workOrders.flatMap(wo=>wo.items.filter(it=>!it.machineId&&(it.woStatus==="cut"||(wo.orderType==="bileme"&&it.woStatus==="pending")))).length===0&&<div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>T√ºm i≈üler atanmƒ±≈ü ‚úì</div>}
            </Card>
          </>
        ):(
          <Card>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
              <div style={{display:"flex",gap:4}}>
                {["daily","weekly","monthly"].map(v=>(
                  <Btn key={v} variant={calView===v?"primary":"ghost"} size="sm" onClick={()=>setCalView(v)}>{v==="daily"?"G√ºnl√ºk":v==="weekly"?"Haftalƒ±k":"Aylƒ±k"}</Btn>
                ))}
              </div>
              <div style={{display:"flex",gap:6,alignItems:"center"}}>
                <Btn variant="ghost" size="sm" icon={ChevronLeft} onClick={()=>setViewDate(d=>addDays(d,calView==="daily"?-1:calView==="weekly"?-7:-30))}/>
                <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0",minWidth:140,textAlign:"center"}}>{calView==="monthly"?viewDate.toLocaleDateString("tr-TR",{month:"long",year:"numeric"}):dayLabel(viewDate)}</span>
                <Btn variant="ghost" size="sm" icon={ChevronRight} onClick={()=>setViewDate(d=>addDays(d,calView==="daily"?1:calView==="weekly"?7:30))}/>
              </div>
            </div>

            {calView==="daily"&&<TimelineDay date={viewDate}/>}

            {calView==="weekly"&&(
              <div>
                {getWeekDates(viewDate).map(d=>(
                  <TimelineDay key={dateStr(d)} date={d}/>
                ))}
              </div>
            )}

            {calView==="monthly"&&(
              <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>
                {["Pzt","Sal","√áar","Per","Cum","Cmt","Paz"].map(d=><div key={d} style={{textAlign:"center",fontSize:11,fontWeight:600,color:"#64748b",padding:6}}>{d}</div>)}
                {(() => {
                  const dates=getMonthDates(viewDate);
                  const firstDay=(new Date(dates[0]).getDay()+6)%7;
                  const cells=[];
                  for(let i=0;i<firstDay;i++) cells.push(<div key={`e${i}`}/>);
                  dates.forEach(d=>{
                    const ds=dateStr(d);
                    const dayBlocks=(schedule[ds]||[]);
                    const hasWork=dayBlocks.length>0;
                    const isToday=dateStr(d)===dateStr(new Date());
                    cells.push(
                      <div key={ds} onClick={()=>{setViewDate(d);setCalView("daily");}} style={{padding:6,borderRadius:6,background:isToday?"rgba(59,130,246,0.15)":hasWork?"rgba(255,255,255,0.03)":"transparent",border:isToday?"1px solid rgba(59,130,246,0.3)":"1px solid rgba(255,255,255,0.04)",cursor:"pointer",minHeight:48,textAlign:"center"}}>
                        <div style={{fontSize:12,fontWeight:600,color:isWeekend(d)?"#475569":"#e2e8f0"}}>{d.getDate()}</div>
                        {hasWork&&<div style={{marginTop:3}}>
                          {[...new Set(dayBlocks.map(b=>b.machineId))].map(mid=>{
                            const mc=machines.find(m=>m.id===mid);
                            const totalMin=dayBlocks.filter(b=>b.machineId===mid).reduce((s,b)=>s+(b.end-b.start),0);
                            return <div key={mid} style={{fontSize:8,color:"#3b82f6",background:"rgba(59,130,246,0.15)",borderRadius:3,padding:"1px 3px",marginTop:1,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{mc?.name?.split(" ")[0]} {totalMin}dk</div>;
                          })}
                        </div>}
                      </div>
                    );
                  });
                  return cells;
                })()}
              </div>
            )}
          </Card>
        )}
        {modal?.type==="assign"&&<Modal title="Makine & Operat√∂r Atama" onClose={()=>setModal(null)} width={500}><AssignForm woId={modal.woId} itemId={modal.itemId} estMin={modal.estMin} machines={machines} operators={operators} productionJobs={productionJobs} onAssign={(m,o,e)=>{assignToMachine(modal.woId,modal.itemId,m,o,e);setModal(null);}}/></Modal>}
      </div>
    );
  };

  // PRODUCTION
  const ProductionPage = () => {
    const active=productionJobs.filter(j=>j.status!=="completed");
    const done=productionJobs.filter(j=>j.status==="completed");
    const [defectModal, setDefectModal] = useState(null);
    const [defectQty, setDefectQty] = useState("");
    const [defectReason, setDefectReason] = useState("");
    const [defectLogModal, setDefectLogModal] = useState(null);
    const DEFECT_REASONS = ["Kƒ±rƒ±ldƒ±","√ñl√ß√º dƒ±≈üƒ±","Y√ºzey hatasƒ±","Malzeme hatasƒ±","Takƒ±m kaymasƒ±","Operat√∂r hatasƒ±","Diƒüer"];
    return(
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>√úretim Takip</h2>
        <Card style={{marginBottom:20}}>
          <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Aktif ({active.length})</h3>
          {active.length===0?<div style={{textAlign:"center",padding:30,color:"#64748b"}}>Aktif √ºretim yok</div>
          :active.map(job=>{
            const wo=workOrders.find(w=>w.id===job.woId);const item=wo?.items.find(i=>i.id===job.itemId);
            const machine=machines.find(m=>m.id===job.machineId);const op=operators.find(o=>o.id===job.operatorId);
            const elapsed=job.startTime?Math.floor((Date.now()-new Date(job.startTime))/60000):0;
            const reject=Number(item?.rejectQty)||0;
            const goodQty=(item?.qty||0)-reject;
            return(
              <div key={job.id} style={{padding:14,borderRadius:10,marginBottom:10,background:job.status==="running"?"rgba(59,130,246,0.08)":"rgba(255,255,255,0.02)",border:`1px solid ${job.status==="running"?"rgba(59,130,246,0.2)":"rgba(255,255,255,0.06)"}`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div>
                    <div style={{display:"flex",alignItems:"center",gap:6}}><OrderTypeBadge type={wo?.orderType}/><span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{item?.productCode||`√ò${item?.diameter} ${item?.islem||""}`}</span></div>
                    <div style={{fontSize:12,color:"#94a3b8",marginTop:3}}>
                      {wo?.customerName} |
                      {reject>0?(
                        <span style={{marginLeft:4}}>
                          <span style={{color:"#10b981",fontWeight:700}}>{goodQty}</span>
                          <span style={{color:"#64748b"}}>/{item?.qty} ad</span>
                          <span style={{color:"#ef4444",fontWeight:600,marginLeft:4}}>({reject} fire)</span>
                        </span>
                      ):(
                        <span style={{marginLeft:4}}>{item?.qty} ad</span>
                      )}
                      {" | "}<button onClick={()=>wo&&setWoDetail(wo)} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:12,textDecoration:"underline",fontFamily:"inherit"}}>{wo?.id}</button>
                    </div>
                    <div style={{display:"flex",gap:10,marginTop:6,flexWrap:"wrap",alignItems:"center"}}>
                      <span style={{fontSize:12,color:"#3b82f6"}}>üñ• {machine?.name}</span>
                      <span style={{fontSize:12,color:"#10b981"}}>üë§ {op?.name}</span>
                      <span style={{fontSize:12,color:"#64748b"}}>Tahmini: {job.estimatedMinutes}dk</span>
                      {job.status==="running"&&<span style={{fontSize:12,color:"#f59e0b"}}>‚è± {elapsed} dk</span>}
                    </div>
                    {reject>0&&<div style={{marginTop:6}}>
                      <button onClick={()=>setDefectLogModal({item,wo})} style={{background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:6,padding:"3px 10px",cursor:"pointer",color:"#ef4444",fontSize:11,fontWeight:600,fontFamily:"inherit"}}>
                        üî¥ {reject} Fire Kaydƒ± ‚Äî Detay
                      </button>
                    </div>}
                    <div style={{marginTop:6}}><PdfChips pdfs={item?.pdfs||[]} canEdit={hasPerm("production_edit")} onUpload={f=>wo&&addPdfToWoItem(wo.id,item.id,f,"√úretim")}/></div>
                  </div>
                  <div style={{display:"flex",gap:6,flexWrap:"wrap",flexDirection:"column",alignItems:"flex-end"}}>
                    {hasPerm("production_edit")&&<Btn variant="danger" size="sm" icon={AlertTriangle} onClick={()=>{setDefectModal({woId:wo?.id,itemId:item?.id,productCode:item?.productCode,maxQty:goodQty});setDefectQty("");setDefectReason("");}}>Fire Bildir</Btn>}
                    {hasPerm("planning_edit")&&<Btn variant="ghost" size="sm" icon={Edit} onClick={()=>setRescheduleModal(job)}>Zamanla</Btn>}
                    {job.status==="assigned"&&hasPerm("production_edit")&&<Btn variant="success" size="sm" icon={Play} onClick={()=>startProduction(job.id)}>Ba≈ülat</Btn>}
                    {job.status==="running"&&hasPerm("production_edit")&&<Btn variant="danger" size="sm" icon={Square} onClick={()=>stopProduction(job.id)}>Bitir</Btn>}
                  </div>
                </div>
              </div>
            );
          })}
        </Card>
        {done.length>0&&<Card><h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Tamamlanan ({done.length})</h3>{done.map(job=>{const wo=workOrders.find(w=>w.id===job.woId);const item=wo?.items.find(i=>i.id===job.itemId);const dur=job.startTime&&job.endTime?Math.floor((new Date(job.endTime)-new Date(job.startTime))/60000):0;const reject=Number(item?.rejectQty)||0;const goodQty=(item?.qty||0)-reject;return(<div key={job.id} style={{padding:10,borderRadius:8,background:"rgba(16,185,129,0.05)",border:"1px solid rgba(16,185,129,0.1)",marginBottom:6,display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{item?.productCode||`√ò${item?.diameter} ${item?.islem||""}`} ‚Äî {wo?.customerName}</span>{reject>0&&<span style={{fontSize:11,color:"#ef4444",marginLeft:8,fontWeight:600}}>({goodQty}/{item?.qty} ‚Äî {reject} fire)</span>}</div><div style={{display:"flex",gap:8,alignItems:"center"}}>{reject>0&&<button onClick={()=>setDefectLogModal({item,wo})} style={{background:"rgba(239,68,68,0.1)",border:"1px solid rgba(239,68,68,0.2)",borderRadius:5,padding:"2px 8px",cursor:"pointer",color:"#ef4444",fontSize:10,fontWeight:600,fontFamily:"inherit"}}>Fire Log</button>}<span style={{fontSize:12,color:"#10b981"}}>‚úì {dur}dk</span><Badge color="#10b981" bg="rgba(16,185,129,0.15)">Bitti</Badge></div></div>);})}</Card>}

        {/* DEFECT REPORT MODAL */}
        {defectModal&&(
          <Modal title="üî¥ Fire Bildirimi" onClose={()=>setDefectModal(null)} width={450}>
            <div style={{fontSize:13,color:"#94a3b8",marginBottom:14}}>
              <strong style={{color:"#e2e8f0"}}>{defectModal.productCode}</strong> ‚Äî Maks. bildirilebilir: <strong style={{color:"#f59e0b"}}>{defectModal.maxQty} adet</strong>
            </div>
            <div style={{display:"grid",gap:12,marginBottom:16}}>
              <Input label="Fire Adedi" type="number" value={defectQty} onChange={setDefectQty} placeholder="Ka√ß adet?"/>
              <div>
                <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>Sebep</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap",marginBottom:6}}>
                  {DEFECT_REASONS.map(r=>(
                    <button key={r} onClick={()=>setDefectReason(r)} style={{
                      padding:"4px 10px",borderRadius:6,fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"inherit",
                      background:defectReason===r?"rgba(239,68,68,0.2)":"rgba(255,255,255,0.04)",
                      border:`1px solid ${defectReason===r?"rgba(239,68,68,0.4)":"rgba(255,255,255,0.08)"}`,
                      color:defectReason===r?"#ef4444":"#94a3b8"
                    }}>{r}</button>
                  ))}
                </div>
              </div>
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <Btn variant="ghost" onClick={()=>setDefectModal(null)}>ƒ∞ptal</Btn>
              <Btn variant="danger" icon={AlertTriangle}
                disabled={!defectQty||Number(defectQty)<=0||Number(defectQty)>defectModal.maxQty||!defectReason}
                onClick={()=>{reportDefect(defectModal.woId,defectModal.itemId,Number(defectQty),defectReason,"√úretim");setDefectModal(null);}}>
                {defectQty?`${defectQty} Adet Fire Kaydet`:"Fire Kaydet"}
              </Btn>
            </div>
          </Modal>
        )}

        {/* DEFECT LOG MODAL */}
        {defectLogModal&&<Modal title={"Fire Kayƒ±tlarƒ± ‚Äî "+(defectLogModal.item?.productCode||"")} onClose={()=>setDefectLogModal(null)} width={550}>
              <div style={{display:"flex",gap:16,marginBottom:16}}>
                <div style={{padding:12,borderRadius:10,background:"rgba(239,68,68,0.08)",border:"1px solid rgba(239,68,68,0.2)",flex:1,textAlign:"center"}}>
                  <div style={{fontSize:11,color:"#ef4444",fontWeight:600}}>Toplam Fire</div>
                  <div style={{fontSize:24,fontWeight:800,color:"#ef4444"}}>{Number(defectLogModal.item?.rejectQty||0)}</div>
                </div>
                <div style={{padding:12,borderRadius:10,background:"rgba(16,185,129,0.08)",border:"1px solid rgba(16,185,129,0.2)",flex:1,textAlign:"center"}}>
                  <div style={{fontSize:11,color:"#10b981",fontWeight:600}}>Saƒülam</div>
                  <div style={{fontSize:24,fontWeight:800,color:"#10b981"}}>{(defectLogModal.item?.qty||0)-Number(defectLogModal.item?.rejectQty||0)}</div>
                </div>
                <div style={{padding:12,borderRadius:10,background:"rgba(59,130,246,0.08)",border:"1px solid rgba(59,130,246,0.2)",flex:1,textAlign:"center"}}>
                  <div style={{fontSize:11,color:"#3b82f6",fontWeight:600}}>Sipari≈ü</div>
                  <div style={{fontSize:24,fontWeight:800,color:"#3b82f6"}}>{defectLogModal.item?.qty}</div>
                </div>
              </div>
              {(defectLogModal.item?.defectLog||[]).length===0?<div style={{textAlign:"center",padding:20,color:"#64748b"}}>Kayƒ±t yok</div>
              :<div>{(defectLogModal.item?.defectLog||[]).map((log,i)=>(
                <div key={i} style={{padding:10,borderRadius:8,background:"rgba(239,68,68,0.04)",border:"1px solid rgba(239,68,68,0.1)",marginBottom:6}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div style={{display:"flex",alignItems:"center",gap:8}}>
                      <span style={{fontSize:14,fontWeight:700,color:"#ef4444"}}>-{log.qty} ad</span>
                      <Badge color="#ef4444" bg="rgba(239,68,68,0.12)">{log.reason}</Badge>
                      <Badge color="#6366f1" bg="rgba(99,102,241,0.12)">{log.stage}</Badge>
                    </div>
                    <div style={{fontSize:11,color:"#64748b"}}>{fmtDateTime(log.date)} ‚Äî {log.reportedBy}</div>
                  </div>
                </div>
              ))}</div>}
        </Modal>}
      </div>
    );
  };

  //  QC 
  const QCPage = () => {
    const qcItems=workOrders.flatMap(wo=>wo.items.filter(it=>it.woStatus==="qc").map(it=>({...it,woId:wo.id,customerName:wo.customerName,orderType:wo.orderType,qcChecks:it.qcChecks||{dimensionOk:false,surfaceOk:false,runoutOk:false,visualOk:false}})));
    const [qcDefectModal, setQcDefectModal] = useState(null);
    const [qcDefectQty, setQcDefectQty] = useState("");
    const [qcDefectReason, setQcDefectReason] = useState("");
    const DEFECT_REASONS_QC = ["√ñl√ß√º dƒ±≈üƒ±","Y√ºzey hatasƒ±","Salgƒ± hatasƒ±","√áapak","Kƒ±rƒ±k/√áatlak","Diƒüer"];
    return(
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>Kalite Kontrol</h2>
        {qcItems.length===0?<Card style={{textAlign:"center",padding:40}}><CheckCircle2 size={40} color="#475569" style={{marginBottom:12}}/><div style={{color:"#64748b",fontSize:14}}>KK bekleyen √ºr√ºn yok.</div></Card>
        :qcItems.map(item=>{
          const reject=Number(item.rejectQty)||0;
          const goodQty=(item.qty||0)-reject;
          return(
          <Card key={item.id} style={{marginBottom:12}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10,flexWrap:"wrap"}}>
              <OrderTypeBadge type={item.orderType}/>
              <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{item.productCode||`√ò${item.diameter} ${item.islem}`}</span>
              <span style={{fontSize:12,color:"#64748b"}}>{item.customerName}</span>
              {reject>0?(
                <span style={{fontSize:12}}>
                  <span style={{color:"#10b981",fontWeight:700}}>{goodQty}</span>
                  <span style={{color:"#64748b"}}>/{item.qty} ad</span>
                  <span style={{color:"#ef4444",fontWeight:600,marginLeft:4}}>({reject} fire)</span>
                </span>
              ):(
                <span style={{fontSize:12,color:"#64748b"}}>{item.qty} ad</span>
              )}
              <button onClick={()=>{const wo=workOrders.find(w=>w.id===item.woId);if(wo)setWoDetail(wo);}} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:11,textDecoration:"underline",fontFamily:"inherit"}}>{item.woId}</button>
            </div>
            <div style={{marginBottom:10}}><PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("qc_edit")} onUpload={f=>addPdfToWoItem(item.woId,item.id,f,"Kalite Kontrol")}/></div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:8,marginBottom:12}}>
              {[{k:"dimensionOk",l:"√ñl√ß√º Kontrol√º"},{k:"surfaceOk",l:"Y√ºzey Kalitesi"},{k:"runoutOk",l:"Salgƒ± Kontrol√º"},{k:"visualOk",l:"G√∂rsel Kontrol"}].map(ch=>(
                <label key={ch.k} style={{display:"flex",alignItems:"center",gap:8,padding:10,borderRadius:8,background:item.qcChecks[ch.k]?"rgba(16,185,129,0.08)":"rgba(255,255,255,0.02)",border:`1px solid ${item.qcChecks[ch.k]?"rgba(16,185,129,0.2)":"rgba(255,255,255,0.06)"}`,cursor:hasPerm("qc_edit")?"pointer":"default",fontSize:13,color:"#e2e8f0"}}>
                  <input type="checkbox" checked={item.qcChecks[ch.k]} disabled={!hasPerm("qc_edit")} onChange={e=>{const nc={...item.qcChecks,[ch.k]:e.target.checked};setWorkOrders(p=>p.map(wo=>{if(wo.id!==item.woId)return wo;return{...wo,items:wo.items.map(it=>it.id===item.id?{...it,qcChecks:nc}:it)};}));}}/>{ch.l}
                </label>
              ))}
            </div>
            <div style={{display:"flex",gap:8}}>
              {hasPerm("qc_edit")&&<Btn variant="success" icon={Check} onClick={()=>completeQC(item.woId,item.id,item.qcChecks)} disabled={!Object.values(item.qcChecks).every(Boolean)}>KK Onayla ‚Üí Lazer</Btn>}
              {hasPerm("qc_edit")&&<Btn variant="danger" size="sm" icon={AlertTriangle} onClick={()=>{setQcDefectModal({woId:item.woId,itemId:item.id,productCode:item.productCode,maxQty:goodQty});setQcDefectQty("");setQcDefectReason("");}}>Fire Bildir</Btn>}
            </div>
          </Card>
        );})}
        {qcDefectModal&&(
          <Modal title="üî¥ KK Fire Bildirimi" onClose={()=>setQcDefectModal(null)} width={450}>
            <div style={{fontSize:13,color:"#94a3b8",marginBottom:14}}>
              <strong style={{color:"#e2e8f0"}}>{qcDefectModal.productCode}</strong> ‚Äî Maks: <strong style={{color:"#f59e0b"}}>{qcDefectModal.maxQty} adet</strong>
            </div>
            <div style={{display:"grid",gap:12,marginBottom:16}}>
              <Input label="Fire Adedi" type="number" value={qcDefectQty} onChange={setQcDefectQty} placeholder="Ka√ß adet?"/>
              <div>
                <div style={{fontSize:11,fontWeight:600,color:"#94a3b8",marginBottom:4}}>Sebep</div>
                <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
                  {DEFECT_REASONS_QC.map(r=>(
                    <button key={r} onClick={()=>setQcDefectReason(r)} style={{
                      padding:"4px 10px",borderRadius:6,fontSize:11,fontWeight:600,cursor:"pointer",fontFamily:"inherit",
                      background:qcDefectReason===r?"rgba(239,68,68,0.2)":"rgba(255,255,255,0.04)",
                      border:`1px solid ${qcDefectReason===r?"rgba(239,68,68,0.4)":"rgba(255,255,255,0.08)"}`,
                      color:qcDefectReason===r?"#ef4444":"#94a3b8"
                    }}>{r}</button>
                  ))}
                </div>
              </div>
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
              <Btn variant="ghost" onClick={()=>setQcDefectModal(null)}>ƒ∞ptal</Btn>
              <Btn variant="danger" icon={AlertTriangle}
                disabled={!qcDefectQty||Number(qcDefectQty)<=0||Number(qcDefectQty)>qcDefectModal.maxQty||!qcDefectReason}
                onClick={()=>{reportDefect(qcDefectModal.woId,qcDefectModal.itemId,Number(qcDefectQty),qcDefectReason,"Kalite Kontrol");setQcDefectModal(null);}}>
                {qcDefectQty?`${qcDefectQty} Adet Fire Kaydet`:"Fire Kaydet"}
              </Btn>
            </div>
          </Modal>
        )}
      </div>
    );
  };

  //  COATING 
  const CoatingPage = () => {
    const [selectedItems, setSelectedItems] = useState([]);
    const [printDispatch, setPrintDispatch] = useState(null);
    const ready=workOrders.flatMap(wo=>wo.items.filter(it=>it.woStatus==="coating_ready").map(it=>({...it,woId:wo.id,customerName:wo.customerName,orderType:wo.orderType})));
    const laser=workOrders.flatMap(wo=>wo.items.filter(it=>it.woStatus==="laser").map(it=>({...it,woId:wo.id,customerName:wo.customerName})));

    // Group ready items by coating company
    const groupedByCompany = {};
    ready.forEach(item => {
      const key = item.coatingCompanyId || "none";
      if (!groupedByCompany[key]) groupedByCompany[key] = [];
      groupedByCompany[key].push(item);
    });
    const allCC = [...COATING_COMPANIES_PRODUCTION,...COATING_COMPANIES_BILEME];

    const toggleSelect = (woId, itemId) => {
      const key = `${woId}-${itemId}`;
      setSelectedItems(p => p.includes(key) ? p.filter(k => k !== key) : [...p, key]);
    };
    const isSelected = (woId, itemId) => selectedItems.includes(`${woId}-${itemId}`);

    // Check all selected are same company
    const selectedReadyItems = ready.filter(it => isSelected(it.woId, it.id));
    const selectedCompanyIds = [...new Set(selectedReadyItems.map(it => it.coatingCompanyId))];
    const canCreateDispatch = selectedReadyItems.length > 0 && selectedCompanyIds.length === 1;

    const createGroupDispatch = () => {
      if (!canCreateDispatch) return;
      const companyId = selectedCompanyIds[0];
      const cc = allCC.find(c => c.id === companyId);
      const dispatchItems = selectedReadyItems.map(it => ({
        itemId: it.id, woId: it.woId, productCode: it.productCode || `√ò${it.diameter} ${it.islem || ""}`,
        qty: it.qty, coatingType: it.coatingType, diameter: it.diameter, customerName: it.customerName
      }));
      const dispatch = {
        id: `IRS-${String(coatingQueue.length + 1).padStart(3, "0")}`,
        date: new Date().toISOString(), status: "sent",
        coatingCompanyId: companyId, coatingCompany: cc,
        sender: MIHENG_INFO,
        receiver: cc ? { name: cc.fullName, address: cc.address } : null,
        items: dispatchItems,
      };
      setCoatingQueue(p => [...p, dispatch]);
      // Update all items
      selectedReadyItems.forEach(it => {
        setWorkOrders(p => p.map(w => {
          if (w.id !== it.woId) return w;
          return { ...w, currentStep: "coating", items: w.items.map(i => i.id === it.id ? { ...i, coatingSent: true, woStatus: "coating", dispatchId: dispatch.id } : i) };
        }));
      });
      setSelectedItems([]);
    };

    const selectAllForCompany = (companyId) => {
      const items = groupedByCompany[companyId] || [];
      const keys = items.map(it => `${it.woId}-${it.id}`);
      const allSelected = keys.every(k => selectedItems.includes(k));
      if (allSelected) {
        setSelectedItems(p => p.filter(k => !keys.includes(k)));
      } else {
        setSelectedItems(p => [...new Set([...p, ...keys])]);
      }
    };

    // Print dispatch note
    const DispatchPrint = ({d}) => {
      const iframeRef = useRef(null);
      const printNote = () => {
        const w = window.open("", "_blank", "width=800,height=600");
        if (!w) return;
        w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>ƒ∞rsaliye ${d.id}</title>
          <style>body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:13px}
          h1{font-size:20px;margin-bottom:5px} .header{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:2px solid #333;padding-bottom:15px}
          .box{border:1px solid #ccc;padding:12px;border-radius:6px;margin-bottom:12px} .box h3{margin:0 0 6px;font-size:13px;color:#666}
          table{width:100%;border-collapse:collapse;margin-top:15px} th,td{border:1px solid #ccc;padding:8px 10px;text-align:left;font-size:12px}
          th{background:#f5f5f5;font-weight:bold} .footer{margin-top:40px;display:flex;justify-content:space-between}
          .sign-box{width:200px;border-top:1px solid #333;padding-top:8px;text-align:center;font-size:11px;color:#666}
          @media print{body{padding:15px}}</style></head><body>
          <div class="header"><div><h1>ƒ∞RSALƒ∞YE</h1><div style="color:#666">${d.id}</div></div><div style="text-align:right"><div style="font-weight:bold">Tarih</div><div>${fmtDate(d.date)}</div></div></div>
          <div style="display:flex;gap:20px;margin-bottom:20px">
            <div class="box" style="flex:1"><h3>G√ñNDERƒ∞Cƒ∞</h3><div style="font-weight:bold">${d.sender?.name || MIHENG_INFO.name}</div><div>${d.sender?.address || MIHENG_INFO.address}</div></div>
            <div class="box" style="flex:1"><h3>ALICI</h3><div style="font-weight:bold">${d.receiver?.name || ""}</div><div>${d.receiver?.address || ""}</div></div>
          </div>
          <table><thead><tr><th>#</th><th>ƒ∞≈ü Emri</th><th>√úr√ºn</th><th>√áap</th><th>Kaplama</th><th>Adet</th></tr></thead><tbody>
          ${d.items.map((it, i) => `<tr><td>${i + 1}</td><td>${it.woId}</td><td>${it.productCode}</td><td>√ò${it.diameter || "-"}mm</td><td>${it.coatingType}</td><td style="text-align:right;font-weight:bold">${it.qty}</td></tr>`).join("")}
          <tr style="font-weight:bold;background:#f9f9f9"><td colspan="5" style="text-align:right">TOPLAM</td><td style="text-align:right">${d.items.reduce((s, it) => s + it.qty, 0)}</td></tr>
          </tbody></table>
          <div class="footer"><div class="sign-box">Teslim Eden</div><div class="sign-box">Teslim Alan</div></div>
          </body></html>`);
        w.document.close();
        setTimeout(() => w.print(), 300);
      };
      return <Btn variant="ghost" size="sm" icon={Printer} onClick={printNote}>Yazdƒ±r</Btn>;
    };

    return(
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>Kaplama</h2>
        {laser.length>0&&<Card style={{marginBottom:16}}><h3 style={{margin:"0 0 12px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Lazer Bekleyen ({laser.length})</h3>{laser.map(item=>(
          <div key={item.id} style={{padding:10,borderRadius:8,background:"rgba(168,85,247,0.05)",border:"1px solid rgba(168,85,247,0.15)",marginBottom:6}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}><span style={{fontSize:13,color:"#e2e8f0"}}>{item.productCode||`√ò${item.diameter} ${item.islem||""}`} ‚Äî {item.customerName} | {item.qty} ad</span><button onClick={()=>{const wo=workOrders.find(w=>w.id===item.woId);if(wo)setWoDetail(wo);}} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:11,textDecoration:"underline",fontFamily:"inherit"}}>{item.woId}</button></div>
              {hasPerm("coating_edit")&&<Btn variant="warning" size="sm" icon={Zap} onClick={()=>completeLaser(item.woId,item.id)}>Lazer Tamam</Btn>}
            </div>
            <div style={{marginTop:6}}><PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("coating_edit")} onUpload={f=>addPdfToWoItem(item.woId,item.id,f,"Lazer")}/></div>
          </div>
        ))}</Card>}

        {/* Ready - grouped by company */}
        <Card style={{marginBottom:16}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
            <h3 style={{margin:0,color:"#f1f5f9",fontSize:15,fontWeight:600}}>Kaplamaya Hazƒ±r ({ready.length})</h3>
            {canCreateDispatch && (
              <Btn variant="primary" icon={Truck} onClick={createGroupDispatch}>
                ƒ∞rsaliye Olu≈ütur ({selectedReadyItems.length} kalem ‚Üí {allCC.find(c=>c.id===selectedCompanyIds[0])?.name})
              </Btn>
            )}
            {selectedReadyItems.length > 0 && selectedCompanyIds.length > 1 && (
              <span style={{fontSize:12,color:"#ef4444",fontWeight:600}}>‚ö†Ô∏è Farklƒ± firmalar se√ßilemez ‚Äî aynƒ± kaplama firmasƒ± se√ßin</span>
            )}
          </div>
          {ready.length === 0 ? <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Yok</div> :
            Object.entries(groupedByCompany).map(([companyId, items]) => {
              const cc = allCC.find(c => c.id === companyId);
              const allSel = items.every(it => isSelected(it.woId, it.id));
              return (
                <div key={companyId} style={{marginBottom:14}}>
                  <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:8,padding:"6px 10px",borderRadius:6,background:"rgba(20,184,166,0.06)"}}>
                    <input type="checkbox" checked={allSel} onChange={()=>selectAllForCompany(companyId)} style={{cursor:"pointer"}}/>
                    <span style={{fontSize:13,fontWeight:700,color:"#14b8a6"}}>{cc?.name || "Belirtilmemi≈ü"}</span>
                    <span style={{fontSize:11,color:"#64748b"}}>({items.length} kalem)</span>
                  </div>
                  {items.map(item => (
                    <div key={item.id} style={{display:"flex",alignItems:"center",gap:10,padding:10,borderRadius:8,background:isSelected(item.woId,item.id)?"rgba(20,184,166,0.08)":"rgba(255,255,255,0.02)",border:`1px solid ${isSelected(item.woId,item.id)?"rgba(20,184,166,0.3)":"rgba(255,255,255,0.06)"}`,marginBottom:4,cursor:"pointer"}} onClick={()=>toggleSelect(item.woId,item.id)}>
                      <input type="checkbox" checked={isSelected(item.woId,item.id)} onChange={()=>{}} style={{cursor:"pointer",flexShrink:0}}/>
                      <div style={{flex:1}}>
                        <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{item.productCode||`√ò${item.diameter} ${item.islem||""}`}</span>
                        <span style={{fontSize:12,color:"#64748b",marginLeft:8}}>{item.customerName} | {item.qty} ad</span>
                        {item.coatingType&&<span style={{fontSize:11,color:"#14b8a6",marginLeft:8}}>{item.coatingType}</span>}
                        <button onClick={e=>{e.stopPropagation();const wo=workOrders.find(w=>w.id===item.woId);if(wo)setWoDetail(wo);}} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:11,textDecoration:"underline",fontFamily:"inherit",marginLeft:8}}>{item.woId}</button>
                      </div>
                    </div>
                  ))}
                </div>
              );
            })
          }
        </Card>

        {/* Dispatches */}
        <Card><h3 style={{margin:"0 0 12px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>ƒ∞rsaliyeler ({coatingQueue.length})</h3>
          {coatingQueue.length===0?<div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Yok</div>:coatingQueue.map(d=>(
            <div key={d.id} style={{padding:14,borderRadius:10,marginBottom:10,background:d.status==="sent"?"rgba(245,158,11,0.05)":"rgba(16,185,129,0.05)",border:`1px solid ${d.status==="sent"?"rgba(245,158,11,0.15)":"rgba(16,185,129,0.15)"}`}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                <div style={{display:"flex",alignItems:"center",gap:8}}>
                  <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{d.id}</span>
                  <Badge color={d.status==="sent"?"#f59e0b":"#10b981"} bg={d.status==="sent"?"rgba(245,158,11,0.15)":"rgba(16,185,129,0.15)"}>{d.status==="sent"?"G√∂nderildi":"Teslim Alƒ±ndƒ±"}</Badge>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <span style={{fontSize:12,color:"#64748b"}}>{fmtDateTime(d.date)}</span>
                  <DispatchPrint d={d}/>
                </div>
              </div>
              {/* Sender / Receiver */}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:10}}>
                <div style={{padding:8,borderRadius:6,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)"}}>
                  <div style={{fontSize:10,color:"#64748b",fontWeight:600,marginBottom:2}}>G√ñNDERƒ∞Cƒ∞</div>
                  <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{d.sender?.name || MIHENG_INFO.name}</div>
                  <div style={{fontSize:11,color:"#94a3b8"}}>{d.sender?.address || MIHENG_INFO.address}</div>
                </div>
                <div style={{padding:8,borderRadius:6,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)"}}>
                  <div style={{fontSize:10,color:"#64748b",fontWeight:600,marginBottom:2}}>ALICI</div>
                  <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{d.receiver?.name || d.coatingCompany?.fullName || d.coatingCompany?.name || ""}</div>
                  <div style={{fontSize:11,color:"#94a3b8"}}>{d.receiver?.address || d.coatingCompany?.address || ""}</div>
                </div>
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}><thead><tr style={{borderBottom:"1px solid rgba(255,255,255,0.06)"}}><th style={{padding:"5px 8px",textAlign:"left",color:"#64748b"}}>ƒ∞≈ü Emri</th><th style={{padding:"5px 8px",textAlign:"left",color:"#64748b"}}>√úr√ºn</th><th style={{padding:"5px 8px",textAlign:"left",color:"#64748b"}}>Kaplama</th><th style={{padding:"5px 8px",textAlign:"right",color:"#64748b"}}>Adet</th></tr></thead><tbody>{d.items.map(it=><tr key={it.itemId}><td style={{padding:"5px 8px"}}><button onClick={()=>{const wo=workOrders.find(w=>w.id===it.woId);if(wo)setWoDetail(wo);}} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:12,textDecoration:"underline",fontFamily:"inherit"}}>{it.woId}</button></td><td style={{padding:"5px 8px",color:"#e2e8f0"}}>{it.productCode}</td><td style={{padding:"5px 8px",color:"#14b8a6"}}>{it.coatingType}</td><td style={{padding:"5px 8px",textAlign:"right",color:"#e2e8f0",fontWeight:600}}>{it.qty}</td></tr>)}</tbody>
              <tfoot><tr style={{borderTop:"1px solid rgba(255,255,255,0.08)"}}><td colSpan={3} style={{padding:"5px 8px",textAlign:"right",fontWeight:600,color:"#64748b"}}>Toplam</td><td style={{padding:"5px 8px",textAlign:"right",fontWeight:700,color:"#e2e8f0"}}>{d.items.reduce((s,it)=>s+it.qty,0)}</td></tr></tfoot></table>
              {d.status==="sent"&&hasPerm("coating_edit")&&<div style={{marginTop:10,display:"flex",gap:8}}><Btn variant="success" size="sm" icon={Check} onClick={()=>receiveCoating(d.id)}>Teslim Alƒ±ndƒ±</Btn></div>}
            </div>
          ))}
        </Card>
      </div>
    );
  };

  //  SHIPPING 
  const ShippingPage = () => {
    const ready=workOrders.filter(wo=>wo.items.some(it=>it.woStatus==="shipping"));
    return(
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>Sevkiyat</h2>
        {ready.length===0?<Card style={{textAlign:"center",padding:40}}><Truck size={40} color="#475569" style={{marginBottom:12}}/><div style={{color:"#64748b",fontSize:14}}>Sevke hazƒ±r yok.</div></Card>
        :ready.map(wo=>(
          <Card key={wo.id} style={{marginBottom:12}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}><div style={{display:"flex",alignItems:"center",gap:8}}><button onClick={()=>setWoDetail(wo)} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:700,fontSize:15,textDecoration:"underline",fontFamily:"inherit"}}>{wo.id}</button><OrderTypeBadge type={wo.orderType}/><span style={{fontSize:13,color:"#64748b"}}>{wo.customerName}</span></div><PriorityBadge priority={wo.priority}/></div>
            {wo.items.filter(it=>it.woStatus==="shipping").map(item=>{
              const reject=Number(item.rejectQty)||0;
              const goodQty=(item.qty||0)-reject;
              return(
              <div key={item.id} style={{padding:10,borderRadius:8,background:reject>0?"rgba(245,158,11,0.04)":"rgba(255,255,255,0.02)",border:`1px solid ${reject>0?"rgba(245,158,11,0.15)":"rgba(255,255,255,0.06)"}`,marginBottom:5}}>
                <div style={{display:"flex",justifyContent:"space-between",fontSize:13,color:"#e2e8f0",alignItems:"center"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                    <span style={{fontWeight:600}}>{item.productCode||`√ò${item.diameter} ${item.islem||""}`}</span>
                    {reject>0?(
                      <span>
                        <span style={{color:"#f59e0b",fontWeight:700}}>{goodQty}</span>
                        <span style={{color:"#64748b"}}>/{item.qty} ad</span>
                        <span style={{color:"#ef4444",fontSize:11,marginLeft:4}}>({reject} fire)</span>
                      </span>
                    ):(
                      <span style={{color:"#94a3b8"}}>{item.qty} ad</span>
                    )}
                  </div>
                  {reject>0?(
                    <Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">‚ö† Eksik Teslim</Badge>
                  ):(
                    <Badge color="#10b981" bg="rgba(16,185,129,0.15)">Hazƒ±r ‚úì</Badge>
                  )}
                </div>
                <div style={{marginTop:4}}><PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("shipping_edit")} onUpload={f=>addPdfToWoItem(wo.id,item.id,f,"Sevkiyat")}/></div>
              </div>
            );})}
            {hasPerm("shipping_edit")&&<div style={{display:"flex",gap:8,marginTop:10}}><Btn variant="success" icon={Truck} onClick={()=>completeShipping(wo.id)}>Sevk Et & Fatura</Btn></div>}
          </Card>
        ))}
        {orders.filter(o=>o.status==="completed").length>0&&<Card style={{marginTop:16,border:"1px solid rgba(16,185,129,0.2)"}}><h3 style={{margin:"0 0 10px",color:"#10b981",fontSize:15,fontWeight:600}}>‚úì Fatura Bekleyenler</h3>{orders.filter(o=>o.status==="completed").map(o=><div key={o.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:8,borderRadius:8,background:"rgba(16,185,129,0.05)",marginBottom:5}}><div style={{display:"flex",alignItems:"center",gap:6}}><span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{o.id}</span><span style={{fontSize:12,color:"#64748b"}}>{o.customerName}</span>{canPrice&&<span style={{fontSize:12,color:"#10b981",fontWeight:600}}>{fmtMoney(o.items.reduce((s,i)=>s+(i.qty*(i.unitPrice||0)),0),o.currency)}</span>}</div><Btn variant="outline" size="sm" icon={FileText}>Fatura</Btn></div>)}</Card>}
      </div>
    );
  };

  //  STOCK 
  //  CUTTING PAGE 
  const CuttingPage = () => {
    const [cutModal, setCutModal] = useState(null);
    const pendingCut = workOrders
      .filter(wo => wo.orderType === "production")
      .flatMap(wo => wo.items.filter(it => it.woStatus === "pending" || it.woStatus === "pending_stock").map(it => ({
        ...it, woId: wo.id, customerName: wo.customerName, deliveryDate: wo.deliveryDate,
        priority: wo.priority, orderId: wo.orderId
      })));
    const doneCut = workOrders
      .filter(wo => wo.orderType === "production")
      .flatMap(wo => wo.items.filter(it => it.woStatus === "cut" || it.cutDate).map(it => ({
        ...it, woId: wo.id, customerName: wo.customerName
      })));

    const handlePartialCut = (item, calc) => {
      // Calculate how many pieces can be made with available bars
      const availBars = calc.availableBars;
      const piecesCanMake = availBars * calc.piecesPerBar;
      const partialQty = Math.min(piecesCanMake, item.qty);
      setCutModal({ item, calc, partial: true, partialQty, fullQty: item.qty, missingQty: item.qty - partialQty });
    };

    const handlePurchaseRequest = (item, calc) => {
      const missingBars = calc.barsNeeded - calc.availableBars;
      const mc = MATERIAL_CODES.find(m => m.value === item.materialCode);
      const pr = {
        id: `ST-${Date.now()}`, date: new Date().toISOString(), status: "pending",
        woId: item.woId, itemId: item.id, productCode: item.productCode,
        diameter: item.diameter, materialCode: item.materialCode, materialColor: mc?.color,
        requestedBars: missingBars, requestedQty: item.qty - (calc.availableBars * calc.piecesPerBar),
        note: `√ò${item.diameter}mm ${item.materialCode} ‚Äî ${missingBars} √ßubuk eksik`,
      };
      setPurchaseRequests(p => [...p, pr]);
      // Mark item as waiting for stock
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== item.woId) return wo;
        return { ...wo, items: wo.items.map(it => it.id === item.id ? { ...it, woStatus: "pending_stock", purchaseRequestId: pr.id } : it) };
      }));
    };

    const executeCut = (item, barsUsed, remnantLength, cutQty) => {
      performCutting(item.woId, item.id, barsUsed, remnantLength);
      // If partial, update qty on the cut item and create remainder item
      if (cutQty < item.qty) {
        const remainQty = item.qty - cutQty;
        const remainId = `I${genId()}`;
        setWorkOrders(p => p.map(wo => {
          if (wo.id !== item.woId) return wo;
          const cutItem = wo.items.find(it => it.id === item.id);
          if (!cutItem) return wo;
          return { ...wo, items: [...wo.items.map(it => it.id === item.id ? { ...it, qty: cutQty } : it),
            { ...cutItem, id: remainId, qty: remainQty, woStatus: "pending_stock", cutDate: null, cutBarsUsed: null, cutRemnant: null }
          ]};
        }));
        // Create purchase request for remainder
        const mc = MATERIAL_CODES.find(m => m.value === item.materialCode);
        const barsForRemain = Math.ceil(remainQty / Math.floor(BAR_LENGTH / item.length));
        setPurchaseRequests(p => [...p, {
          id: `ST-${Date.now()}`, date: new Date().toISOString(), status: "pending",
          woId: item.woId, itemId: remainId, productCode: item.productCode,
          diameter: item.diameter, materialCode: item.materialCode, materialColor: mc?.color,
          requestedBars: barsForRemain, requestedQty: remainQty,
          note: `Kƒ±smi kesim ‚Äî kalan ${remainQty} ad i√ßin ${barsForRemain} √ßubuk gerekli`,
        }]);
      }
    };

    return (
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>‚úÇÔ∏è Kesim ƒ∞≈ülemleri</h2>
        <Card style={{marginBottom:16}}>
          <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Kesilecekler ({pendingCut.length})</h3>
          {pendingCut.length === 0 ? (
            <div style={{textAlign:"center",padding:30,color:"#64748b"}}>Kesim bekleyen i≈ü yok ‚úì</div>
          ) : pendingCut.map(item => {
            const calc = calculateCutting(item.diameter, item.materialCode, item.length, item.qty);
            const mc = MATERIAL_CODES.find(m => m.value === item.materialCode);
            const isWaiting = item.woStatus === "pending_stock";
            const hasPR = purchaseRequests.some(pr => pr.itemId === item.id && pr.status !== "received");
            return (
              <div key={`${item.woId}-${item.id}`} style={{padding:14,borderRadius:10,marginBottom:10,
                background: isWaiting ? "rgba(245,158,11,0.06)" : calc.sufficient ? "rgba(255,255,255,0.02)" : "rgba(239,68,68,0.06)",
                border: `1px solid ${isWaiting ? "rgba(245,158,11,0.2)" : calc.sufficient ? "rgba(255,255,255,0.06)" : "rgba(239,68,68,0.2)"}`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1}}>
                    <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                      <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{item.productCode}</span>
                      {item.productType&&<span style={{fontSize:11,color:"#6366f1",padding:"1px 6px",borderRadius:4,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                      {item.toolCode&&<span style={{fontSize:11,color:"#f59e0b",fontWeight:600}}>{item.toolCode}</span>}
                      <Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{item.woId}</Badge>
                      <PriorityBadge priority={item.priority}/>
                      {isWaiting && <Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">‚è≥ Stok Bekleniyor</Badge>}
                    </div>
                    <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
                      {item.customerName} | √ò{item.diameter}mm √ó {item.length}mm | {item.qty} adet | {mc ? <span style={{fontWeight:600,color:mc.color}}>{mc.value}</span> : item.materialCode}
                    </div>
                    <div style={{display:"flex",gap:12,marginTop:8,flexWrap:"wrap",fontSize:12}}>
                      <span style={{color:"#3b82f6"}}>üìä {calc.piecesPerBar} ad/√ßubuk</span>
                      <span style={{color:"#f59e0b"}}>üì¶ Gereken: {calc.barsNeeded} √ßubuk</span>
                      <span style={{color: calc.sufficient ? "#10b981" : "#ef4444"}}>
                        üè≠ Stok: {calc.availableBars} √ßubuk {calc.sufficient ? "‚úì" : `‚úó ${calc.barsNeeded - calc.availableBars} eksik`}
                      </span>
                    </div>
                    <span style={{fontSize:11,color:"#64748b",marginTop:4,display:"block"}}>Termin: {fmtDate(item.deliveryDate)}</span>
                  </div>
                  <div style={{display:"flex",flexDirection:"column",gap:4,marginLeft:12}}>
                    {hasPerm("cutting_edit") && calc.sufficient && (
                      <Btn variant="success" size="sm" icon={Scissors} onClick={() => setCutModal({item, calc})}>Kes ({item.qty} ad)</Btn>
                    )}
                    {hasPerm("cutting_edit") && !calc.sufficient && calc.availableBars > 0 && !isWaiting && (
                      <Btn variant="warning" size="sm" icon={Scissors} onClick={() => handlePartialCut(item, calc)}>
                        Kƒ±smi Kes ({Math.min(calc.availableBars * calc.piecesPerBar, item.qty)} ad)
                      </Btn>
                    )}
                    {hasPerm("cutting_edit") && !calc.sufficient && !hasPR && (
                      <Btn variant="danger" size="sm" icon={ShoppingCart} onClick={() => handlePurchaseRequest(item, calc)}>
                        Satƒ±n Alma Talebi
                      </Btn>
                    )}
                    {hasPR && <Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">üìã Talep Olu≈üturuldu</Badge>}
                    {isWaiting && calc.sufficient && hasPerm("cutting_edit") && (
                      <Btn variant="success" size="sm" icon={Scissors} onClick={() => setCutModal({item, calc})}>Stok Geldi ‚Üí Kes</Btn>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </Card>

        <Card>
          <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Kesimi Tamamlanan ({doneCut.length})</h3>
          {doneCut.length === 0 ? (
            <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Hen√ºz kesilen i≈ü yok</div>
          ) : doneCut.map(item => (
            <div key={`${item.woId}-${item.id}`} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:10,borderRadius:8,background:"rgba(16,185,129,0.04)",border:"1px solid rgba(16,185,129,0.1)",marginBottom:5}}>
              <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                <Check size={14} color="#10b981"/>
                <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{item.productCode}</span>
                {item.productType&&<span style={{fontSize:10,color:"#6366f1",padding:"1px 5px",borderRadius:3,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                {item.toolCode&&<span style={{fontSize:10,color:"#f59e0b",fontWeight:600}}>{item.toolCode}</span>}
                <span style={{fontSize:12,color:"#64748b"}}>{item.customerName} | √ò{item.diameter}√ó{item.length}mm | {item.qty}ad</span>
                {item.cutBarsUsed && <span style={{fontSize:11,color:"#3b82f6"}}>{item.cutBarsUsed} √ßubuk</span>}
              </div>
              <Badge color={["grinding","grinding_dispatch","grinding_shipped"].includes(item.woStatus)?"#d946ef":"#10b981"} bg={["grinding","grinding_dispatch","grinding_shipped"].includes(item.woStatus)?"rgba(217,70,239,0.15)":"rgba(16,185,129,0.15)"}>
                {item.woStatus==="grinding"?"üîß Ta≈ülamada":item.woStatus==="grinding_dispatch"?"üîß Kares Sevk Bekl.":item.woStatus==="grinding_shipped"?"üì¶ Kares'te":"Kesildi ‚úì"}
              </Badge>
            </div>
          ))}
        </Card>

        {cutModal && (
          <Modal title={cutModal.partial ? "‚úÇÔ∏è Kƒ±smi Kesim" : "‚úÇÔ∏è Kesim Onayƒ±"} onClose={() => setCutModal(null)} width={520}>
            <div style={{padding:"8px 0"}}>
              <div style={{padding:14,borderRadius:10,background:"rgba(99,102,241,0.08)",border:"1px solid rgba(99,102,241,0.2)",marginBottom:16}}>
                <div style={{fontSize:15,fontWeight:700,color:"#e2e8f0"}}>{cutModal.item.productCode}</div>
                <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
                  {cutModal.item.customerName} | √ò{cutModal.item.diameter}mm √ó {cutModal.item.length}mm | {cutModal.item.qty} adet | {(()=>{const mc=MATERIAL_CODES.find(m=>m.value===cutModal.item.materialCode);return mc?<span style={{fontWeight:600,color:mc.color}}>{mc.value}</span>:cutModal.item.materialCode;})()}
                </div>
              </div>
              {cutModal.partial && (
                <div style={{padding:12,borderRadius:8,background:"rgba(245,158,11,0.08)",border:"1px solid rgba(245,158,11,0.2)",marginBottom:14}}>
                  <div style={{fontSize:13,color:"#f59e0b",fontWeight:600}}>‚ö†Ô∏è Kƒ±smi Kesim</div>
                  <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
                    Toplam sipari≈ü: <strong style={{color:"#e2e8f0"}}>{cutModal.fullQty}</strong> adet ‚Üí
                    ≈ûimdi kesilecek: <strong style={{color:"#10b981"}}>{cutModal.partialQty}</strong> adet |
                    Kalan: <strong style={{color:"#ef4444"}}>{cutModal.missingQty}</strong> adet (stok bekleniyor)
                  </div>
                </div>
              )}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:16}}>
                <div style={{padding:12,borderRadius:8,background:"rgba(59,130,246,0.06)",border:"1px solid rgba(59,130,246,0.15)",textAlign:"center"}}>
                  <div style={{fontSize:11,color:"#64748b",marginBottom:4}}>Par√ßa / √áubuk</div>
                  <div style={{fontSize:22,fontWeight:800,color:"#3b82f6"}}>{cutModal.calc.piecesPerBar}</div>
                </div>
                <div style={{padding:12,borderRadius:8,background:"rgba(245,158,11,0.06)",border:"1px solid rgba(245,158,11,0.15)",textAlign:"center"}}>
                  <div style={{fontSize:11,color:"#64748b",marginBottom:4}}>Kullanƒ±lacak √áubuk</div>
                  <div style={{fontSize:22,fontWeight:800,color:"#f59e0b"}}>{cutModal.partial ? cutModal.calc.availableBars : cutModal.calc.barsNeeded}</div>
                </div>
              </div>
              {(() => {
                const barsUsed = cutModal.partial ? cutModal.calc.availableBars : cutModal.calc.barsNeeded;
                const lastRem = cutModal.calc.lastBarRemnant;
                const fullRem = cutModal.calc.fullBarRemnant;
                return <>
                  {lastRem > 0 && (
                    <div style={{padding:10,borderRadius:8,background:"rgba(139,92,246,0.06)",border:"1px solid rgba(139,92,246,0.15)",marginBottom:14}}>
                      <div style={{fontSize:12,color:"#8b5cf6",fontWeight:600}}>
                        ‚ôªÔ∏è Son √ßubuktan kalan: {lastRem}mm ‚Üí {getRemnantRange(lastRem)?.label || "Hurda"} stok grubuna eklenecek
                      </div>
                      {fullRem > 0 && barsUsed > 1 && (
                        <div style={{fontSize:11,color:"#94a3b8",marginTop:4}}>
                          Diƒüer {barsUsed - 1} √ßubuktan kalan: {fullRem}mm √ó {barsUsed - 1} ‚Üí {getRemnantRange(fullRem)?.label || "Hurda"}
                        </div>
                      )}
                    </div>
                  )}
                  <div style={{padding:10,borderRadius:8,background:"rgba(255,255,255,0.03)",marginBottom:16}}>
                    <div style={{fontSize:12,color:"#94a3b8"}}>
                      Stoktan <strong style={{color:"#ef4444"}}>{barsUsed}</strong> adet √ò{cutModal.item.diameter}mm {cutModal.item.materialCode} √ßubuk d√º≈ü√ºr√ºlecek.
                      {" "}Mevcut: <strong style={{color:"#e2e8f0"}}>{cutModal.calc.availableBars}</strong> ‚Üí Kalan: <strong style={{color:(cutModal.calc.availableBars - barsUsed) < 50 ? "#f59e0b" : "#10b981"}}>{cutModal.calc.availableBars - barsUsed}</strong>
                    </div>
                  </div>
                </>;
              })()}
              <div style={{display:"flex",justifyContent:"flex-end",gap:8}}>
                <Btn variant="ghost" onClick={() => setCutModal(null)}>ƒ∞ptal</Btn>
                <Btn variant="success" icon={Scissors} onClick={() => {
                  if (cutModal.partial) {
                    executeCut(cutModal.item, cutModal.calc.availableBars, BAR_LENGTH - (cutModal.calc.piecesPerBar * cutModal.item.length), cutModal.partialQty);
                  } else {
                    performCutting(cutModal.item.woId, cutModal.item.id, cutModal.calc.barsNeeded, cutModal.calc.lastBarRemnant);
                  }
                  setCutModal(null);
                }}>{cutModal.partial ? `Kƒ±smi Kes (${cutModal.partialQty} ad)` : "Kesimi Onayla"}</Btn>
              </div>
            </div>
          </Modal>
        )}
      </div>
    );
  };

  //  GRINDING PAGE (Ta≈ülama) 
  const GrindingPage = () => {
    const [karesModal, setKaresModal] = useState(null);
    const [selectedKares, setSelectedKares] = useState([]);
    const [localGrind, setLocalGrind] = useState({});
    const grindKey = (woId, itemId, field) => `${woId}_${itemId}_${field}`;
    const getGrindVal = (woId, itemId, field, fallback) => {
      const k = grindKey(woId, itemId, field);
      return k in localGrind ? localGrind[k] : (fallback || "");
    };
    const setGrindVal = (woId, itemId, field, val) => {
      setLocalGrind(p => ({...p, [grindKey(woId, itemId, field)]: val}));
    };
    const syncGrindVal = (woId, itemId, field) => {
      const k = grindKey(woId, itemId, field);
      if (k in localGrind) {
        updateKaresDispatchFields(woId, itemId, {[field]: localGrind[k]});
      }
    };

    // Studer / S22 internal grinding items
    const internalItems = workOrders.filter(wo => wo.orderType === "production")
      .flatMap(wo => wo.items.filter(it => it.woStatus === "grinding")
        .map(it => ({ ...it, woId: wo.id, customerName: wo.customerName, deliveryDate: wo.deliveryDate, priority: wo.priority })));

    // Kares dispatch pending
    const karesDispatch = workOrders.filter(wo => wo.orderType === "production")
      .flatMap(wo => wo.items.filter(it => it.woStatus === "grinding_dispatch")
        .map(it => ({ ...it, woId: wo.id, customerName: wo.customerName, deliveryDate: wo.deliveryDate, priority: wo.priority })));

    // Kares shipped (at Kares)
    const karesShipped = workOrders.filter(wo => wo.orderType === "production")
      .flatMap(wo => wo.items.filter(it => it.woStatus === "grinding_shipped")
        .map(it => ({ ...it, woId: wo.id, customerName: wo.customerName, deliveryDate: wo.deliveryDate, priority: wo.priority })));

    const toggleKaresSelect = (woId, id) => {
      const k = `${woId}-${id}`;
      setSelectedKares(p => p.includes(k) ? p.filter(x => x !== k) : [...p, k]);
    };
    const isKaresSelected = (woId, id) => selectedKares.includes(`${woId}-${id}`);

    const canCreateKaresWaybill = () => {
      const items = karesDispatch.filter(it => isKaresSelected(it.woId, it.id));
      return items.length > 0 && items.every(it => {
        const dia = getGrindVal(it.woId, it.id, "grindDiameter", it.grindDiameter);
        const len = getGrindVal(it.woId, it.id, "grindLength", it.grindLength);
        return dia && len;
      });
    };

    const handleCreateWaybill = () => {
      // Sync all local grind values before creating waybill
      const items = karesDispatch.filter(it => isKaresSelected(it.woId, it.id));
      items.forEach(it => {
        const updates = {};
        const dia = getGrindVal(it.woId, it.id, "grindDiameter", it.grindDiameter);
        const len = getGrindVal(it.woId, it.id, "grindLength", it.grindLength);
        const tol = getGrindVal(it.woId, it.id, "grindTolerance", it.grindTolerance);
        if (dia) updates.grindDiameter = dia;
        if (len) updates.grindLength = len;
        if (tol) updates.grindTolerance = tol;
        if (Object.keys(updates).length > 0) updateKaresDispatchFields(it.woId, it.id, updates);
      });
      setTimeout(() => {
        const items2 = karesDispatch.filter(it => isKaresSelected(it.woId, it.id));
        if (items2.length === 0) return;
        createKaresWaybill(items2);
        setSelectedKares([]);
        setLocalGrind({});
      }, 50);
    };

    const selectAllKares = () => {
      const all = karesDispatch.map(it => `${it.woId}-${it.id}`);
      const allSel = all.every(k => selectedKares.includes(k));
      setSelectedKares(allSel ? [] : all);
    };

    // Print waybill
    const GrindWaybillPrint = ({ d }) => {
      const printNote = () => {
        const w = window.open("", "_blank", "width=800,height=600");
        if (!w) return;
        w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>ƒ∞rsaliye ${d.id}</title>
          <style>body{font-family:Arial,sans-serif;padding:30px;color:#333;font-size:13px}
          h1{font-size:20px;margin-bottom:5px} .header{display:flex;justify-content:space-between;margin-bottom:20px;border-bottom:2px solid #333;padding-bottom:15px}
          .box{border:1px solid #ccc;padding:12px;border-radius:6px;margin-bottom:12px} .box h3{margin:0 0 6px;font-size:13px;color:#666}
          table{width:100%;border-collapse:collapse;margin-top:15px} th,td{border:1px solid #ccc;padding:8px 10px;text-align:left;font-size:12px}
          th{background:#f5f5f5;font-weight:bold} .footer{margin-top:40px;display:flex;justify-content:space-between}
          .sign-box{width:200px;border-top:1px solid #333;padding-top:8px;text-align:center;font-size:11px;color:#666}
          @media print{body{padding:15px}}</style></head><body>
          <div class="header"><div><h1>TA≈ûLAMA ƒ∞RSALƒ∞YESƒ∞</h1><div style="color:#666">${d.id}</div></div><div style="text-align:right"><div style="font-weight:bold">Tarih</div><div>${fmtDate(d.date)}</div></div></div>
          <div style="display:flex;gap:20px;margin-bottom:20px">
            <div class="box" style="flex:1"><h3>G√ñNDERƒ∞Cƒ∞</h3><div style="font-weight:bold">${d.sender?.name || MIHENG_INFO.name}</div><div>${d.sender?.address || MIHENG_INFO.address}</div></div>
            <div class="box" style="flex:1"><h3>ALICI</h3><div style="font-weight:bold">${d.receiver?.name || ""}</div><div>${d.receiver?.address || ""}</div></div>
          </div>
          <table><thead><tr><th>#</th><th>ƒ∞≈ü Emri</th><th>√úr√ºn</th><th>Hammadde √áapƒ±</th><th>Takƒ±m √áapƒ±</th><th>Tolerans</th><th>Ta≈ülama Boyu</th><th>Adet</th></tr></thead><tbody>
          ${d.items.map((it, i) => `<tr><td>${i + 1}</td><td>${it.woId}</td><td>${it.productCode}${it.toolCode ? " / " + it.toolCode : ""}</td><td>√ò${it.rawDiameter}mm</td><td>√ò${it.toolDiameter}mm</td><td>${it.grindTolerance || "-"}</td><td>${it.grindLength}mm</td><td style="text-align:right;font-weight:bold">${it.qty}</td></tr>`).join("")}
          <tr style="font-weight:bold;background:#f9f9f9"><td colspan="7" style="text-align:right">TOPLAM</td><td style="text-align:right">${d.items.reduce((s, it) => s + it.qty, 0)}</td></tr>
          </tbody></table>
          <div class="footer"><div class="sign-box">Teslim Eden</div><div class="sign-box">Teslim Alan</div></div>
          </body></html>`);
        w.document.close();
        setTimeout(() => w.print(), 300);
      };
      return <Btn variant="ghost" size="sm" icon={Printer} onClick={printNote}>Yazdƒ±r</Btn>;
    };

    return (
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>üîß Ta≈ülama ƒ∞≈ülemleri</h2>

        {/* ‚îÄ‚îÄ STUDER / S22 ƒ∞√ß Ta≈ülama ‚îÄ‚îÄ */}
        <Card style={{marginBottom:16}}>
          <h3 style={{margin:"0 0 14px",color:"#d946ef",fontSize:15,fontWeight:600}}>Studer Ta≈ülama ({internalItems.length})</h3>
          {internalItems.length === 0 ? (
            <div style={{textAlign:"center",padding:30,color:"#64748b"}}>ƒ∞√ß ta≈ülama bekleyen i≈ü yok ‚úì</div>
          ) : internalItems.map(item => (
            <div key={`${item.woId}-${item.id}`} style={{padding:14,borderRadius:10,marginBottom:8,background:"rgba(217,70,239,0.05)",border:"1px solid rgba(217,70,239,0.15)"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                <div>
                  <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                    <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{item.productCode}</span>
                    {item.productType&&<span style={{fontSize:11,color:"#6366f1",padding:"1px 6px",borderRadius:4,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                    {item.toolCode&&<span style={{fontSize:11,color:"#f59e0b",fontWeight:600}}>{item.toolCode}</span>}
                    <Badge color="#d946ef" bg="rgba(217,70,239,0.15)">{item.grindingType}</Badge>
                    <Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{item.woId}</Badge>
                    <PriorityBadge priority={item.priority}/>
                  </div>
                  <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
                    {item.customerName} | √ò{item.diameter}mm √ó {item.length}mm | {item.qty} adet
                    {item.grindMachineId && (()=>{const m=machines.find(mm=>mm.id===item.grindMachineId);return m?<span style={{color:"#d946ef",fontWeight:600,marginLeft:8}}>üîß {m.name}</span>:null;})()}
                  </div>
                  <div style={{fontSize:11,color:"#64748b",marginTop:4}}>Termin: {fmtDate(item.deliveryDate)}</div>
                </div>
                {hasPerm("grinding_edit") && (
                  <Btn variant="success" size="sm" icon={Check} onClick={() => completeInternalGrinding(item.woId, item.id)}>Ta≈ülama Tamam</Btn>
                )}
              </div>
            </div>
          ))}
        </Card>

        {/* ‚îÄ‚îÄ KARES SEVK BEKLƒ∞YOR ‚îÄ‚îÄ */}
        <Card style={{marginBottom:16}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
            <h3 style={{margin:0,color:"#ef4444",fontSize:15,fontWeight:600}}>Kares Ta≈ülama ‚Äî Sevk Bekliyor ({karesDispatch.length})</h3>
            <div style={{display:"flex",gap:6}}>
              {karesDispatch.length > 0 && <Btn variant="ghost" size="sm" onClick={selectAllKares}>{selectedKares.length === karesDispatch.length ? "Se√ßimi Kaldƒ±r" : "T√ºm√ºn√º Se√ß"}</Btn>}
              {hasPerm("grinding_edit") && canCreateKaresWaybill() && (
                <Btn variant="warning" size="sm" icon={Truck} onClick={handleCreateWaybill}>ƒ∞rsaliye Olu≈ütur ({selectedKares.length})</Btn>
              )}
            </div>
          </div>
          {karesDispatch.length === 0 ? (
            <div style={{textAlign:"center",padding:30,color:"#64748b"}}>Kares sevk bekleyen i≈ü yok ‚úì</div>
          ) : karesDispatch.map(item => {
            const mc = MATERIAL_CODES.find(m => m.value === item.materialCode);
            return (
              <div key={`${item.woId}-${item.id}`} style={{padding:14,borderRadius:10,marginBottom:8,
                background: isKaresSelected(item.woId, item.id) ? "rgba(239,68,68,0.08)" : "rgba(255,255,255,0.02)",
                border: `1px solid ${isKaresSelected(item.woId, item.id) ? "rgba(239,68,68,0.3)" : "rgba(255,255,255,0.06)"}`}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                  <div style={{flex:1}}>
                    <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
                      <label style={{display:"flex",alignItems:"center",gap:4,cursor:"pointer"}}>
                        <input type="checkbox" checked={isKaresSelected(item.woId, item.id)} onChange={() => toggleKaresSelect(item.woId, item.id)}/>
                      </label>
                      <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{item.productCode}</span>
                      {item.productType&&<span style={{fontSize:11,color:"#6366f1",padding:"1px 6px",borderRadius:4,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                      {item.toolCode&&<span style={{fontSize:11,color:"#f59e0b",fontWeight:600}}>{item.toolCode}</span>}
                      <Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{item.woId}</Badge>
                      <PriorityBadge priority={item.priority}/>
                    </div>
                    <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
                      {item.customerName} | Hammadde √ò{item.diameter}mm | {item.qty} adet | {mc ? <span style={{fontWeight:600,color:mc.color}}>{mc.value}</span> : item.materialCode}
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginTop:8,maxWidth:540}}>
                      <div>
                        <div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:2}}>Ta≈ülama √áapƒ± (mm)</div>
                        <LocalInput type="text" inputMode="decimal" value={getGrindVal(item.woId, item.id, "grindDiameter", item.grindDiameter)} placeholder={`${item.diameter}`}
                          onChange={val => setGrindVal(item.woId, item.id, "grindDiameter", val)}
                          onBlur={() => syncGrindVal(item.woId, item.id, "grindDiameter")}
                          style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(239,68,68,0.3)",background:"rgba(239,68,68,0.06)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit"}}/>
                      </div>
                      <div>
                        <div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:2}}>Tolerans</div>
                        <LocalInput type="text" value={getGrindVal(item.woId, item.id, "grindTolerance", item.grindTolerance)} placeholder="h6, ¬±0.01..."
                          onChange={val => setGrindVal(item.woId, item.id, "grindTolerance", val)}
                          onBlur={() => syncGrindVal(item.woId, item.id, "grindTolerance")}
                          style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(168,85,247,0.3)",background:"rgba(168,85,247,0.06)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit"}}/>
                      </div>
                      <div>
                        <div style={{fontSize:10,fontWeight:600,color:"#94a3b8",marginBottom:2}}>Ta≈ülama Boyu (mm)</div>
                        <LocalInput type="text" inputMode="decimal" value={getGrindVal(item.woId, item.id, "grindLength", item.grindLength)} placeholder={`${item.length}`}
                          onChange={val => setGrindVal(item.woId, item.id, "grindLength", val)}
                          onBlur={() => syncGrindVal(item.woId, item.id, "grindLength")}
                          style={{width:"100%",padding:"6px 8px",borderRadius:6,border:"1px solid rgba(239,68,68,0.3)",background:"rgba(239,68,68,0.06)",color:"#e2e8f0",fontSize:13,fontFamily:"inherit"}}/>
                      </div>
                    </div>
                    <div style={{fontSize:11,color:"#64748b",marginTop:6}}>Termin: {fmtDate(item.deliveryDate)}</div>
                  </div>
                </div>
              </div>
            );
          })}
        </Card>

        {/* ‚îÄ‚îÄ KARES'TE OLANLAR ‚îÄ‚îÄ */}
        {karesShipped.length > 0 && (
          <Card style={{marginBottom:16}}>
            <h3 style={{margin:"0 0 14px",color:"#f59e0b",fontSize:15,fontWeight:600}}>Kares'te ‚Äî Ta≈ülama Yapƒ±lƒ±yor ({karesShipped.length})</h3>
            {karesShipped.map(item => (
              <div key={`${item.woId}-${item.id}`} style={{padding:10,borderRadius:8,background:"rgba(245,158,11,0.05)",border:"1px solid rgba(245,158,11,0.1)",marginBottom:5}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <span style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{item.productCode}</span>
                    {item.productType&&<span style={{fontSize:10,color:"#6366f1",padding:"1px 5px",borderRadius:3,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                    <span style={{fontSize:12,color:"#94a3b8"}}>{item.customerName} | {item.qty} ad</span>
                    <Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">üì¶ Kares'te</Badge>
                  </div>
                </div>
              </div>
            ))}
          </Card>
        )}

        {/* ‚îÄ‚îÄ KARES ƒ∞RSALƒ∞YELER ‚îÄ‚îÄ */}
        <Card>
          <h3 style={{margin:"0 0 12px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Kares ƒ∞rsaliyeleri ({grindingQueue.length})</h3>
          {grindingQueue.length === 0 ? (
            <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Hen√ºz irsaliye yok</div>
          ) : grindingQueue.map(d => (
            <div key={d.id} style={{padding:14,borderRadius:10,marginBottom:10,
              background: d.status === "sent" ? "rgba(239,68,68,0.05)" : "rgba(16,185,129,0.05)",
              border: `1px solid ${d.status === "sent" ? "rgba(239,68,68,0.15)" : "rgba(16,185,129,0.15)"}`}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                <div style={{display:"flex",alignItems:"center",gap:8}}>
                  <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{d.id}</span>
                  <Badge color={d.status === "sent" ? "#ef4444" : "#10b981"} bg={d.status === "sent" ? "rgba(239,68,68,0.15)" : "rgba(16,185,129,0.15)"}>
                    {d.status === "sent" ? "G√∂nderildi" : "Teslim Alƒ±ndƒ±"}
                  </Badge>
                </div>
                <div style={{display:"flex",alignItems:"center",gap:6}}>
                  <span style={{fontSize:12,color:"#64748b"}}>{fmtDateTime(d.date)}</span>
                  <GrindWaybillPrint d={d}/>
                </div>
              </div>
              {/* Sender / Receiver */}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:10}}>
                <div style={{padding:8,borderRadius:6,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)"}}>
                  <div style={{fontSize:10,color:"#64748b",fontWeight:600,marginBottom:2}}>G√ñNDERƒ∞Cƒ∞</div>
                  <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{d.sender?.name}</div>
                  <div style={{fontSize:11,color:"#94a3b8"}}>{d.sender?.address}</div>
                </div>
                <div style={{padding:8,borderRadius:6,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.06)"}}>
                  <div style={{fontSize:10,color:"#64748b",fontWeight:600,marginBottom:2}}>ALICI</div>
                  <div style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{d.receiver?.name}</div>
                  <div style={{fontSize:11,color:"#94a3b8"}}>{d.receiver?.address}</div>
                </div>
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
                <thead><tr style={{borderBottom:"1px solid rgba(255,255,255,0.06)"}}>
                  <th style={{padding:"5px 8px",textAlign:"left",color:"#64748b"}}>ƒ∞≈ü Emri</th>
                  <th style={{padding:"5px 8px",textAlign:"left",color:"#64748b"}}>√úr√ºn</th>
                  <th style={{padding:"5px 8px",textAlign:"center",color:"#64748b"}}>Hammadde √áapƒ±</th>
                  <th style={{padding:"5px 8px",textAlign:"center",color:"#64748b"}}>Takƒ±m √áapƒ±</th>
                  <th style={{padding:"5px 8px",textAlign:"center",color:"#64748b"}}>Tolerans</th>
                  <th style={{padding:"5px 8px",textAlign:"center",color:"#64748b"}}>Ta≈ülama Boyu</th>
                  <th style={{padding:"5px 8px",textAlign:"right",color:"#64748b"}}>Adet</th>
                </tr></thead>
                <tbody>{d.items.map(it => (
                  <tr key={it.itemId}>
                    <td style={{padding:"5px 8px"}}><button onClick={() => { const wo = workOrders.find(w => w.id === it.woId); if (wo) setWoDetail(wo); }} style={{background:"none",border:"none",color:"#6366f1",cursor:"pointer",fontWeight:600,fontSize:12,textDecoration:"underline",fontFamily:"inherit"}}>{it.woId}</button></td>
                    <td style={{padding:"5px 8px",color:"#e2e8f0"}}>{it.productCode}{it.toolCode ? <span style={{color:"#f59e0b",marginLeft:6}}>{it.toolCode}</span> : null}</td>
                    <td style={{padding:"5px 8px",textAlign:"center",color:"#94a3b8"}}>√ò{it.rawDiameter}mm</td>
                    <td style={{padding:"5px 8px",textAlign:"center",color:"#e2e8f0",fontWeight:600}}>√ò{it.toolDiameter}mm</td>
                    <td style={{padding:"5px 8px",textAlign:"center",color:"#a855f7",fontWeight:600}}>{it.grindTolerance||"-"}</td>
                    <td style={{padding:"5px 8px",textAlign:"center",color:"#e2e8f0",fontWeight:600}}>{it.grindLength}mm</td>
                    <td style={{padding:"5px 8px",textAlign:"right",color:"#e2e8f0",fontWeight:600}}>{it.qty}</td>
                  </tr>
                ))}</tbody>
                <tfoot><tr style={{borderTop:"1px solid rgba(255,255,255,0.08)"}}>
                  <td colSpan={6} style={{padding:"5px 8px",textAlign:"right",fontWeight:600,color:"#64748b"}}>Toplam</td>
                  <td style={{padding:"5px 8px",textAlign:"right",fontWeight:700,color:"#e2e8f0"}}>{d.items.reduce((s, it) => s + it.qty, 0)}</td>
                </tr></tfoot>
              </table>
              {d.status === "sent" && hasPerm("grinding_edit") && (
                <div style={{marginTop:10,display:"flex",gap:8}}>
                  <Btn variant="success" size="sm" icon={Check} onClick={() => receiveKaresGrinding(d.id)}>Teslim Alƒ±ndƒ± ‚Äî Ta≈ülama Tamam</Btn>
                </div>
              )}
            </div>
          ))}
        </Card>
      </div>
    );
  };

  //  PURCHASING PAGE 
  const PurchasingPage = () => {
    const pending = purchaseRequests.filter(pr => pr.status === "pending");
    const ordered = purchaseRequests.filter(pr => pr.status === "ordered");
    const received = purchaseRequests.filter(pr => pr.status === "received");

    const markOrdered = (prId) => {
      setPurchaseRequests(p => p.map(pr => pr.id === prId ? { ...pr, status: "ordered", orderedDate: new Date().toISOString() } : pr));
    };

    const markReceived = (prId) => {
      const pr = purchaseRequests.find(p => p.id === prId);
      if (!pr) return;
      setPurchaseRequests(p => p.map(x => x.id === prId ? { ...x, status: "received", receivedDate: new Date().toISOString() } : x));
      // Add bars to stock
      setBarStock(prev => {
        const idx = prev.findIndex(s => s.diameter === pr.diameter && s.materialCode === pr.materialCode);
        if (idx >= 0) {
          const updated = [...prev];
          updated[idx] = { ...updated[idx], fullBars: updated[idx].fullBars + pr.requestedBars };
          return updated;
        }
        const emptyRemnants = {};
        REMNANT_RANGES.forEach(r => { emptyRemnants[r.key] = 0; });
        return [...prev, { id: `BS-${pr.materialCode}-${pr.diameter}`, diameter: pr.diameter, materialCode: pr.materialCode, fullBars: pr.requestedBars, remnants: emptyRemnants }];
      });
      // Update WO item back to pending (ready for cutting)
      setWorkOrders(p => p.map(wo => {
        if (wo.id !== pr.woId) return wo;
        return { ...wo, items: wo.items.map(it => {
          if (it.id === pr.itemId && it.woStatus === "pending_stock") return { ...it, woStatus: "pending", purchaseRequestId: null };
          return it;
        })};
      }));
    };

    const PrRow = ({ pr, actions }) => {
      const mc = MATERIAL_CODES.find(m => m.value === pr.materialCode);
      return (
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:12,borderRadius:8,
          background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:6}}>
          <div style={{flex:1}}>
            <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
              <span style={{fontSize:13,fontWeight:700,color:"#e2e8f0"}}>{pr.id}</span>
              <Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{pr.woId}</Badge>
              {mc && <span style={{display:"inline-flex",alignItems:"center",gap:4,fontSize:12,fontWeight:600,color:mc.color}}>
                <span style={{width:10,height:10,borderRadius:3,background:mc.color,display:"inline-block"}}/>
                {mc.value}
              </span>}
              <span style={{fontSize:12,color:"#94a3b8"}}>√ò{pr.diameter}mm</span>
            </div>
            <div style={{fontSize:12,color:"#94a3b8",marginTop:4}}>
              {pr.requestedBars} √ßubuk (330mm) | {pr.requestedQty} adet √ºr√ºn i√ßin | {pr.note}
            </div>
            <div style={{fontSize:11,color:"#64748b",marginTop:2}}>Talep: {fmtDate(pr.date)}{pr.orderedDate ? ` | Sipari≈ü: ${fmtDate(pr.orderedDate)}` : ""}{pr.receivedDate ? ` | Teslim: ${fmtDate(pr.receivedDate)}` : ""}</div>
          </div>
          <div style={{display:"flex",gap:6,marginLeft:12}}>{actions}</div>
        </div>
      );
    };

    return (
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>üõí Satƒ±n Alma</h2>
        <Card style={{marginBottom:16}}>
          <h3 style={{margin:"0 0 12px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Bekleyen Talepler ({pending.length})</h3>
          {pending.length === 0 ? <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Talep yok ‚úì</div> :
            pending.map(pr => <PrRow key={pr.id} pr={pr} actions={
              hasPerm("purchasing_edit") && <Btn variant="primary" size="sm" icon={ShoppingCart} onClick={() => markOrdered(pr.id)}>Sipari≈ü Verildi</Btn>
            }/>)
          }
        </Card>
        <Card style={{marginBottom:16}}>
          <h3 style={{margin:"0 0 12px",color:"#f59e0b",fontSize:15,fontWeight:600}}>Sipari≈ü Verilen ({ordered.length})</h3>
          {ordered.length === 0 ? <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Yok</div> :
            ordered.map(pr => <PrRow key={pr.id} pr={pr} actions={
              hasPerm("purchasing_edit") && <Btn variant="success" size="sm" icon={Check} onClick={() => markReceived(pr.id)}>Stok Geldi</Btn>
            }/>)
          }
        </Card>
        <Card>
          <h3 style={{margin:"0 0 12px",color:"#10b981",fontSize:15,fontWeight:600}}>Tamamlanan ({received.length})</h3>
          {received.length === 0 ? <div style={{textAlign:"center",padding:20,color:"#64748b",fontSize:13}}>Yok</div> :
            received.map(pr => <PrRow key={pr.id} pr={pr} actions={<Badge color="#10b981" bg="rgba(16,185,129,0.15)">Teslim Alƒ±ndƒ± ‚úì</Badge>}/>)
          }
        </Card>
      </div>
    );
  };

  //  STOCK PAGE (Tam √áubuk + Fire) 
  const StockPage = () => {
    const [stockTab, setStockTab] = useState("bars");
    const [filterGrade, setFilterGrade] = useState("");
    const [filterDia, setFilterDia] = useState("");
    const grades = [...new Set(barStock.map(s => s.materialCode))].sort();
    const diameters = [...new Set(barStock.map(s => s.diameter))].sort((a, b) => a - b);
    const filtered = barStock.filter(s =>
      (!filterGrade || s.materialCode === filterGrade) &&
      (!filterDia || s.diameter === Number(filterDia))
    );

    // Stock edit for manual adjustments
    const adjustStock = (id, field, delta) => {
      setBarStock(prev => prev.map(s => {
        if (s.id !== id) return s;
        if (field === "fullBars") return { ...s, fullBars: Math.max(0, s.fullBars + delta) };
        return { ...s, remnants: { ...s.remnants, [field]: Math.max(0, (s.remnants[field] || 0) + delta) } };
      }));
    };

    return (
      <div>
        <h2 style={{margin:"0 0 20px",color:"#f1f5f9",fontSize:22,fontWeight:700}}>üì¶ Hammadde & Fire Stok</h2>
        <div style={{marginBottom:16}}><TabSwitcher tabs={[{key:"bars",label:"Tam √áubuk (330mm)",icon:Box},{key:"remnants",label:"Fire Stok",icon:Layers}]} active={stockTab} onChange={setStockTab}/></div>

        {/* Filters */}
        <Card style={{marginBottom:16}}>
          <div style={{display:"flex",gap:12,flexWrap:"wrap",alignItems:"flex-end"}}>
            <div style={{minWidth:140}}><Input label="Kalite" value={filterGrade} onChange={setFilterGrade} options={[{value:"",label:"T√ºm√º"},...grades.map(g=>({value:g,label:g}))]}/></div>
            <div style={{minWidth:120}}><Input label="√áap" value={filterDia} onChange={setFilterDia} options={[{value:"",label:"T√ºm√º"},...diameters.map(d=>({value:String(d),label:`√ò${d}mm`}))]}/></div>
            <div style={{fontSize:12,color:"#64748b"}}>{filtered.length} kayƒ±t</div>
          </div>
        </Card>

        {stockTab === "bars" ? (
          <Card>
            <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Tam √áubuk Stok (1 ad = 330mm)</h3>
            <div style={{overflowX:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse"}}>
                <thead><tr style={{borderBottom:"1px solid rgba(255,255,255,0.08)"}}>
                  {["Kalite","√áap","Stok (adet)","Durum",""].map(h=><th key={h} style={{padding:"10px 12px",textAlign:"left",fontSize:11,color:"#64748b",fontWeight:600,textTransform:"uppercase"}}>{h}</th>)}
                </tr></thead>
                <tbody>{filtered.sort((a,b)=>a.materialCode.localeCompare(b.materialCode)||a.diameter-b.diameter).map(s=>(
                  <tr key={s.id} style={{borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
                    <td style={{padding:"10px 12px",fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{s.materialCode}</td>
                    <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>√ò{s.diameter}mm</td>
                    <td style={{padding:"10px 12px"}}>
                      <div style={{display:"flex",alignItems:"center",gap:8}}>
                        <span style={{fontSize:15,fontWeight:700,color:s.fullBars<20?"#ef4444":s.fullBars<50?"#f59e0b":"#e2e8f0",minWidth:50}}>{s.fullBars}</span>
                        {hasPerm("stock_edit")&&<>
                          <button onClick={()=>adjustStock(s.id,"fullBars",-1)} style={{width:24,height:24,borderRadius:5,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(239,68,68,0.1)",color:"#ef4444",cursor:"pointer",fontSize:14,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center"}}>-</button>
                          <button onClick={()=>adjustStock(s.id,"fullBars",1)} style={{width:24,height:24,borderRadius:5,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(16,185,129,0.1)",color:"#10b981",cursor:"pointer",fontSize:14,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center"}}>+</button>
                          <button onClick={()=>adjustStock(s.id,"fullBars",10)} style={{padding:"2px 6px",borderRadius:5,border:"1px solid rgba(255,255,255,0.1)",background:"rgba(59,130,246,0.1)",color:"#3b82f6",cursor:"pointer",fontSize:10,fontWeight:600}}>+10</button>
                        </>}
                      </div>
                    </td>
                    <td style={{padding:"10px 12px"}}>{s.fullBars<20?<Badge color="#ef4444" bg="rgba(239,68,68,0.15)">Kritik</Badge>:s.fullBars<50?<Badge color="#f59e0b" bg="rgba(245,158,11,0.15)">D√º≈ü√ºk</Badge>:<Badge color="#10b981" bg="rgba(16,185,129,0.15)">Yeterli</Badge>}</td>
                    <td style={{padding:"10px 12px"}}>
                      {Object.entries(s.remnants).filter(([,v])=>v>0).length>0&&<span style={{fontSize:10,color:"#8b5cf6"}}>‚ôªÔ∏è {Object.entries(s.remnants).filter(([,v])=>v>0).map(([k,v])=>`${REMNANT_RANGES.find(r=>r.key===k)?.label}:${v}`).join(", ")}</span>}
                    </td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </Card>
        ) : (
          <Card>
            <h3 style={{margin:"0 0 14px",color:"#f1f5f9",fontSize:15,fontWeight:600}}>Fire (Kalan Par√ßa) Stok</h3>
            <div style={{overflowX:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse"}}>
                <thead><tr style={{borderBottom:"1px solid rgba(255,255,255,0.08)"}}>
                  <th style={{padding:"10px 12px",textAlign:"left",fontSize:11,color:"#64748b",fontWeight:600}}>KALƒ∞TE</th>
                  <th style={{padding:"10px 12px",textAlign:"left",fontSize:11,color:"#64748b",fontWeight:600}}>√áAP</th>
                  {REMNANT_RANGES.map(r=><th key={r.key} style={{padding:"10px 12px",textAlign:"center",fontSize:10,color:"#64748b",fontWeight:600}}>{r.label}</th>)}
                  <th style={{padding:"10px 12px",textAlign:"center",fontSize:11,color:"#64748b",fontWeight:600}}>TOPLAM</th>
                </tr></thead>
                <tbody>{filtered.filter(s=>Object.values(s.remnants).some(v=>v>0)).sort((a,b)=>a.materialCode.localeCompare(b.materialCode)||a.diameter-b.diameter).map(s=>{
                  const total=Object.values(s.remnants).reduce((a,b)=>a+b,0);
                  return(
                    <tr key={s.id} style={{borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
                      <td style={{padding:"10px 12px",fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{s.materialCode}</td>
                      <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>√ò{s.diameter}mm</td>
                      {REMNANT_RANGES.map(r=>{
                        const v=s.remnants[r.key]||0;
                        return <td key={r.key} style={{padding:"8px 6px",textAlign:"center"}}>
                          {v > 0 ? (
                            <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:4}}>
                              <span style={{fontSize:13,fontWeight:700,color:"#e2e8f0"}}>{v}</span>
                              {hasPerm("stock_edit")&&<>
                                <button onClick={()=>adjustStock(s.id,r.key,-1)} style={{width:18,height:18,borderRadius:4,border:"none",background:"rgba(239,68,68,0.15)",color:"#ef4444",cursor:"pointer",fontSize:11,fontWeight:700}}>-</button>
                                <button onClick={()=>adjustStock(s.id,r.key,1)} style={{width:18,height:18,borderRadius:4,border:"none",background:"rgba(16,185,129,0.15)",color:"#10b981",cursor:"pointer",fontSize:11,fontWeight:700}}>+</button>
                              </>}
                            </div>
                          ) : <span style={{fontSize:12,color:"#334155"}}>‚Äî</span>}
                        </td>;
                      })}
                      <td style={{padding:"10px 12px",textAlign:"center",fontSize:14,fontWeight:700,color:total>0?"#8b5cf6":"#334155"}}>{total}</td>
                    </tr>
                  );
                })}
                {filtered.filter(s=>Object.values(s.remnants).some(v=>v>0)).length===0&&(
                  <tr><td colSpan={REMNANT_RANGES.length+3} style={{textAlign:"center",padding:30,color:"#64748b"}}>Fire stok bulunmuyor</td></tr>
                )}
                </tbody>
              </table>
            </div>
          </Card>
        )}
      </div>
    );
  };

  const MachinesPage = () => {
    const [editM,setEditM]=useState(null);
    const [newM,setNewM]=useState(false);
    const [mName,setMName]=useState("");
    const [mType,setMType]=useState("CNC");
    const startEditM = m => { setEditM(m); setMName(m.name); setMType(m.type); };
    const saveM = () => {
      if(editM) setMachines(p=>p.map(m=>m.id===editM.id?{...m,name:mName,type:mType}:m));
      else { const id="M"+Date.now(); setMachines(p=>[...p,{id,name:mName,type:mType,status:"active"}]); }
      setEditM(null); setNewM(false); setMName(""); setMType("CNC");
    };
    const deleteM = id => { if(productionJobs.some(j=>j.machineId===id&&j.status!=="completed")) return alert("Aktif i≈üi olan makina silinemez!"); setMachines(p=>p.filter(m=>m.id!==id)); };
    return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>Makinalar</h2>
        {hasPerm("admin")&&<Btn icon={Plus} onClick={()=>{setNewM(true);setMName("");setMType("CNC");}}>Yeni Makina</Btn>}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:14}}>
        {machines.map(m=>{const j=productionJobs.filter(x=>x.machineId===m.id&&x.status!=="completed");return(
          <Card key={m.id}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <div style={{display:"flex",alignItems:"center",gap:8}}><Monitor size={18} color="#3b82f6"/><span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{m.name}</span></div>
              <div style={{display:"flex",gap:4,alignItems:"center"}}>
                <Badge color={j.length>0?"#3b82f6":"#10b981"} bg={j.length>0?"rgba(59,130,246,0.15)":"rgba(16,185,129,0.15)"}>{j.length>0?`${j.length} ƒ∞≈ü`:"Bo≈ü"}</Badge>
                {hasPerm("admin")&&<button onClick={()=>startEditM(m)} style={{background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:2}}><Edit size={13}/></button>}
                {hasPerm("admin")&&j.length===0&&<button onClick={()=>deleteM(m.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#ef4444",padding:2}}><Trash2 size={13}/></button>}
              </div>
            </div>
            <div style={{fontSize:12,color:"#64748b",marginBottom:6}}>Tip: {m.type}</div>
            {j.map(job=>{const wo=workOrders.find(w=>w.id===job.woId);const it=wo?.items.find(i=>i.id===job.itemId);return <div key={job.id} style={{padding:7,borderRadius:6,background:"rgba(59,130,246,0.08)",marginBottom:4,fontSize:12,color:"#94a3b8"}}>{it?.productCode||`√ò${it?.diameter}`} ‚Äî {it?.qty}ad ({job.estimatedMinutes}dk)</div>;})}
          </Card>
        );})}
      </div>
      {(editM||newM)&&<Modal title={editM?"Makina D√ºzenle":"Yeni Makina Ekle"} onClose={()=>{setEditM(null);setNewM(false);}} width={400}>
        <Input label="Makina Adƒ±" value={mName} onChange={setMName} placeholder="S20-4"/>
        <div style={{marginTop:12}}><Input label="Tip" value={mType} onChange={setMType} options={[{value:"CNC",label:"CNC"},{value:"Ta≈ülama",label:"Ta≈ülama"},{value:"Lazer",label:"Lazer"},{value:"Kesim",label:"Kesim"},{value:"Diƒüer",label:"Diƒüer"}]}/></div>
        <div style={{marginTop:16,display:"flex",justifyContent:"flex-end"}}><Btn variant="primary" icon={Save} onClick={saveM} disabled={!mName.trim()}>Kaydet</Btn></div>
      </Modal>}
    </div>
  );};

  const OperatorsPage = () => {
    const [editOp,setEditOp]=useState(null);
    const [newOp,setNewOp]=useState(false);
    const [opName,setOpName]=useState("");
    const [opRole,setOpRole]=useState("CNC Operat√∂r");
    const [opShift,setOpShift]=useState("G√ºnd√ºz");
    const startEditOp = op => { setEditOp(op); setOpName(op.name); setOpRole(op.role); setOpShift(op.shift); };
    const saveOp = () => {
      if(editOp) setOperators(p=>p.map(o=>o.id===editOp.id?{...o,name:opName,role:opRole,shift:opShift}:o));
      else { const id="O"+Date.now(); setOperators(p=>[...p,{id,name:opName,role:opRole,shift:opShift}]); }
      setEditOp(null); setNewOp(false); setOpName(""); setOpRole("CNC Operat√∂r"); setOpShift("G√ºnd√ºz");
    };
    const deleteOp = id => { if(productionJobs.some(j=>j.operatorId===id&&j.status!=="completed")) return alert("Aktif i≈üi olan operat√∂r silinemez!"); setOperators(p=>p.filter(o=>o.id!==id)); };
    return(
    <div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
        <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>Operat√∂rler</h2>
        {hasPerm("admin")&&<Btn icon={Plus} onClick={()=>{setNewOp(true);setOpName("");setOpRole("CNC Operat√∂r");setOpShift("G√ºnd√ºz");}}>Yeni Operat√∂r</Btn>}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:14}}>
        {operators.map(op=>{
          const activeJ=productionJobs.filter(x=>x.operatorId===op.id&&x.status!=="completed").length;
          const doneJ=productionJobs.filter(x=>x.operatorId===op.id&&x.status==="completed").length;
          return(
          <Card key={op.id}>
            <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:10}}>
              <div style={{width:36,height:36,borderRadius:9,background:"rgba(59,130,246,0.15)",display:"flex",alignItems:"center",justifyContent:"center",color:"#3b82f6",fontWeight:700,fontSize:15}}>{op.name[0]}</div>
              <div style={{flex:1}}>
                <div style={{fontSize:14,fontWeight:600,color:"#e2e8f0"}}>{op.name}</div>
                <div style={{fontSize:12,color:"#64748b"}}>{op.role} ‚Äî {op.shift}</div>
              </div>
              <div style={{display:"flex",gap:4}}>
                {hasPerm("admin")&&<button onClick={()=>startEditOp(op)} style={{background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:2}}><Edit size={13}/></button>}
                {hasPerm("admin")&&activeJ===0&&<button onClick={()=>deleteOp(op.id)} style={{background:"none",border:"none",cursor:"pointer",color:"#ef4444",padding:2}}><Trash2 size={13}/></button>}
              </div>
            </div>
            <div style={{display:"flex",gap:14,fontSize:12,color:"#94a3b8"}}><span>Aktif: <strong style={{color:"#3b82f6"}}>{activeJ}</strong></span><span>Biten: <strong style={{color:"#10b981"}}>{doneJ}</strong></span></div>
          </Card>
        );})}
      </div>
      {(editOp||newOp)&&<Modal title={editOp?"Operat√∂r D√ºzenle":"Yeni Operat√∂r Ekle"} onClose={()=>{setEditOp(null);setNewOp(false);}} width={400}>
        <Input label="ƒ∞sim" value={opName} onChange={setOpName} placeholder="Ad Soyad"/>
        <div style={{marginTop:12}}><Input label="G√∂rev" value={opRole} onChange={setOpRole} options={[{value:"CNC Operat√∂r",label:"CNC Operat√∂r"},{value:"Ta≈ülamacƒ±",label:"Ta≈ülamacƒ±"},{value:"Kesimci",label:"Kesimci"},{value:"Lazer Operat√∂r",label:"Lazer Operat√∂r"},{value:"Kalite Kontrol",label:"Kalite Kontrol"},{value:"Diƒüer",label:"Diƒüer"}]}/></div>
        <div style={{marginTop:12}}><Input label="Vardiya" value={opShift} onChange={setOpShift} options={[{value:"G√ºnd√ºz",label:"G√ºnd√ºz"},{value:"Gece",label:"Gece"},{value:"Tam G√ºn",label:"Tam G√ºn"}]}/></div>
        <div style={{marginTop:16,display:"flex",justifyContent:"flex-end"}}><Btn variant="primary" icon={Save} onClick={saveOp} disabled={!opName.trim()}>Kaydet</Btn></div>
      </Modal>}
    </div>
  );};

  //  USER MANAGEMENT 
  const UserMgmtPage = () => {
    const [editUser,setEditUser]=useState(null);
    const [editPerms,setEditPerms]=useState([]);
    const [editMode,setEditMode]=useState(null); // "perms" | "user" | "new"
    const [euName,setEuName]=useState("");
    const [euUsername,setEuUsername]=useState("");
    const [euPassword,setEuPassword]=useState("");
    const [euRole,setEuRole]=useState("operator");
    const startEdit = u => { setEditUser(u); setEditPerms(userPerms[u.id] || DEFAULT_ROLES[u.role]?.permissions||[]); setEditMode("perms"); };
    const startEditUser = u => { setEditUser(u); setEuName(u.name); setEuUsername(u.username); setEuPassword(u.password); setEuRole(u.role); setEditMode("user"); };
    const startNewUser = () => { setEditUser(null); setEuName(""); setEuUsername(""); setEuPassword("1234"); setEuRole("operator"); setEditMode("new"); };
    const savePerms = () => { 
      const newPerms = {...userPerms, [editUser.id]: editPerms};
      setUserPerms(newPerms); 
      try { localStorage.setItem("mihenkUserPerms", JSON.stringify(newPerms)); } catch(e){}
      // Update current user's effective permissions if editing self
      if(currentUser?.id===editUser.id) {
        setCurrentUser(p=>({...p})); // trigger re-eval of hasPerm
      }
      setEditMode(null); setEditUser(null); 
    };
    const saveUser = () => {
      if(!euName.trim()||!euUsername.trim()||!euPassword.trim()) return;
      let newUsers;
      if(editMode==="new"){
        const id="U"+Date.now();
        const nu={id,name:euName.trim(),username:euUsername.trim(),password:euPassword,role:euRole,avatar:euName.trim()[0].toUpperCase()};
        newUsers=[...users,nu];
      } else if(editUser) {
        newUsers=users.map(u=>u.id===editUser.id?{...u,name:euName.trim(),username:euUsername.trim(),password:euPassword,role:euRole,avatar:euName.trim()[0].toUpperCase()}:u);
        // Update currentUser if editing self
        if(currentUser?.id===editUser.id) setCurrentUser(p=>({...p,name:euName.trim(),username:euUsername.trim(),password:euPassword,role:euRole,avatar:euName.trim()[0].toUpperCase()}));
      }
      if(newUsers) { setUsers(newUsers); try { localStorage.setItem("mihenkUsers", JSON.stringify(newUsers)); } catch(e){} }
      setEditMode(null); setEditUser(null);
    };
    const deleteUser = uid => {
      if(uid===currentUser?.id) return alert("Kendinizi silemezsiniz!");
      if(!confirm(`Bu kullanƒ±cƒ±yƒ± silmek istediƒüinize emin misiniz?`)) return;
      setUsers(p=>p.filter(u=>u.id!==uid));
      setUserPerms(p=>{const np={...p}; delete np[uid]; return np;});
    };
    return(
      <div>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
          <h2 style={{margin:0,color:"#f1f5f9",fontSize:22,fontWeight:700}}>Kullanƒ±cƒ± Y√∂netimi</h2>
          {hasPerm("admin")&&<Btn icon={Plus} onClick={startNewUser}>Yeni Kullanƒ±cƒ±</Btn>}
        </div>
        <Card>
          <table style={{width:"100%",borderCollapse:"collapse"}}>
            <thead><tr style={{borderBottom:"1px solid rgba(255,255,255,0.08)"}}>{["Kullanƒ±cƒ±","Rol","Kullanƒ±cƒ± Adƒ±","Yetki Sayƒ±sƒ±","ƒ∞≈ülem"].map(h=><th key={h} style={{padding:"10px 12px",textAlign:"left",fontSize:11,color:"#64748b",fontWeight:600,textTransform:"uppercase"}}>{h}</th>)}</tr></thead>
            <tbody>
              {users.map(u=>{
                const actualPerms = userPerms[u.id] || DEFAULT_ROLES[u.role]?.permissions || [];
                const role=DEFAULT_ROLES[u.role];
                return(
                  <tr key={u.id} style={{borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
                    <td style={{padding:"10px 12px"}}><div style={{display:"flex",alignItems:"center",gap:8}}><div style={{width:30,height:30,borderRadius:8,background:"rgba(59,130,246,0.15)",display:"flex",alignItems:"center",justifyContent:"center",color:"#3b82f6",fontWeight:700,fontSize:13}}>{u.avatar}</div><div><div style={{fontSize:13,fontWeight:600,color:"#e2e8f0"}}>{u.name}</div></div></div></td>
                    <td style={{padding:"10px 12px"}}><Badge color="#8b5cf6" bg="rgba(139,92,246,0.15)">{role?.label}</Badge></td>
                    <td style={{padding:"10px 12px",fontSize:12,color:"#94a3b8"}}>{u.username}</td>
                    <td style={{padding:"10px 12px",fontSize:13,color:"#94a3b8"}}>{actualPerms.length}</td>
                    <td style={{padding:"10px 12px"}}>
                      <div style={{display:"flex",gap:4}}>
                        {hasPerm("admin")&&<Btn variant="ghost" size="sm" icon={Edit} onClick={()=>startEditUser(u)}>D√ºzenle</Btn>}
                        <Btn variant="ghost" size="sm" icon={Shield} onClick={()=>startEdit(u)}>Yetkiler</Btn>
                        {hasPerm("admin")&&u.id!==currentUser?.id&&<Btn variant="danger" size="sm" icon={Trash2} onClick={()=>deleteUser(u.id)}/>}
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </Card>

        {editMode==="perms"&&editUser&&(
          <Modal title={`${editUser.name} ‚Äî Yetki D√ºzenleme`} onClose={()=>{setEditMode(null);setEditUser(null);}} width={600}>
            <div style={{marginBottom:14}}><span style={{fontSize:13,color:"#94a3b8"}}>Rol: </span><Badge color="#8b5cf6" bg="rgba(139,92,246,0.15)">{DEFAULT_ROLES[editUser.role]?.label}</Badge></div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(2,1fr)",gap:8}}>
              {Object.entries(PERMISSIONS).map(([key,label])=>(
                <label key={key} style={{display:"flex",alignItems:"center",gap:8,padding:8,borderRadius:8,background:editPerms.includes(key)?"rgba(16,185,129,0.08)":"rgba(255,255,255,0.02)",border:`1px solid ${editPerms.includes(key)?"rgba(16,185,129,0.2)":"rgba(255,255,255,0.06)"}`,cursor:"pointer",fontSize:12,color:"#e2e8f0"}}>
                  <input type="checkbox" checked={editPerms.includes(key)} onChange={e=>{if(e.target.checked) setEditPerms(p=>[...p,key]); else setEditPerms(p=>p.filter(x=>x!==key));}}/>
                  {key==="orders_price"&&<EyeOff size={12} color="#f59e0b"/>}
                  {label}
                </label>
              ))}
            </div>
            <div style={{marginTop:16,display:"flex",justifyContent:"flex-end"}}><Btn variant="primary" icon={Save} onClick={savePerms}>Kaydet</Btn></div>
          </Modal>
        )}

        {(editMode==="user"||editMode==="new")&&(
          <Modal title={editMode==="new"?"Yeni Kullanƒ±cƒ± Ekle":`${editUser?.name} ‚Äî D√ºzenle`} onClose={()=>{setEditMode(null);setEditUser(null);}} width={500}>
            <Input label="Ad Soyad" value={euName} onChange={setEuName} placeholder="Ad Soyad"/>
            <div style={{marginTop:12}}><Input label="Kullanƒ±cƒ± Adƒ±" value={euUsername} onChange={setEuUsername} placeholder="kullanici"/></div>
            <div style={{marginTop:12}}><Input label="≈ûifre" value={euPassword} onChange={setEuPassword} placeholder="****"/></div>
            <div style={{marginTop:12}}><Input label="Rol" value={euRole} onChange={setEuRole} options={Object.entries(DEFAULT_ROLES).map(([k,v])=>({value:k,label:v.label}))}/></div>
            <div style={{marginTop:16,display:"flex",justifyContent:"flex-end"}}><Btn variant="primary" icon={Save} onClick={saveUser} disabled={!euName.trim()||!euUsername.trim()||!euPassword.trim()}>Kaydet</Btn></div>
          </Modal>
        )}
      </div>
    );
  };

  const renderPage = () => {
    switch(page){
      case "dashboard": return <Dashboard/>;
      case "orders": return <OrdersPage/>;
      case "workorders": return <WorkOrdersPage/>;
      case "cutting": return <CuttingPage/>;
      case "grinding": return <GrindingPage/>;
      case "planning": return <PlanningPage/>;
      case "production": return <ProductionPage/>;
      case "qc": return <QCPage/>;
      case "coating": return <CoatingPage/>;
      case "shipping": return <ShippingPage/>;
      case "stock": return <StockPage/>;
      case "purchasing": return <PurchasingPage/>;
      case "machines": return <MachinesPage/>;
      case "operators": return <OperatorsPage/>;
      case "usermgmt": return <UserMgmtPage/>;
      default: return <Dashboard/>;
    }
  };

  return (
    <div style={{display:"flex",height:"100vh",fontFamily:"'DM Sans','Segoe UI',sans-serif",background:"#0f1219",color:"#e2e8f0",overflow:"hidden"}}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap');
        *{box-sizing:border-box;margin:0;}
        ::-webkit-scrollbar{width:6px;height:6px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px;}
        select,input,textarea{font-family:inherit;}
        select option{background:#1a1f2e;color:#e2e8f0;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
      `}</style>
      <Sidebar/>
      <div style={{flex:1,overflow:"auto",padding:24}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24,padding:"10px 16px",borderRadius:12,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)"}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <Search size={16} color="#64748b"/>
            <input type="text" placeholder="Ara..." style={{background:"transparent",border:"none",color:"#e2e8f0",fontSize:13,outline:"none",width:200}}/>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <span style={{fontSize:12,color:"#64748b"}}>{new Date().toLocaleDateString("tr-TR",{weekday:"short",day:"numeric",month:"long"})}</span>
            <div style={{display:"flex",alignItems:"center",gap:6,padding:"4px 10px",borderRadius:8,background:"rgba(59,130,246,0.1)"}}>
              <div style={{width:24,height:24,borderRadius:6,background:"rgba(59,130,246,0.25)",display:"flex",alignItems:"center",justifyContent:"center",color:"#3b82f6",fontWeight:700,fontSize:11}}>{currentUser.avatar}</div>
              <span style={{fontSize:12,fontWeight:600,color:"#e2e8f0"}}>{currentUser.name}</span>
            </div>
            <button onClick={()=>{setCurrentUser(null);localStorage.removeItem("mihenkCurrentUser");}} style={{background:"none",border:"none",cursor:"pointer",color:"#64748b",padding:4,display:"flex",alignItems:"center"}} title="√áƒ±kƒ±≈ü Yap"><LogOut size={16}/></button>
          </div>
        </div>
        {renderPage()}
      </div>

      {/* WORK ORDER DETAIL MODAL ‚Äî accessible from any page */}
      {woDetail&&(()=>{
        const wo=woDetail;
        const order=orders.find(o=>o.id===wo.orderId);
        const allCC=[...COATING_COMPANIES_PRODUCTION,...COATING_COMPANIES_BILEME];
        return(
          <Modal title={`ƒ∞≈ü Emri ‚Äî ${wo.id}`} onClose={()=>setWoDetail(null)} width={900}>
            <div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:14}}>
              <OrderTypeBadge type={wo.orderType}/>
              <PriorityBadge priority={wo.priority}/>
              <Badge color="#6366f1" bg="rgba(99,102,241,0.15)">{wo.customerName}</Badge>
              <Badge color={wo.currentStep==="completed"?"#10b981":"#3b82f6"} bg={wo.currentStep==="completed"?"rgba(16,185,129,0.15)":"rgba(59,130,246,0.15)"}>{wo.currentStep==="completed"?"Tamamlandƒ±":wo.currentStep}</Badge>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:14,marginBottom:16}}>
              <div><span style={{fontSize:11,color:"#64748b"}}>Sipari≈ü No</span><div style={{fontSize:14,color:"#e2e8f0",fontWeight:600}}>{wo.orderId}</div></div>
              <div><span style={{fontSize:11,color:"#64748b"}}>M√º≈üteri</span><div style={{fontSize:14,color:"#e2e8f0",fontWeight:600}}>{wo.customerName}</div></div>
              <div><span style={{fontSize:11,color:"#64748b"}}>Olu≈üturma</span><div style={{fontSize:14,color:"#e2e8f0"}}>{fmtDate(wo.date)}</div></div>
              <div><span style={{fontSize:11,color:"#64748b"}}>Termin</span><div style={{fontSize:14,color:new Date(wo.deliveryDate)<new Date()?"#ef4444":"#e2e8f0",fontWeight:600}}>{fmtDate(wo.deliveryDate)}</div></div>
            </div>
            <WorkflowProgress currentStep={wo.currentStep} orderType={wo.orderType}/>
            <h4 style={{color:"#e2e8f0",margin:"16px 0 10px"}}>Kalemler ({wo.items.length})</h4>
            {wo.items.map(item=>{
              const machine=machines.find(m=>m.id===item.machineId);
              const op=operators.find(o=>o.id===item.operatorId);
              const cc=allCC.find(c=>c.id===item.coatingCompanyId);
              const job=productionJobs.find(j=>j.woId===wo.id&&j.itemId===item.id);
              const elapsed=item.startTime&&item.endTime?Math.floor((new Date(item.endTime)-new Date(item.startTime))/60000):item.startTime?Math.floor((Date.now()-new Date(item.startTime))/60000):0;
              return(
                <div key={item.id} style={{padding:14,borderRadius:10,background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.06)",marginBottom:8}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start"}}>
                    <div>
                      <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
                        <span style={{fontSize:14,fontWeight:700,color:"#e2e8f0"}}>{wo.orderType==="production"?item.productCode:`√ò${item.diameter}mm ‚Äî ${item.islem||""}`}</span>
                        {item.productType&&<span style={{fontSize:11,color:"#6366f1",padding:"1px 6px",borderRadius:4,background:"rgba(99,102,241,0.12)"}}>{item.productType}</span>}
                        {item.toolCode&&<span style={{fontSize:11,color:"#f59e0b",fontWeight:600}}>{item.toolCode}</span>}
                        {(Number(item.rejectQty)||0)>0?(
                          <span style={{fontSize:12}}>
                            <span style={{color:"#10b981",fontWeight:700}}>{item.qty-(Number(item.rejectQty)||0)}</span>
                            <span style={{color:"#64748b"}}>/{item.qty} ad</span>
                            <span style={{color:"#ef4444",fontSize:11,marginLeft:2}}>({item.rejectQty} fire)</span>
                          </span>
                        ):(
                          <span style={{fontSize:12,color:"#64748b"}}>{item.qty} ad</span>
                        )}
                        {item.estimatedMinutes>0&&<Badge color="#3b82f6" bg="rgba(59,130,246,0.12)">‚è± {item.estimatedMinutes}dk</Badge>}
                        <Badge color={
                          item.woStatus==="completed"?"#10b981":
                          item.woStatus==="running"?"#3b82f6":
                          item.woStatus==="cut"?"#f59e0b":
                          ["grinding","grinding_dispatch","grinding_shipped"].includes(item.woStatus)?"#d946ef":
                          item.woStatus==="pending"?"#94a3b8":"#f59e0b"
                        } bg={
                          item.woStatus==="completed"?"rgba(16,185,129,0.15)":
                          item.woStatus==="running"?"rgba(59,130,246,0.15)":
                          item.woStatus==="cut"?"rgba(245,158,11,0.15)":
                          ["grinding","grinding_dispatch","grinding_shipped"].includes(item.woStatus)?"rgba(217,70,239,0.15)":
                          item.woStatus==="pending"?"rgba(148,163,184,0.15)":"rgba(245,158,11,0.15)"
                        }>{item.woStatus==="pending"?"Kesim Bekliyor":item.woStatus==="pending_stock"?"‚è≥ Stok Bekleniyor":item.woStatus==="cut"?"‚úÇÔ∏è Kesildi":item.woStatus==="grinding"?"üîß Ta≈ülamada (ƒ∞√ß)":item.woStatus==="grinding_dispatch"?"üîß Kares Sevk Bekliyor":item.woStatus==="grinding_shipped"?"üì¶ Kares'te":item.woStatus}</Badge>
                      </div>
                      {canPrice&&item.unitPrice>0&&<div style={{fontSize:12,color:"#10b981",marginTop:4}}>{fmtMoney(item.unitPrice,wo.currency)}/ad ‚Üí {fmtMoney(item.qty*item.unitPrice,wo.currency)}</div>}
                    </div>
                  </div>
                  <div style={{display:"flex",gap:6,marginTop:10,flexWrap:"wrap",alignItems:"center"}}>
                    {wo.orderType==="production"&&item.materialCode&&(()=>{const mc=MATERIAL_CODES.find(m=>m.value===item.materialCode);return mc?<Badge color={mc.color||"#94a3b8"} bg={`${mc.color||"#94a3b8"}22`}><span style={{display:"inline-block",width:8,height:8,borderRadius:2,background:mc.color,marginRight:4}}></span>{mc.value}</Badge>:<Badge color="#94a3b8" bg="rgba(148,163,184,0.1)">{item.materialCode}</Badge>;})()}
                    {item.coatingType&&<Badge color="#14b8a6" bg="rgba(20,184,166,0.15)">{item.coatingType}</Badge>}
                    {cc&&<span style={{fontSize:11,color:"#94a3b8"}}>‚Üí {cc.name}</span>}
                    {item.grinding&&<Badge color="#a855f7" bg="rgba(168,85,247,0.15)">{item.grindingType||"Ta≈ülama"}</Badge>}
                  </div>
                  <div style={{display:"flex",gap:8,marginTop:8,flexWrap:"wrap",alignItems:"center"}}>
                    {machine&&<span style={{fontSize:12,color:"#3b82f6"}}>üñ• {machine.name}</span>}
                    {op&&<span style={{fontSize:12,color:"#10b981"}}>üë§ {op.name}</span>}
                    {elapsed>0&&<span style={{fontSize:12,color:"#f59e0b"}}>‚è± Ge√ßen: {elapsed}dk</span>}
                    {Object.values(item.qcChecks||{}).some(Boolean)&&<span style={{fontSize:12,color:Object.values(item.qcChecks).every(Boolean)?"#10b981":"#f59e0b"}}>KK: {Object.values(item.qcChecks).filter(Boolean).length}/4</span>}
                    {item.laserDone&&<Badge color="#a855f7" bg="rgba(168,85,247,0.12)">Lazer ‚úì</Badge>}
                    {item.coatingSent&&<Badge color="#14b8a6" bg="rgba(20,184,166,0.12)">{item.coatingReceived?"Kaplama ‚úì":"Kaplamada"}</Badge>}
                  </div>
                  <div style={{marginTop:6}}><PdfChips pdfs={item.pdfs||[]} canEdit={hasPerm("workorders_edit")} onUpload={f=>addPdfToWoItem(wo.id,item.id,f,item.woStatus==="qc"?"Kalite Kontrol":item.woStatus==="running"||item.woStatus==="assigned"?"√úretim":item.woStatus==="coating_ready"||item.woStatus==="laser"?"Kaplama":item.woStatus==="shipping"?"Sevkiyat":"ƒ∞≈ü Emri")}/></div>
                </div>
              );
            })}
            {order?.notes&&<div style={{marginTop:12,padding:10,borderRadius:8,background:"rgba(255,255,255,0.03)",fontSize:13,color:"#94a3b8"}}>üìù {order.notes}</div>}
            {hasPerm("workorders_edit")&&<div style={{marginTop:12,paddingTop:12,borderTop:"1px solid rgba(255,255,255,0.06)",display:"flex",justifyContent:"flex-end"}}><Btn variant="danger" size="sm" icon={Trash2} onClick={()=>setConfirmDel({type:"wo",id:wo.id,label:wo.id+" ‚Äî "+wo.customerName})}>ƒ∞≈ü Emrini Sil</Btn></div>}
          </Modal>
        );
      })()}

      {/* RESCHEDULE MODAL */}
      {rescheduleModal&&(
        <Modal title="‚è∞ ƒ∞≈ü Zamanla / Yeniden Planla" onClose={()=>setRescheduleModal(null)} width={550}>
          <RescheduleForm job={rescheduleModal} machines={machines} onSave={rescheduleJob} onClear={()=>clearManualSchedule(rescheduleModal.id)}/>
        </Modal>
      )}

      {/* DELETE CONFIRMATION */}
      {confirmDel&&(
        <Modal title="‚ö†Ô∏è Silme Onayƒ±" onClose={()=>setConfirmDel(null)} width={480}>
          <div style={{textAlign:"center",padding:"10px 0 20px"}}>
            <div style={{fontSize:40,marginBottom:12}}>üóëÔ∏è</div>
            <div style={{fontSize:15,color:"#e2e8f0",marginBottom:6,fontWeight:600}}>
              {confirmDel.type==="order"?"Sipari≈ü":"ƒ∞≈ü Emri"} silinecek
            </div>
            <div style={{fontSize:14,color:"#f59e0b",fontWeight:700,marginBottom:8}}>{confirmDel.label}</div>
            {confirmDel.type==="order"&&(()=>{
              const relWOs=workOrders.filter(w=>w.orderId===confirmDel.id);
              const relJobs=productionJobs.filter(j=>relWOs.some(w=>w.id===j.woId));
              return relWOs.length>0?(
                <div style={{fontSize:12,color:"#ef4444",marginBottom:8,padding:8,borderRadius:6,background:"rgba(239,68,68,0.08)"}}>
                  ‚ö†Ô∏è Bu sipari≈üe baƒülƒ± <strong>{relWOs.length}</strong> i≈ü emri ve <strong>{relJobs.length}</strong> √ºretim i≈üi de silinecek!
                </div>
              ):null;
            })()}
            <div style={{fontSize:13,color:"#94a3b8",marginBottom:16}}>Bu i≈ülem geri alƒ±namaz.</div>
            <div style={{display:"flex",gap:10,justifyContent:"center"}}>
              <Btn variant="ghost" onClick={()=>setConfirmDel(null)}>ƒ∞ptal</Btn>
              <Btn variant="danger" icon={Trash2} onClick={()=>{
                if(confirmDel.type==="order") deleteOrder(confirmDel.id);
                else deleteWorkOrder(confirmDel.id);
              }}>Evet, Sil</Btn>
            </div>
          </div>
        </Modal>
      )}

      {/* PDF VIEWER */}
      {pdfViewer&&(
        <Modal title={`üìé ${pdfViewer.name}`} onClose={()=>setPdfViewer(null)} width={900}>
          {pdfViewer.data?(()=>{
            const openPdf=()=>{
              try{
                const byteString=atob(pdfViewer.data.split(",")[1]);
                const mimeString=pdfViewer.data.split(",")[0].split(":")[1].split(";")[0];
                const ab=new ArrayBuffer(byteString.length);
                const ia=new Uint8Array(ab);
                for(let i=0;i<byteString.length;i++) ia[i]=byteString.charCodeAt(i);
                const blob=new Blob([ab],{type:mimeString});
                const url=URL.createObjectURL(blob);
                window.open(url,"_blank");
                setTimeout(()=>URL.revokeObjectURL(url),10000);
              }catch(e){
                window.open(pdfViewer.data,"_blank");
              }
            };
            const downloadPdf=()=>{
              try{
                const a=document.createElement("a");
                a.href=pdfViewer.data;
                a.download=pdfViewer.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              }catch(e){}
            };
            return(
              <div>
                <div style={{display:"flex",gap:10,marginBottom:16}}>
                  <Btn variant="primary" icon={Eye} onClick={openPdf}>Yeni Sekmede A√ß</Btn>
                  <Btn variant="ghost" icon={Download} onClick={downloadPdf}>ƒ∞ndir</Btn>
                </div>
                <div style={{width:"100%",height:"70vh",borderRadius:8,overflow:"hidden",background:"#fff",position:"relative"}}>
                  <iframe src={pdfViewer.data} style={{width:"100%",height:"100%",border:"none"}} title={pdfViewer.name}/>
                  <div style={{position:"absolute",bottom:10,left:0,right:0,textAlign:"center"}}>
                    <span style={{padding:"6px 14px",borderRadius:8,background:"rgba(0,0,0,0.7)",color:"#fff",fontSize:12}}>PDF g√∂r√ºnm√ºyorsa "Yeni Sekmede A√ß" butonunu kullanƒ±n</span>
                  </div>
                </div>
              </div>
            );
          })():<div style={{textAlign:"center",padding:40,color:"#64748b"}}><File size={40} style={{marginBottom:12}}/><div>PDF verisi bulunamadƒ±.</div></div>}
        </Modal>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>
